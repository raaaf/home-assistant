light_toggle_with_settings:
  alias: Licht umschalten mit Einstellungen
  description: Schaltet Licht ein/aus mit konfigurierbaren Helligkeit und Farbtemperatur
  icon: mdi:lightbulb
  mode: single
  fields:
    entity:
      description: Entity ID des Lichts
      example: light.wohnzimmer
      required: true
      selector:
        entity:
          domain: light
    brightness_pct:
      description: Helligkeit in Prozent (1-100)
      example: 80
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: '%'
    color_temp:
      description: Farbtemperatur in Mired
      example: 350
      selector:
        number:
          min: 153
          max: 500
          unit_of_measurement: mired
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ states(entity) == ''off'' }}'
      sequence:
      - action: light.turn_on
        target:
          entity_id: '{{ entity }}'
        data:
          brightness_pct: '{{ brightness_pct | int(100) }}'
          transition: 0.1
      - delay:
          milliseconds: 100
      - if:
        - condition: template
          value_template: '{{ color_temp is defined }}'
        then:
        - action: light.turn_on
          target:
            entity_id: '{{ entity }}'
          data:
            color_temp: '{{ color_temp | int }}'
            transition: 0.1
    default:
    - action: light.turn_off
      target:
        entity_id: '{{ entity }}'
brightness_increase:
  alias: Helligkeit erhöhen
  description: Erhöht die Helligkeit aller eingeschalteten Lichter um 25
  icon: mdi:brightness-6
  mode: single
  fields:
    entity_ids:
      description: Liste der Licht-Entitäten
      example: light.wohnzimmer,light.kuche
      required: true
      selector:
        entity:
          domain: light
          multiple: true
  sequence:
  - variables:
      entities_on: "{{ expand(entity_ids) \n   | selectattr('state', 'eq', 'on') \n
        \  | map(attribute='entity_id') \n   | list }}\n"
      new_brightness: "{% if entities_on | count > 0 %}\n  {{ (state_attr(entities_on
        | first, 'brightness') | int(0) + 64) | min(255) }}\n{% else %}\n  128\n{%
        endif %}\n"
  - condition: template
    value_template: '{{ entities_on | count > 0 }}'
  - action: light.turn_on
    target:
      entity_id: '{{ entities_on }}'
    data:
      brightness: '{{ new_brightness }}'
brightness_decrease:
  alias: Helligkeit verringern
  description: Verringert die Helligkeit aller eingeschalteten Lichter um 25
  icon: mdi:brightness-4
  mode: single
  fields:
    entity_ids:
      description: Liste der Licht-Entitäten
      example: light.wohnzimmer,light.kuche
      required: true
      selector:
        entity:
          domain: light
          multiple: true
  sequence:
  - variables:
      entities_on: "{{ expand(entity_ids) \n   | selectattr('state', 'eq', 'on') \n
        \  | map(attribute='entity_id') \n   | list }}\n"
      new_brightness: "{% if entities_on | count > 0 %}\n  {{ (state_attr(entities_on
        | first, 'brightness') | int(255) - 64) | max(1) }}\n{% else %}\n  64\n{%
        endif %}\n"
  - condition: template
    value_template: '{{ entities_on | count > 0 }}'
  - action: light.turn_on
    target:
      entity_id: '{{ entities_on }}'
    data:
      brightness: '{{ new_brightness }}'
robbi_go_to_kitchen:
  alias: Robbi in die Küche
  description: Sendet Robbi zur Küchenreinigung mit leisem Modus
  icon: mdi:robot-vacuum
  mode: single
  sequence:
  - condition: template
    value_template: '{{ states(''vacuum.robbi_2'') not in [''unknown'', ''unavailable'']
      }}'
  - action: vacuum.set_fan_speed
    target:
      entity_id: vacuum.robbi_2
    data:
      fan_speed: Silent
  - action: vacuum.send_command
    target:
      entity_id: vacuum.robbi_2
    data:
      command: app_goto_target
      params:
      - 31279
      - 24178
tts_random_greeting:
  alias: Zufällige Begrüßung (Benachrichtigung)
  description: Sendet eine zufällige Begrüßung als Mobile- und Persistente-Benachrichtigung
  icon: mdi:account-voice
  mode: single
  fields:
    speaker:
      description: (deaktiviert) ehemals Ziel-Lautsprecher
      example: media_player.homepod_wohnzimmer_balkon
      default: media_player.homepod_wohnzimmer_balkon
      required: false
      selector:
        entity:
          domain: media_player
  sequence:
  - variables:
      greeting: "{{ [\n    \"Hallo Hand\",\n    \"Hallo Maus\",\n    \"Hallo Hase\",\n
        \   \"Willkommen zu Hause\",\n    \"Schön dass du da bist\"\n  ] | random
        }}"
  - parallel:
    - action: notify.rafael
      data:
        title: "\U0001F44B Begrüßung"
        message: '{{ greeting }}'
    - action: notify.alex
      data:
        title: "\U0001F44B Begrüßung"
        message: '{{ greeting }}'
  - action: persistent_notification.create
    data:
      title: "\U0001F44B Begrüßung"
      message: '{{ greeting }}'
notification_with_icon:
  alias: Benachrichtigung mit Icon
  description: Sendet formatierte Benachrichtigung an Gerät
  icon: mdi:message-alert
  mode: parallel
  max: 10
  fields:
    title:
      description: Titel der Benachrichtigung
      example: Smart Home Alert
      required: true
    message:
      description: Nachrichtentext
      example: Fenster ist offen
      required: true
    icon:
      description: Icon für die Benachrichtigung
      example: mdi:window-open
      default: mdi:information
    icon_color:
      description: Icon-Farbe als RGB-Array
      example: '[255, 0, 0]'
      default: '[0, 123, 255]'
    timeout_seconds:
      description: Timeout in Sekunden
      example: 30
      default: 10
      selector:
        number:
          min: 5
          max: 300
          unit_of_measurement: s
  sequence:
  - action: notify.mobile_app_alex_iphone
    data:
      title: '{{ title }}'
      message: '{{ message }}'
      data:
        notification_icon: '{{ icon }}'
        color: '{{ icon_color | default([0, 123, 255]) }}'
        timeout: '{{ timeout_seconds | int(10) }}'
        tag: smart_home_notification
fade_volume:
  alias: Fade Volume
  mode: restart
  fields:
    target_player:
      name: Target media player
      description: Target media player of volume fade.
      required: true
      example: media_player.wohnzimmer_homepod
      selector:
        entity:
          domain: media_player
    target_volume:
      name: Target volume
      description: Volume the media play will be at the end of the fade duration.
      required: true
      default: 0.5
      example: '0.5'
      selector:
        number:
          max: 1
          min: 0
          step: 0.01
          mode: slider
    duration:
      name: Fade duration
      description: Length of time in seconds the fade should take.
      required: true
      default: 5
      example: '5'
      selector:
        number:
          mode: box
          min: 0
          max: 100000
          unit_of_measurement: s
    curve:
      name: Fade curve algorithm
      description: Shape of the fade curve to apply.
      required: true
      default: logarithmic
      example: logarithmic
      selector:
        select:
          options:
          - logarithmic
          - bezier
          - linear
  variables:
    steps_per_second: 2
    total_steps: '{{ (steps_per_second * duration) | int(0) }}'
    start_volume: "{% set current = state_attr(target_player, 'volume_level') | float(0)
      %} {% if current < 0.01 %}\n  0\n{% else %}\n  {{ current }}\n{% endif %}\n"
    volume_diff: '{{ (target_volume - start_volume) | float(0) }}'
  sequence:
  - if:
    - condition: template
      value_template: '{{ start_volume < 0.01 and volume_diff > 0 }}'
    then:
    - action: media_player.volume_set
      continue_on_error: true
      data:
        entity_id: '{{ target_player }}'
        volume_level: 0
    - delay: '00:00:00.5'
  - repeat:
      while:
      - condition: template
        value_template: '{{ repeat.index <= total_steps }}'
      - condition: template
        value_template: '{{ has_value(target_player) and state_attr(target_player, ''volume_level'') is not none }}'
      - condition: template
        value_template: '{{ ((state_attr(target_player, ''volume_level'') | float(0)
          - target_volume) | abs) > 0.001 }}'
      sequence:
      - action: media_player.volume_set
        continue_on_error: true
        data:
          entity_id: '{{ target_player }}'
          volume_level: "{% set progress = repeat.index / total_steps %} {% set current_start
            = state_attr(target_player, 'volume_level') | float(0) %}\n{# Sicherheit:
            Nie über Ziel hinaus #} {% if progress >= 1 %}\n  {{ target_volume }}\n{%
            else %}\n  {% if curve == 'logarithmic' %}\n    {# Verbesserte logarithmische
            Kurve - startet bei 0 #}\n    {% set log_value = (progress * progress
            * progress) %}\n    {{ (start_volume + log_value * volume_diff) | float(0)
            | round(3) }}\n  {% elif curve == 'bezier' %}\n    {# Smooth S-Kurve #}\n
            \   {% set bezier_value = progress * progress * (3 - 2 * progress) %}\n
            \   {{ (start_volume + bezier_value * volume_diff) | float(0) | round(3)
            }}\n  {% else %}\n    {# Linear #}\n    {{ (start_volume + progress *
            volume_diff) | float(0) | round(3) }}\n  {% endif %}\n{% endif %}"
      - delay:
          milliseconds: '{{ (1000 / steps_per_second) | int }}'
  - action: media_player.volume_set
    continue_on_error: true
    data:
      entity_id: '{{ target_player }}'
      volume_level: '{{ target_volume }}'
  - action: system_log.write
    data:
      message: 'Fade completed: {{ target_player }}  from {{ start_volume }} to {{
        target_volume }}  in {{ duration }}s using {{ curve }} curve

        '
      level: debug
  icon: mdi:tune-vertical
  description: Smooth volume fading with multiple curve options
test_debug:
  alias: Debug Test
  sequence:
  - action: system_log.write
    data:
      message: Debug Test Script Executed
      level: warning
light_sunrise:
  alias: Light Sunrise
  use_blueprint:
    path: steku/parabolic_alarm_script.yaml
  description: ''
scene_enable_adaptive_lighting:
  alias: 'Szene » Adaptive Beleuchtung aktivieren'
  description: Aktiviert adaptive Beleuchtung für einen Raum mit Konflikt-Prüfung
  icon: mdi:lightbulb-auto
  mode: parallel
  max: 10
  fields:
    room:
      description: Raumname (arbeitszimmer, wohnzimmer, schlafzimmer, etc.)
      example: wohnzimmer
      required: true
      selector:
        text:
    exclude_scenes:
      description: Liste der Szenen, die NICHT aktiv sein dürfen (optional)
      example: "movie,party,cooking"
      required: false
      default: ""
      selector:
        text:
  sequence:
  - variables:
      switch_entity: "switch.adaptive_lighting_{{ room }}"
      scenes_to_check: "{{ exclude_scenes.split(',') if exclude_scenes else [] }}"
  - alias: Prüfe ob Switch existiert
    if:
    - condition: template
      value_template: "{{ has_value(switch_entity) }}"
    then: []
    else:
    - action: system_log.write
      data:
        message: "⚠️ Adaptive lighting switch {{ switch_entity }} does not exist for room {{ room }}"
        level: warning
    - stop: "Switch entity does not exist"
  - alias: Prüfe Szenen-Konflikte
    if:
    - condition: template
      value_template: >
        {% set conflicts = namespace(found=false) %}
        {% for scene in scenes_to_check %}
          {% set scene_entity = 'input_boolean.' ~ scene.strip() %}
          {% if has_value(scene_entity) and is_state(scene_entity, 'on') %}
            {% set conflicts.found = true %}
          {% endif %}
        {% endfor %}
        {{ not conflicts.found }}
    then:
    - action: switch.turn_on
      target:
        entity_id: "{{ switch_entity }}"
    - action: logbook.log
      data:
        name: "Adaptive Beleuchtung"
        message: "Adaptive Beleuchtung {{ room }} aktiviert"
        domain: script
scene_disable_adaptive_lighting:
  alias: 'Szene » Adaptive Beleuchtung deaktivieren'
  description: Deaktiviert adaptive Beleuchtung für einen Raum
  icon: mdi:lightbulb-off
  mode: parallel
  max: 10
  fields:
    room:
      description: Raumname (arbeitszimmer, wohnzimmer, schlafzimmer, etc.)
      example: wohnzimmer
      required: true
      selector:
        text:
  sequence:
  - variables:
      switch_entity: "switch.adaptive_lighting_{{ room }}"
  - alias: Prüfe ob Switch existiert
    if:
    - condition: template
      value_template: "{{ has_value(switch_entity) }}"
    then:
    - action: switch.turn_off
      target:
        entity_id: "{{ switch_entity }}"
    else:
    - action: system_log.write
      data:
        message: "⚠️ Adaptive lighting switch {{ switch_entity }} does not exist for room {{ room }}"
        level: warning
    - stop: "Switch entity does not exist"
scene_enable_motion_automations:
  alias: 'Szene » Motion-Automationen aktivieren'
  description: Aktiviert Motion-Automationen für einen Raum mit Konflikt-Prüfung
  icon: mdi:motion-sensor
  mode: parallel
  max: 10
  fields:
    automations:
      description: Liste der Automation-Entity-IDs (komma-getrennt)
      example: "automation.motion_wohnzimmer,automation.motion_esstisch"
      required: true
      selector:
        text:
    exclude_scenes:
      description: Liste der Szenen, die NICHT aktiv sein dürfen (optional)
      example: "movie,party,cooking"
      required: false
      default: ""
      selector:
        text:
  sequence:
  - variables:
      automation_list: "{{ automations.split(',') }}"
      scenes_to_check: "{{ exclude_scenes.split(',') if exclude_scenes else [] }}"
  - alias: Prüfe Szenen-Konflikte
    if:
    - condition: template
      value_template: >
        {% set conflicts = namespace(found=false) %}
        {% for scene in scenes_to_check %}
          {% set scene_entity = 'input_boolean.' ~ scene.strip() %}
          {% if has_value(scene_entity) and is_state(scene_entity, 'on') %}
            {% set conflicts.found = true %}
          {% endif %}
        {% endfor %}
        {{ not conflicts.found }}
    then:
    - repeat:
        for_each: "{{ automation_list }}"
        sequence:
        - alias: Aktiviere Automation wenn sie existiert
          if:
          - condition: template
            value_template: "{{ has_value(repeat.item.strip()) }}"
          then:
          - action: automation.turn_on
            target:
              entity_id: "{{ repeat.item.strip() }}"
          else:
          - action: system_log.write
            data:
              message: "⚠️ Motion automation {{ repeat.item.strip() }} does not exist"
              level: warning
    - action: logbook.log
      data:
        name: "Motion Automationen"
        message: "Motion-Automationen aktiviert: {{ automations }}"
        domain: script
scene_disable_motion_automations:
  alias: 'Szene » Motion-Automationen deaktivieren'
  description: Deaktiviert Motion-Automationen für einen Raum
  icon: mdi:motion-sensor-off
  mode: parallel
  max: 10
  fields:
    automations:
      description: Liste der Automation-Entity-IDs (komma-getrennt)
      example: "automation.motion_wohnzimmer,automation.motion_esstisch"
      required: true
      selector:
        text:
  sequence:
  - variables:
      automation_list: "{{ automations.split(',') }}"
  - repeat:
      for_each: "{{ automation_list }}"
      sequence:
      - alias: Deaktiviere Automation wenn sie existiert
        if:
        - condition: template
          value_template: "{{ has_value(repeat.item.strip()) }}"
        then:
        - action: automation.turn_off
          target:
            entity_id: "{{ repeat.item.strip() }}"
          data:
            stop_actions: true
        else:
        - action: system_log.write
          data:
            message: "⚠️ Motion automation {{ repeat.item.strip() }} does not exist"
            level: warning
scene_check_conflicts:
  alias: 'Szene » Konflikt-Prüfung'
  description: Prüft ob eine bestimmte Szene ohne Konflikte aktiviert werden kann
  icon: mdi:check-circle
  mode: single
  fields:
    scene_name:
      description: Name der Szene die geprüft werden soll
      example: movie
      required: true
      selector:
        text:
    conflicting_scenes:
      description: Komma-getrennte Liste der konfliktierenden Szenen
      example: "party,cooking,baden,sauna"
      required: true
      selector:
        text:
  sequence:
  - variables:
      scene_entity: "input_boolean.{{ scene_name }}"
      conflicts_list: "{{ conflicting_scenes.split(',') }}"
      has_conflict: >
        {% set conflicts = namespace(found=false) %}
        {% for scene in conflicts_list %}
          {% set conflict_entity = 'input_boolean.' ~ scene.strip() %}
          {% if has_value(conflict_entity) and is_state(conflict_entity, 'on') %}
            {% set conflicts.found = true %}
          {% endif %}
        {% endfor %}
        {{ conflicts.found }}
  - alias: Prüfe ob Scene-Entity existiert
    if:
    - condition: template
      value_template: "{{ not has_value(scene_entity) }}"
    then:
    - action: system_log.write
      data:
        message: "⚠️ Scene entity {{ scene_entity }} does not exist"
        level: warning
    - stop: "Scene entity does not exist"
  - if:
    - condition: template
      value_template: "{{ has_conflict }}"
    then:
    - action: logbook.log
      data:
        name: "Szenen-Konflikt"
        message: "Konflikt erkannt für {{ scene_name }}: eine andere Szene ist aktiv"
        domain: script
    - stop: "Konflikt mit anderer Szene"
  - action: logbook.log
    data:
      name: "Szenen-Konflikt-Prüfung"
      message: "Keine Konflikte für {{ scene_name }}"
      domain: script

reload_media_players:
  alias: Reload Media Players
  description: Aktualisiert den Status aller Media Player
  icon: mdi:refresh
  mode: single
  sequence:
    - action: homeassistant.update_entity
      target:
        entity_id:
          - media_player.appletv
          - media_player.wohnzimmer
          - media_player.denon_avr_x3200w
          - media_player.homepod_arbeitszimmer
          - media_player.homepod_badezimmer
          - media_player.homepod_kinderzimmer
          - media_player.homepod_kuche
          - media_player.homepod_schlafzimmer
          - media_player.homepod_wohnzimmer

heizung_boost:
  alias: Heizung Boost
  description: Toggle für manuellen 1,5h Heizungsboost
  icon: mdi:radiator
  mode: single
  sequence:
    - if:
        - condition: state
          entity_id: timer.heizung_boost
          state: active
      then:
        - action: timer.cancel
          target:
            entity_id: timer.heizung_boost
        - action: switch.turn_off
          target:
            entity_id:
              - switch.heizung_kinderzimmer
              - switch.heizung_schlafzimmer
              - switch.heizung_wohnzimmer
        - action: logbook.log
          data:
            name: Heizung Boost
            message: "Boost manuell gestoppt"
            domain: climate
      else:
        - action: switch.turn_on
          target:
            entity_id:
              - switch.heizung_kinderzimmer
              - switch.heizung_schlafzimmer
              - switch.heizung_wohnzimmer
        - action: timer.start
          target:
            entity_id: timer.heizung_boost
        - action: logbook.log
          data:
            name: Heizung Boost
            message: "1,5h Boost gestartet"
            domain: climate
