# ============================================================================
# HOME ASSISTANT CORE CONFIGURATION
# ============================================================================

# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

homeassistant:
  # Multi-Factor Authentication
  auth_mfa_modules:
    - type: totp

  # External URL for secure access
  external_url: "https://ha.rafaelalex.de"

  # Authentication providers
  auth_providers:
    - type: trusted_networks
      trusted_networks:
        - 192.168.178.0/24
        - 127.0.0.1
        - ::1
      allow_bypass_login: false
    - type: homeassistant

# ============================================================================
# NETWORK & SECURITY
# ============================================================================

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.30.33.0/24
    - 127.0.0.1
    - 192.168.178.72
    - 192.168.188.118
    - ::1
  ip_ban_enabled: false
  login_attempts_threshold: 5
  # SSL certificates (uncomment when using)
  # ssl_certificate: /ssl/fullchain.pem
  # ssl_key: /ssl/privkey.pem

# ============================================================================
# LOGGING & MONITORING
# ============================================================================

logger:
  default: error
  logs:
    homeassistant.components: warning
    homeassistant.components.http: error
    homeassistant.components.automation: info
    homeassistant.components.script: info
    homeassistant.components.template: warning
    homeassistant.components.mqtt: warning
    homeassistant.components.recorder: warning
    homeassistant.components.powercalc: info
    # Suppress noisy device connectivity errors
    homeassistant.components.media_player: error  # Suppress Denon AVR slow update warnings
    homeassistant.components.shelly: critical  # Suppress Shelly connection errors (show only critical)
    homeassistant.components.tplink: critical  # Suppress TP-Link timeout errors (show only critical)
    homeassistant.helpers.service: critical  # Suppress vacuum coroutine warnings
    # Suppress powercalc startup errors (lights off = no brightness)
    custom_components.powercalc.strategy.lut: critical

# Database optimization
recorder:
  purge_keep_days: 14
  auto_purge: true
  commit_interval: 30
  exclude:
    domains:
      - automation
      - updater
      - device_tracker
      - persistent_notification
      - script
      - media_player
    entities:
      - sensor.system_monitor_last_boot
      - sensor.date
      - sensor.date_time_iso
      - sensor.roborock_a27_737e_status  # Excluded due to state list too long (>255 chars)
      # Exclude specific problematic energy sensors that cause utility meter errors
      - sensor.homepod_arbeitszimmer_energy
      - sensor.kamera_schlafzimmer_energy
    entity_globs:
      - sensor.*_battery_level
      - sensor.*_rssi
      - sensor.*_linkquality
      - sensor.*_power
      - sensor.*_current_consumption
      - sensor.*_voltage
      - sensor.*_current
      - sensor.roborock_*
      # Exclude specific problematic utility meter sensors
      - sensor.homepod_*_energy_*
      - sensor.kamera_*_energy_*
  include:
    entities:
      # Dashboard power sensors - explicitly included for history tracking
      # Solar panels
      - sensor.inverter_port_1_dc_power  # Panel 1
      - sensor.inverter_port_2_dc_power  # Panel 2
      # Grid phases
      - sensor.strommesser_phase_a_active_power  # Phase 1
      - sensor.strommesser_phase_b_active_power  # Phase 2
      - sensor.strommesser_phase_c_active_power  # Phase 3
      # Individual device power sensors
      - sensor.steckdose_bkk_power  # BKK
      - sensor.alex_steckdose_device_power  # Alex
      - sensor.arbeitszimmer_steckdose_power  # Rafael (office)
      - sensor.trockner_current_consumption  # Trockner (dryer)
      - sensor.wohnzimmer_steckdose_power  # Wohnzimmer (living room)
      - sensor.steckdose_kuechengeraete_power  # Küchengeräte (kitchen appliances)
      - sensor.steckdose_waschmaschine_power  # Waschmaschine (washing machine)
      - sensor.steckdose_kinderzimmer_power  # Kinderzimmer (kids room)
      # Aggregate power sensors
      - sensor.alle_always_on_power  # Alle Always-On
      - sensor.alle_speaker_power  # Alle Speaker
      - sensor.alle_variablen_power  # Alle Variablen

# History configuration - filtering handled by recorder configuration

# ============================================================================
# COMMUNICATION & NOTIFICATIONS
# ============================================================================

mobile_app:
cloud:

# Notifications
notify: !include notifies.yaml

# Telegram (disabled)
# telegram_bot:
#   - platform: polling
#     api_key: !secret telegram_api_key
#     allowed_chat_ids:
#       - 6310607652

# ============================================================================
# USER INTERFACE
# ============================================================================

frontend:
  themes: !include_dir_merge_named themes

# ============================================================================
# EXTERNAL INTEGRATIONS
# ============================================================================

# Waste Collection Schedule
waste_collection_schedule:
  sources:
    - name: abfallwirtschaft_fuerth_eu
      args:
        id: 102471001
      customize:
        - type: Restabfall
          alias: Restmuell
          icon: mdi:trash-can
        - type: Bioabfall
          alias: Bioabfall
          icon: mdi:recycle
        - type: Altpapier
          alias: Papier
          icon: mdi:newspaper
        - type: "Gelber Sack"
          alias: GelberSack
          icon: mdi:recycle-variant
  fetch_time: "04:00"
  day_switch_time: "10:00"

# Adaptive Lighting
adaptive_lighting: !include adaptive_lighting.yaml

# Power Calculation
powercalc:
  discovery:
    enabled: true
    exclude_device_types:
      - power_meter    # exclude devices that already measure power (Shelly, smart plugs)
  create_utility_meters: true
  utility_meter_types:
    - daily
    - weekly
    - monthly
  power_sensor_naming: "{} Power"
  power_sensor_friendly_naming: "{} Power"
  energy_sensor_naming: "{} Energy"
  energy_sensor_friendly_naming: "{} Energy"
  energy_sensor_precision: 2
  power_sensor_precision: 2
  # Throttle group sensors to reduce database writes
  group_power_update_interval: 5      # default: 2 seconds
  group_energy_update_interval: 120   # default: 60 seconds
  # Handle edge cases and errors gracefully
  disable_extended_attributes: true
  ignore_unavailable_state: true

# ============================================================================
# TEMPLATE SENSORS
# ============================================================================

template:
  # Vacuum/Robot sensors
  - sensor:
      - name: "Xiaomi Vacuum Charging State"
        unique_id: xiaomi_vacuum_charging_state
        icon: "mdi:battery-charging-medium"
        state: >
          {% if states('vacuum.robbi_2') == 'docked' %}
            {% if state_attr('vacuum.robbi_2', 'battery_level') | int(0) < 100 %}
              charging
            {% else %}
              docked
            {% endif %}
          {% elif states('vacuum.robbi_2') == 'cleaning' %}
            cleaning
          {% elif states('vacuum.robbi_2') == 'returning' %}
            returning
          {% else %}
            idle
          {% endif %}

      - name: "Roborock Status Simplified"
        unique_id: roborock_status_simplified
        icon: "mdi:robot-vacuum"
        state: >
          {% set vacuum_state = states('vacuum.robbi_2') %}
          {% if vacuum_state == 'docked' %}
            docked
          {% elif vacuum_state == 'cleaning' %}
            cleaning
          {% elif vacuum_state == 'returning' %}
            returning
          {% elif vacuum_state == 'paused' %}
            paused
          {% elif vacuum_state == 'error' %}
            error
          {% elif vacuum_state == 'idle' %}
            idle
          {% elif vacuum_state in ['unknown', 'unavailable'] %}
            unavailable
          {% else %}
            {{ vacuum_state }}
          {% endif %}
        availability: >
          {{ states('vacuum.robbi_2') not in ['unknown', 'unavailable'] }}
      - name: "Roborock A27 Status Fixed"
        unique_id: roborock_a27_status_fixed
        icon: "mdi:robot-vacuum"
        state: >
          {% set vacuum = states('vacuum.robbi_2') %}
          {% if vacuum == 'docked' %}
            Docked
          {% elif vacuum == 'cleaning' %}
            Cleaning
          {% elif vacuum == 'returning' %}
            Returning
          {% elif vacuum == 'paused' %}
            Paused
          {% elif vacuum == 'error' %}
            Error
          {% elif vacuum == 'idle' %}
            Idle
          {% else %}
            {{ vacuum | title }}
          {% endif %}
        availability: >
          {{ states('vacuum.robbi_2') not in ['unknown', 'unavailable'] }}

  # Time-based sensors
  - sensor:
      - name: "WakeUp Light Timestamp"
        unique_id: wakeup_light_timestamp
        device_class: timestamp
        state: >
          {% set target = 'input_datetime.aufwachzeit_arbeitstag' if is_state("binary_sensor.workday_sensor", "on") else 'input_datetime.aufwachzeit_freier_tag' %}
          {% set raw = states(target) %}
          {% if raw in ['unknown', 'unavailable', ''] %}
            {{ none }}
          {% else %}
            {% set parsed = as_datetime(raw, default=None) %}
            {% set time_str = parsed.strftime('%H:%M:%S') if parsed is not none else raw %}
            {{ today_at(time_str) }}
          {% endif %}
        availability: >
          {{ states('binary_sensor.workday_sensor') not in ['unknown', 'unavailable'] and
             states('input_datetime.aufwachzeit_arbeitstag') not in ['unknown', 'unavailable'] and
             states('input_datetime.aufwachzeit_freier_tag') not in ['unknown', 'unavailable'] }}

      - name: "Einschlafzeit Timestamp"
        unique_id: einschlafzeit_timestamp
        device_class: timestamp
        state: >
          {% set target = 'input_datetime.einschlafzeit_arbeitstag' if is_state("binary_sensor.tomorrow_workday_sensor", "on") else 'input_datetime.einschlafzeit_freier_tag' %}
          {% set raw = states(target) %}
          {% if raw in ['unknown', 'unavailable', ''] %}
            {{ none }}
          {% else %}
            {% set parsed = as_datetime(raw, default=None) %}
            {% set time_str = parsed.strftime('%H:%M:%S') if parsed is not none else raw %}
            {{ today_at(time_str) }}
          {% endif %}
        availability: >
          {{ states('binary_sensor.tomorrow_workday_sensor') not in ['unknown', 'unavailable'] and
             states('input_datetime.einschlafzeit_arbeitstag') not in ['unknown', 'unavailable'] and
             states('input_datetime.einschlafzeit_freier_tag') not in ['unknown', 'unavailable'] }}

  # Scene status sensors
  - sensor:
      - name: "Active Scenes"
        unique_id: active_scenes
        state: >
          {% set scenes = [
            'Film' if is_state('input_boolean.movie', 'on') else none,
            'Party' if is_state('input_boolean.party', 'on') else none,
            'Kochen' if is_state('input_boolean.kochen', 'on') else none,
            'Essen' if is_state('input_boolean.essen', 'on') else none,
            'Baden' if is_state('input_boolean.baden', 'on') else none,
            'Sauna' if is_state('input_boolean.sauna', 'on') else none,
            'Arbeit' if is_state('input_boolean.arbeit', 'on') else none,
            'Gaming' if is_state('input_boolean.gaming', 'on') else none
          ] | reject('none') | list %}
          {% if scenes | length > 0 %}
            {{ scenes | join(', ') }}
          {% else %}
            Keine
          {% endif %}
        icon: mdi:play-circle
        attributes:
          scene_count: >
            {{ [
              is_state('input_boolean.movie', 'on'),
              is_state('input_boolean.party', 'on'),
              is_state('input_boolean.kochen', 'on'),
              is_state('input_boolean.essen', 'on'),
              is_state('input_boolean.baden', 'on'),
              is_state('input_boolean.sauna', 'on'),
              is_state('input_boolean.arbeit', 'on'),
              is_state('input_boolean.gaming', 'on')
            ] | select('true') | list | length }}
          scene_list: >
            {{ [
              'Film' if is_state('input_boolean.movie', 'on') else none,
              'Party' if is_state('input_boolean.party', 'on') else none,
              'Kochen' if is_state('input_boolean.kochen', 'on') else none,
              'Essen' if is_state('input_boolean.essen', 'on') else none,
              'Baden' if is_state('input_boolean.baden', 'on') else none,
              'Sauna' if is_state('input_boolean.sauna', 'on') else none,
              'Arbeit' if is_state('input_boolean.arbeit', 'on') else none,
              'Gaming' if is_state('input_boolean.gaming', 'on') else none
            ] | reject('none') | list }}

  # Scene status binary sensors
  - binary_sensor:
      - name: "Any Scene Active"
        unique_id: any_scene_active
        device_class: running
        state: >
          {{ [
            is_state('input_boolean.movie', 'on'),
            is_state('input_boolean.party', 'on'),
            is_state('input_boolean.kochen', 'on'),
            is_state('input_boolean.essen', 'on'),
            is_state('input_boolean.baden', 'on'),
            is_state('input_boolean.sauna', 'on'),
            is_state('input_boolean.arbeit', 'on'),
            is_state('input_boolean.gaming', 'on')
          ] | select('true') | list | length > 0 }}
        availability: >
          {{ expand(['input_boolean.movie', 'input_boolean.party',
                     'input_boolean.kochen', 'input_boolean.essen',
                     'input_boolean.baden', 'input_boolean.sauna',
                     'input_boolean.arbeit', 'input_boolean.gaming'])
             | selectattr('state', 'defined') | list | length == 8 }}
        icon: >
          {% if this.state == 'on' %}
            mdi:play-circle
          {% else %}
            mdi:play-circle-outline
          {% endif %}
        attributes:
          active_scenes: "{{ states('sensor.active_scenes') }}"
          scene_count: "{{ state_attr('sensor.active_scenes', 'scene_count') }}"

      - name: "Scene Conflict Detected"
        unique_id: scene_conflict_detected
        device_class: problem
        state: >
          {% set party = is_state('input_boolean.party', 'on') %}
          {% set arbeit = is_state('input_boolean.arbeit', 'on') %}
          {% set gaming = is_state('input_boolean.gaming', 'on') %}
          {% set other_scenes = [
            is_state('input_boolean.movie', 'on'),
            is_state('input_boolean.kochen', 'on'),
            is_state('input_boolean.essen', 'on'),
            is_state('input_boolean.baden', 'on'),
            is_state('input_boolean.sauna', 'on')
          ] | select('true') | list | length > 0 %}
          {% set conflict = false %}
          {# Party conflicts with any other scene #}
          {% if party and (arbeit or gaming or other_scenes) %}
            {% set conflict = true %}
          {% endif %}
          {# Arbeit and Gaming conflict (same room) #}
          {% if arbeit and gaming %}
            {% set conflict = true %}
          {% endif %}
          {{ conflict }}
        availability: >
          {{ expand(['input_boolean.movie', 'input_boolean.party',
                     'input_boolean.kochen', 'input_boolean.essen',
                     'input_boolean.baden', 'input_boolean.sauna',
                     'input_boolean.arbeit', 'input_boolean.gaming'])
             | selectattr('state', 'defined') | list | length == 8 }}
        icon: >
          {% if this.state == 'on' %}
            mdi:alert-circle
          {% else %}
            mdi:check-circle
          {% endif %}
        attributes:
          active_scenes: "{{ states('sensor.active_scenes') }}"
          conflict_reason: >
            {% set party = is_state('input_boolean.party', 'on') %}
            {% set arbeit = is_state('input_boolean.arbeit', 'on') %}
            {% set gaming = is_state('input_boolean.gaming', 'on') %}
            {% set other_scenes = [
              is_state('input_boolean.movie', 'on'),
              is_state('input_boolean.kochen', 'on'),
              is_state('input_boolean.essen', 'on'),
              is_state('input_boolean.baden', 'on'),
              is_state('input_boolean.sauna', 'on')
            ] | select('true') | list | length > 0 %}
            {% if party and (arbeit or gaming or other_scenes) %}
              Party-Modus kann nicht mit anderen Szenen kombiniert werden
            {% elif arbeit and gaming %}
              Arbeit und Gaming nutzen denselben Raum (Arbeitszimmer)
            {% else %}
              Kein Konflikt
            {% endif %}

  # Manual Control Sensors for Motion Bypass
  # These track when lights have been manually controlled (via Siri, app, switch)
  # Used to bypass motion-based turn-off automations
  - binary_sensor:
      - name: "Wohnzimmer Manual Control"
        unique_id: wohnzimmer_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_wohnzimmer', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Küche Manual Control"
        unique_id: kueche_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_kueche', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Schlafzimmer Manual Control"
        unique_id: schlafzimmer_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_schlafzimmer', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Kinderzimmer Manual Control"
        unique_id: kinderzimmer_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_kinderzimmer', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Badezimmer Manual Control"
        unique_id: badezimmer_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_badezimmer', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Waschzimmer Manual Control"
        unique_id: waschzimmer_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_waschzimmer', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Arbeitszimmer Manual Control"
        unique_id: arbeitszimmer_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_arbeitszimmer', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Ankleide Manual Control"
        unique_id: ankleide_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_ankleide', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Flur Manual Control"
        unique_id: flur_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_flur', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Balkon Manual Control"
        unique_id: balkon_manual_control
        state: >-
          {{ (state_attr('switch.adaptive_lighting_balkon', 'manual_control') or []) | length > 0 }}
        icon: mdi:hand-back-right

      - name: "Motion Automations Disabled"
        unique_id: motion_automations_disabled
        device_class: problem
        state: >
          {{ is_state('automation.motion_kuche_2', 'off') or
             is_state('automation.motion_esstisch', 'off') or
             is_state('automation.motion_badezimmer_gross', 'off') or
             is_state('automation.arbeitszimmer_motion', 'off') }}
        availability: >
          {{ expand(['automation.motion_kuche_2', 'automation.motion_esstisch',
                     'automation.motion_badezimmer_gross', 'automation.arbeitszimmer_motion'])
             | selectattr('state', 'defined') | list | length == 4 }}
        icon: >
          {% if this.state == 'on' %}
            mdi:motion-sensor-off
          {% else %}
            mdi:motion-sensor
          {% endif %}
        attributes:
          disabled_count: >
            {{ [
              is_state('automation.motion_kuche_2', 'off'),
              is_state('automation.motion_esstisch', 'off'),
              is_state('automation.motion_badezimmer_gross', 'off'),
              is_state('automation.arbeitszimmer_motion', 'off')
            ] | select('true') | list | length }}
          disabled_automations: >
            {{ [
              'Küche' if is_state('automation.motion_kuche_2', 'off') else none,
              'Esstisch' if is_state('automation.motion_esstisch', 'off') else none,
              'Badezimmer' if is_state('automation.motion_badezimmer_gross', 'off') else none,
              'Arbeitszimmer' if is_state('automation.arbeitszimmer_motion', 'off') else none
            ] | reject('none') | list | join(', ') }}

  # Fan speed calculation sensors
  - sensor:
      - name: "Fan Speed Office Calculated"
        unique_id: fan_speed_office_calculated
        unit_of_measurement: "%"
        state: >
          {% set ac_running = is_state('climate.ac', 'on') if has_value('climate.ac') else false %}
          {% if has_value('sensor.arbeitszimmer_temperatur') %}
            {% set temp = states('sensor.arbeitszimmer_temperatur')|float(22) %}
            {% if ac_running %}
              {# With AC: Lower speeds for air circulation #}
              {% if temp > 28 %} 75
              {% elif temp > 26 %} 50
              {% elif temp > 24 %} 25
              {% else %} 25
              {% endif %}
            {% else %}
              {# Without AC: Normal speeds #}
              {% if temp > 28 %} 100
              {% elif temp > 26 %} 75
              {% elif temp > 24 %} 50
              {% else %} 25
              {% endif %}
            {% endif %}
          {% else %}
            25
          {% endif %}
        availability: >
          {{ has_value('sensor.arbeitszimmer_temperatur') }}
        attributes:
          temperature: "{{ states('sensor.arbeitszimmer_temperatur') if has_value('sensor.arbeitszimmer_temperatur') else 'N/A' }}"
          ac_running: "{{ ac_running }}"

      - name: "Fan Speed Kids Room Calculated"
        unique_id: fan_speed_kids_calculated
        unit_of_measurement: "%"
        state: >
          {% if has_value('sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature') %}
            {% set temp = states('sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature')|float(22) %}
            {# Gentle speeds for kids #}
            {% if temp > 28 %} 50
            {% elif temp > 26 %} 35
            {% elif temp > 24 %} 25
            {% else %} 20
            {% endif %}
          {% else %}
            20
          {% endif %}
        availability: >
          {{ has_value('sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature') }}
        attributes:
          temperature: "{{ states('sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature') if has_value('sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature') else 'N/A' }}"

      - name: "Room Temperature Average"
        unique_id: room_temperature_average
        unit_of_measurement: "°C"
        device_class: temperature
        state: >
          {% set temps = [
            states('sensor.arbeitszimmer_temperatur'),
            states('sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature'),
            states('sensor.badezimmer_temperatur_und_luftfeuchtigkeit_temperature'),
            states('sensor.qingping_air_monitor_lite_temperature')
          ] | reject('in', ['unknown', 'unavailable']) | map('float', 0) | select('>', 0) | list %}
          {% if temps | length > 0 %}
            {{ (temps | sum / temps | length) | round(1) }}
          {% else %}
            unavailable
          {% endif %}
        availability: >
          {{ expand(['sensor.arbeitszimmer_temperatur',
                     'sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature',
                     'sensor.badezimmer_temperatur_und_luftfeuchtigkeit_temperature',
                     'sensor.qingping_air_monitor_lite_temperature'])
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | list | length > 0 }}
        attributes:
          room_count: >
            {{ expand(['sensor.arbeitszimmer_temperatur',
                       'sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature',
                       'sensor.badezimmer_temperatur_und_luftfeuchtigkeit_temperature',
                       'sensor.qingping_air_monitor_lite_temperature'])
               | rejectattr('state', 'in', ['unknown', 'unavailable'])
               | list | length }}

  # Weather forecast sensor with trigger
  - trigger:
      - platform: time_pattern
        minutes: "/30" # Every 30 minutes instead of every minute
      - platform: homeassistant
        event: start
      - platform: event
        event_type: event_template_reloaded
    action:
      - action: weather.get_forecasts
        target:
          entity_id: weather.fuerth_bayern
        data:
          type: daily
        response_variable: daily_forecast
    sensor:
      - name: "Fürth Daily Forecast"
        unique_id: fuerth_bayern_daily
        state: "{{ states('weather.fuerth_bayern') }}"
        attributes:
          temperature: "{{ state_attr('weather.fuerth_bayern', 'temperature') }}"
          dew_point: "{{ state_attr('weather.fuerth_bayern', 'dew_point') }}"
          temperature_unit: "{{ state_attr('weather.fuerth_bayern', 'temperature_unit') }}"
          humidity: "{{ state_attr('weather.fuerth_bayern', 'humidity') }}"
          cloud_coverage: "{{ state_attr('weather.fuerth_bayern', 'cloud_coverage') }}"
          pressure: "{{ state_attr('weather.fuerth_bayern', 'pressure') }}"
          pressure_unit: "{{ state_attr('weather.fuerth_bayern', 'pressure_unit') }}"
          wind_bearing: "{{ state_attr('weather.fuerth_bayern', 'wind_bearing') }}"
          wind_gust_speed: "{{ state_attr('weather.fuerth_bayern', 'wind_gust_speed') }}"
          wind_speed: "{{ state_attr('weather.fuerth_bayern', 'wind_speed') }}"
          wind_speed_unit: "{{ state_attr('weather.fuerth_bayern', 'wind_speed_unit') }}"
          visibility: "{{ state_attr('weather.fuerth_bayern', 'visibility') }}"
          visibility_unit: "{{ state_attr('weather.fuerth_bayern', 'visibility_unit') }}"
          precipitation: "{{ state_attr('weather.fuerth_bayern', 'precipitation') }}"
          precipitation_unit: "{{ state_attr('weather.fuerth_bayern', 'precipitation_unit') }}"
          forecast: "{{ daily_forecast['weather.fuerth_bayern'].forecast[:5] }}"

utility_meter:
  ac_energy_daily:
    source: sensor.ac_total_energy
    name: "AC Energie Täglich"
    cycle: daily
    
  # Utility meters for grid import/export tracking
  taglicher_netzbezug:
    source: sensor.netzbezug_energie
    name: "Täglicher Netzbezug"
    cycle: daily
    
  tagliche_einspeisung:
    source: sensor.einspeisung_energie
    name: "Tägliche Einspeisung"
    cycle: daily
    
  # Utility Meter für Energy müssen Integration Sensoren verwenden
  # Diese werden automatisch durch Home Assistant Energy Dashboard erstellt
  # Falls sie nicht existieren, können sie über Settings > Energy konfiguriert werden


input_boolean:
  haustur_besucher_inside:
    name: "Besucher ist im Haus"
  test_morning_routine:
    name: "Test Morning Routine"
    icon: mdi:weather-sunset-up
    initial: false
  gaming:
    name: "Gaming Mode"
    icon: mdi:gamepad-variant
    initial: false
  frost_warning_sent:
    name: "Frostwarnung gesendet"
    icon: mdi:snowflake-alert
    initial: false
  # Test triggers for scene validation
  test_scene_film:
    name: "Test Scene: Film"
    icon: mdi:movie-play
    initial: false
  test_scene_party:
    name: "Test Scene: Party"
    icon: mdi:party-popper
    initial: false
  test_scene_kochen:
    name: "Test Scene: Kochen"
    icon: mdi:chef-hat
    initial: false
  test_scene_baden:
    name: "Test Scene: Baden"
    icon: mdi:bathtub
    initial: false

input_datetime:
  haustur_eingang_zeit:
    name: "Eingangszeit Besucher"
    has_date: true
    has_time: true

  haustur_letzter_eingang:
    name: "Letzter Eingang über Haustür"
    has_date: true
    has_time: true

  wakeup_routine_started:
    name: "Aufwachroutine gestartet"
    has_date: true
    has_time: true

input_text:
  haustur_besucher_dauer:
    name: "Besuchsdauer"
    initial: ""
    max: 100

input_number:
  # Climate control temperature thresholds
  ac_temp_hot:
    name: "AC Aktivierung Temperatur (heiß)"
    min: 20
    max: 35
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer-high
    initial: 25
  ac_temp_warm:
    name: "AC Aktivierung Temperatur (warm)"
    min: 20
    max: 35
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
    initial: 23
  ac_temp_comfortable:
    name: "AC Aktivierung Temperatur (angenehm)"
    min: 18
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer-low
    initial: 22
  # Rollo/blind position settings
  rollo_position_closed:
    name: "Rollo Position: Geschlossen"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    icon: mdi:window-shutter
    initial: 0
  rollo_position_partial:
    name: "Rollo Position: Teilweise"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    icon: mdi:window-shutter
    initial: 25
  rollo_position_half:
    name: "Rollo Position: Halb"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    icon: mdi:window-shutter-open
    initial: 50
  rollo_position_open:
    name: "Rollo Position: Offen"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    icon: mdi:window-shutter-open
    initial: 100
  # Fan speed percentages
  fan_speed_low:
    name: "Lüfter Geschwindigkeit: Niedrig"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    icon: mdi:fan-speed-1
    initial: 25
  fan_speed_medium:
    name: "Lüfter Geschwindigkeit: Mittel"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    icon: mdi:fan-speed-2
    initial: 50
  fan_speed_high:
    name: "Lüfter Geschwindigkeit: Hoch"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    icon: mdi:fan-speed-3
    initial: 75
  fan_speed_max:
    name: "Lüfter Geschwindigkeit: Maximum"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    icon: mdi:fan
    initial: 100

input_select:
  active_scene:
    name: "Aktive Szene"
    options:
      - "Keine"
      - "Film"
      - "Party"
      - "Kochen"
      - "Essen"
      - "Baden"
      - "Sauna"
      - "Arbeit"
      - "Gaming"
    initial: "Keine"
    icon: mdi:play-circle
  wakeup_routine_phase:
    name: "Aufwachroutine Phase"
    options:
      - "Inaktiv"
      - "Phase 1 (1%)"
      - "Phase 2 (10%)"
      - "Phase 3 (40%)"
      - "Phase 4 (100%)"
      - "Abgeschlossen"
    initial: "Inaktiv"
    icon: mdi:weather-sunset-up

# ============================================================================
# DEVICE TRACKING
# ============================================================================
# ============================================================================
# EXTERNAL FILE INCLUDES
# ============================================================================

automation: !include_dir_merge_list automations_new/
script: !include scripts.yaml
scene: !include scenes.yaml
sensor: !include sensors.yaml
binary_sensor: !include binary_sensors.yaml
group: !include groups.yaml
light: !include lights.yaml
timer: !include timers.yaml
climate: !include climates.yaml

# Dashboard Konfiguration
lovelace:
  mode: storage

# ============================================================================
# SYSTEM FEATURES
# ============================================================================

python_script:
system_health:
energy:
backup:

# System Monitor integration must be configured via UI
# Go to Settings > Devices & Services > Add Integration > System Monitor
# This will create entities like sensor.processor_use_percent, etc.


  
