# Lighting - Adaptive Lighting.Yaml
# Generated by automation splitter - 1 automations
# Part of Home Assistant configuration

- id: '1736168695364'
  alias: Lichter ausschalten bei Inaktivität (Areas)
  description: Schaltet Lichter in Räumen nach 30 Minuten Inaktivität automatisch
    aus, außer bestimmte ausgeschlossene Lampen
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.flur_motion
    - binary_sensor.balkon_motion_occupancy
    - binary_sensor.kuche_motion_occupancy
    - binary_sensor.haustur_motion_occupancy
    - binary_sensor.badezimmer_motion_presence
    - binary_sensor.waschzimmer_motion_presence
    - binary_sensor.kinderzimmer_motion_presence
    - binary_sensor.arbeitszimmer_motion_occupancy
    - binary_sensor.ankleide_bewegungsmelder_occupancy
    - binary_sensor.schlafzimmer_motion_occupancy
    - binary_sensor.wohnzimmer_motion_occupancy
    to: 'off'
    for:
      hours: 0
      minutes: 30
      seconds: 0
  actions:
  - variables:
      motion_sensor: '{{ trigger.entity_id if has_value(trigger.entity_id) else "unknown" }}'
      motion_area: '{{ area_id(motion_sensor) if motion_sensor != "unknown" and has_value(motion_sensor) else "unknown" }}'
      entities_in_area: '{{ area_entities(motion_area) if motion_area != "unknown" and has_value(motion_area) else [] }}'
      lights_in_area: "{% if entities_in_area %}{{ expand(entities_in_area) | selectattr('domain', 'eq', 'light') | selectattr('state', 'eq', 'on') | rejectattr('state', 'in', ['unavailable', 'unknown']) | map(attribute='entity_id') | list }}{% else %}[]{% endif %}"
      excluded_lights:
      - light.hyperhdr
      - light.lichterkette
      lights_to_turn_off: '{{ lights_in_area | reject("in", excluded_lights) | list if lights_in_area else [] }}'
      area_name: '{{ area_name(motion_area) if motion_area != "unknown" and has_value(motion_area) else "Unbekannter Bereich" }}'
  - choose:
    - alias: Lichter ausschalten wenn vorhanden und Area bekannt
      conditions:
      - alias: Area wurde gefunden
        condition: template
        value_template: '{{ motion_area != "unknown" and has_value(motion_area) }}'
      - alias: Es gibt Lichter zum Ausschalten
        condition: template
        value_template: '{{ lights_to_turn_off | length > 0 }}'
      - alias: Nicht während Schlafenszeit (verhindert störende Logs)
        condition: state
        entity_id: input_boolean.schlafenszeit
        state: 'off'
      - condition: template
        value_template: "{{ has_value('input_boolean.schlafenszeit') }}"
      - alias: Keine manuelle Steuerung aktiv (Adaptive Lighting)
        condition: template
        value_template: >-
          {% set area_to_sensor = {
            'ankleide': 'binary_sensor.ankleide_manual_control',
            'flur': 'binary_sensor.flur_manual_control',
            'kuche': 'binary_sensor.kuche_manual_control',
            'kueche': 'binary_sensor.kuche_manual_control',
            'badezimmer': 'binary_sensor.badezimmer_manual_control',
            'waschzimmer': 'binary_sensor.waschzimmer_manual_control',
            'kinderzimmer': 'binary_sensor.kinderzimmer_manual_control',
            'arbeitszimmer': 'binary_sensor.arbeitszimmer_manual_control',
            'balkon': 'binary_sensor.balkon_manual_control'
          } %}
          {% set sensor = area_to_sensor.get(motion_area, none) %}
          {{ sensor is none or is_state(sensor, 'off') }}
      sequence:
      - alias: Lichter in Area ausschalten
        action: light.turn_off
        target:
          entity_id: '{{ lights_to_turn_off }}'
      - alias: Erfolgreiche Ausschaltung loggen
        action: logbook.log
        data:
          name: Inaktivitäts-Automation
          message: '{{ lights_to_turn_off | length }} Licht(er) in {{ area_name }}  nach
            30 Min Inaktivität ausgeschaltet: {{ lights_to_turn_off | join('', '')
            }}

            '
    - alias: Debugging bei Problemen
      conditions:
      - alias: Area unbekannt oder keine Lichter
        condition: or
        conditions:
        - condition: template
          value_template: '{{ motion_area == "unknown" or not has_value(motion_area) }}'
        - condition: template
          value_template: '{{ lights_to_turn_off | length == 0 }}'
      sequence:
      - alias: Debug-Information loggen
        action: logbook.log
        data:
          name: Inaktivitäts-Automation Debug
          message: 'Bewegungsmelder: {{ motion_sensor | replace(''binary_sensor.'',
            '''') }}. Area: {{ area_name }} ({{ motion_area }}). Alle Lichter in Area:
            {{ lights_in_area | length }}  ({{ lights_in_area | join('', '') if lights_in_area
            else ''keine'' }}). Nach Ausschluss: {{ lights_to_turn_off | length }}
            ({{ lights_to_turn_off | join('', '') if lights_to_turn_off else ''keine''
            }}). Zeit: {{ now().strftime(''%H:%M:%S am %d.%m.%Y'') }}

            '
  mode: restart

- id: 'instant_manual_control_detection'
  alias: "Adaptive Lighting: Sofortige Erkennung manueller Steuerung"
  description: >-
    Erkennt manuelle Lichtänderungen sofort und markiert sie als manuell gesteuert,
    ohne auf das AL-Polling-Intervall zu warten. Funktioniert mit Siri, HomeKit,
    physischen Schaltern und HA UI.
  mode: parallel
  max: 50
  triggers:
  - trigger: state
    entity_id:
    # Wohnzimmer
    - light.wohnzimmer_wand_alle
    - light.wohnzimmer_esstisch_alle
    - light.wohnzimmer_spielematte_alle
    - light.wohnzimmer_schrank_alle
    - light.wohnzimmer_spieletisch
    # Küche
    - light.kuche_decke_alle
    - light.kuche_insel_alle
    - light.kuche_schrank_alle
    # Schlafzimmer
    - light.schlafzimmer_decke_alle
    - light.schlafzimmer_bett
    - light.schlafzimmer_tv
    # Kinderzimmer
    - light.kinderzimmer_decke
    - light.kinderzimmer_bucher
    - light.kinderzimmer_schrank
    # Badezimmer
    - light.badezimmer_decke_alle
    - light.badezimmer_schrank
    - light.badezimmer_fenster
    # Waschzimmer
    - light.waschzimmer_decke
    # Arbeitszimmer
    - light.arbeitszimmer_decke
    - light.arbeitszimmer_pc_alle
    - light.arbeitszimmer_stehlampe
    # Ankleide
    - light.ankleide_decke_alle
    # Flur
    - light.flur_decke_alle
    - light.flur_schrank_alle
    # Balkon
    - light.balkon_wand_alle
    - light.balkon_blumen
  conditions:
  # Light must be ON after the change
  - condition: template
    value_template: "{{ trigger.to_state.state == 'on' }}"
  # NOT triggered by Adaptive Lighting (check context doesn't contain AL marker)
  - condition: template
    value_template: >-
      {{ ':al:' not in (trigger.to_state.context.id | default('')) }}
  # Either: (A) light was already on and attrs changed, OR (B) light turned on while motion is OFF
  - condition: template
    value_template: >-
      {% set was_on = trigger.from_state.state == 'on' %}
      {% set turned_on = trigger.from_state.state != 'on' %}
      {% set old = trigger.from_state.attributes %}
      {% set new = trigger.to_state.attributes %}
      {% set attrs_changed = old.get('brightness') != new.get('brightness') or
         old.get('color_temp') != new.get('color_temp') or
         old.get('color_temp_kelvin') != new.get('color_temp_kelvin') %}
      {% set light_id = trigger.entity_id %}
      {% set motion_sensors = {
        'wohnzimmer': 'binary_sensor.wohnzimmer_motion_occupancy',
        'kuche': 'binary_sensor.kuche_motion_occupancy',
        'schlafzimmer': 'binary_sensor.schlafzimmer_motion_occupancy',
        'kinderzimmer': 'binary_sensor.kinderzimmer_motion_presence',
        'badezimmer': 'binary_sensor.badezimmer_motion_all',
        'waschzimmer': 'binary_sensor.waschzimmer_motion_presence',
        'arbeitszimmer': 'binary_sensor.arbeitszimmer_motion_occupancy',
        'ankleide': 'binary_sensor.ankleide_bewegungsmelder_occupancy',
        'flur': 'binary_sensor.flur_motion',
        'balkon': 'binary_sensor.balkon_motion_occupancy'
      } %}
      {% set area = light_id.split('.')[1].split('_')[0] %}
      {% set motion = motion_sensors.get(area, none) %}
      {% set motion_off = motion is none or is_state(motion, 'off') %}
      {{ (was_on and attrs_changed) or (turned_on and motion_off) }}
  variables:
    light: "{{ trigger.entity_id }}"
    # Map light to its AL switch based on entity_id prefix
    al_switch: >-
      {% set light_id = trigger.entity_id %}
      {% if 'wohnzimmer' in light_id %}
        switch.adaptive_lighting_wohnzimmer
      {% elif 'kuche' in light_id or 'kueche' in light_id %}
        switch.adaptive_lighting_kuche
      {% elif 'schlafzimmer' in light_id %}
        switch.adaptive_lighting_schlafzimmer
      {% elif 'kinderzimmer' in light_id %}
        switch.adaptive_lighting_kinderzimmer
      {% elif 'badezimmer' in light_id %}
        switch.adaptive_lighting_badezimmer
      {% elif 'waschzimmer' in light_id %}
        switch.adaptive_lighting_waschzimmer
      {% elif 'arbeitszimmer' in light_id %}
        switch.adaptive_lighting_arbeitszimmer
      {% elif 'ankleide' in light_id %}
        switch.adaptive_lighting_ankleide
      {% elif 'flur' in light_id %}
        switch.adaptive_lighting_flur
      {% elif 'balkon' in light_id %}
        switch.adaptive_lighting_balkon
      {% else %}
        none
      {% endif %}
  actions:
  - condition: template
    value_template: "{{ al_switch != 'none' }}"
  - alias: "Licht als manuell gesteuert markieren"
    action: adaptive_lighting.set_manual_control
    data:
      entity_id: "{{ al_switch }}"
      lights: "{{ light }}"
      manual_control: true

- id: 'reset_manual_control_on_off'
  alias: "Adaptive Lighting: Manual Control zurücksetzen bei Licht aus"
  description: >-
    Setzt manual_control zurück wenn ein Licht ausgeschaltet wird,
    damit beim nächsten Einschalten Adaptive Lighting wieder übernimmt.
  mode: parallel
  max: 50
  triggers:
  - trigger: state
    entity_id:
    # Same lights as instant detection
    - light.wohnzimmer_wand_alle
    - light.wohnzimmer_esstisch_alle
    - light.wohnzimmer_spielematte_alle
    - light.wohnzimmer_schrank_alle
    - light.wohnzimmer_spieletisch
    - light.kuche_decke_alle
    - light.kuche_insel_alle
    - light.kuche_schrank_alle
    - light.schlafzimmer_decke_alle
    - light.schlafzimmer_bett
    - light.schlafzimmer_tv
    - light.kinderzimmer_decke
    - light.kinderzimmer_bucher
    - light.kinderzimmer_schrank
    - light.badezimmer_decke_alle
    - light.badezimmer_schrank
    - light.badezimmer_fenster
    - light.waschzimmer_decke
    - light.arbeitszimmer_decke
    - light.arbeitszimmer_pc_alle
    - light.arbeitszimmer_stehlampe
    - light.ankleide_decke_alle
    - light.flur_decke_alle
    - light.flur_schrank_alle
    - light.balkon_wand_alle
    - light.balkon_blumen
    to: 'off'
  variables:
    light: "{{ trigger.entity_id }}"
    al_switch: >-
      {% set light_id = trigger.entity_id %}
      {% if 'wohnzimmer' in light_id %}
        switch.adaptive_lighting_wohnzimmer
      {% elif 'kuche' in light_id or 'kueche' in light_id %}
        switch.adaptive_lighting_kuche
      {% elif 'schlafzimmer' in light_id %}
        switch.adaptive_lighting_schlafzimmer
      {% elif 'kinderzimmer' in light_id %}
        switch.adaptive_lighting_kinderzimmer
      {% elif 'badezimmer' in light_id %}
        switch.adaptive_lighting_badezimmer
      {% elif 'waschzimmer' in light_id %}
        switch.adaptive_lighting_waschzimmer
      {% elif 'arbeitszimmer' in light_id %}
        switch.adaptive_lighting_arbeitszimmer
      {% elif 'ankleide' in light_id %}
        switch.adaptive_lighting_ankleide
      {% elif 'flur' in light_id %}
        switch.adaptive_lighting_flur
      {% elif 'balkon' in light_id %}
        switch.adaptive_lighting_balkon
      {% else %}
        none
      {% endif %}
  actions:
  - condition: template
    value_template: "{{ al_switch != 'none' }}"
  - alias: "Manual control für dieses Licht zurücksetzen"
    action: adaptive_lighting.set_manual_control
    data:
      entity_id: "{{ al_switch }}"
      lights: "{{ light }}"
      manual_control: false
