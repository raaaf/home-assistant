# Lighting - Day Night.Yaml
# Generated by automation splitter - 3 automations
# Part of Home Assistant configuration

- id: '1645377860470'
  alias: State » Tag/Nacht
  description: Steuert Tag/Nacht-Übergänge mit Alarm, Beleuchtung und adaptiver Beleuchtung
  triggers:
  - trigger: time
    at: sensor.wakeup_light_timestamp
    id: wakeup
  - trigger: state
    entity_id: input_boolean.test_morning_routine
    from: 'off'
    to: 'on'
    id: wakeup
  - trigger: numeric_state
    entity_id: sun.sun
    attribute: elevation
    above: -3.5
    id: sun
  - trigger: time
    at: 06:45:00
    id: sun
  - trigger: time
    at: sensor.einschlafzeit_timestamp
    id: einschlafzeit
  - trigger: state
    entity_id: input_boolean.schlafenszeit
    from: 'off'
    to: 'on'
    for: 00:00:30
    id: early-schlafenszeit
  - trigger: time
    at: '22:00:00'
    id: schlafenszeit
  conditions: []
  actions:
  - choose:
    - alias: Aufwachen - Alarm deaktivieren und sanftes Licht
      conditions:
      - condition: trigger
        id: wakeup
      sequence:
      - alias: Schlafenszeit beenden
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.schlafenszeit
      - alias: Sleep Mode für alle Räume deaktivieren
        action: switch.turn_off
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_badezimmer
          - switch.adaptive_lighting_sleep_mode_balkon
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_kueche
          - switch.adaptive_lighting_sleep_mode_waschzimmer
          - switch.adaptive_lighting_sleep_mode_wohnzimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
      - alias: Sanftes Aufwachlicht nur an Werktagen wenn jemand da ist
        if:
        - alias: Ist Werktag
          condition: state
          entity_id: binary_sensor.workday_sensor
          state: 'on'
        - condition: template
          value_template: "{{ has_value('binary_sensor.workday_sensor') and has_value('input_boolean.alle_sind_weg') }}"
        - alias: Jemand ist zu Hause
          condition: state
          entity_id: input_boolean.alle_sind_weg
          state: 'off'
        then:
        - alias: Set very low brightness for wake-up routine (let AL handle color)
          action: adaptive_lighting.change_switch_settings
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_badezimmer
            - switch.adaptive_lighting_flur
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_kueche
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
          data:
            max_brightness: 1
            min_brightness: 1
        - alias: Motion-Automationen STOPPEN (während Wake-Up-Routine)
          action: automation.turn_off
          target:
            entity_id:
            - automation.motion_schlafzimmer
            - automation.kinderzimmer_motion
            - automation.arbeitszimmer_motion
            - automation.motion_badezimmer_gross
            - automation.motion_flur_wohnung
            - automation.motion_haustur
            - automation.motion_kuche_2
            - automation.motion_esstisch
          data:
            stop_actions: true
        # 30-Minute Gradual Wake-Up Light Routine (Research-Backed)
        # Exponential brightness curve: 1% → 10% → 40% → 100%
        # Color temp: Adaptive Lighting handles circadian rhythm automatically
        - alias: "Phase 1: Initial light at 1% (AL sets color for wake-up time)"
          action: light.turn_on
          target:
            entity_id:
            - light.alle_schlafzimmer_lichter
            - light.alle_kinderzimmer_lichter
            - light.alle_wohnzimmer_lichter
            - light.alle_arbeitszimmer_lichter
            - light.alle_badezimmer_lichter
            - light.alle_flur_lichter
            - light.alle_kuche_lichter
          data:
            brightness_pct: 1
        - alias: "Warte 10 Minuten (Augen passen sich an)"
          delay: 00:10:00
        - alias: "Phase 2: Erhöhe auf 10% Helligkeit (AL adapts color)"
          action: adaptive_lighting.change_switch_settings
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_badezimmer
            - switch.adaptive_lighting_flur
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_kueche
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
          data:
            max_brightness: 10
            min_brightness: 10
        - alias: "Warte 10 Minuten (langsame Anpassung)"
          delay: 00:10:00
        - alias: "Phase 3: Erhöhe auf 40% Helligkeit (AL adapts color)"
          action: adaptive_lighting.change_switch_settings
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_badezimmer
            - switch.adaptive_lighting_flur
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_kueche
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
          data:
            max_brightness: 40
            min_brightness: 40
        - alias: "Warte 10 Minuten (fortgesetzte Anpassung)"
          delay: 00:10:00
        - alias: "Phase 4: Volle Helligkeit (100%, AL handles optimal wake color)"
          action: adaptive_lighting.change_switch_settings
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_badezimmer
            - switch.adaptive_lighting_flur
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_kueche
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
          data:
            max_brightness: 100
            min_brightness: 100
        - alias: "Warte bis 8:00 Uhr (Motion-Sensoren bleiben deaktiviert)"
          delay:
            seconds: >-
              {% set target_time = today_at('08:00:00') %}
              {% set now_time = now() %}
              {% if now_time < target_time %}
                {{ (target_time - now_time).total_seconds() | int }}
              {% else %}
                0
              {% endif %}
        - alias: Motion-Automationen wieder aktivieren (nach Wake-Up-Routine)
          action: automation.turn_on
          target:
            entity_id:
            - automation.motion_schlafzimmer
            - automation.kinderzimmer_motion
            - automation.arbeitszimmer_motion
            - automation.motion_badezimmer_gross
            - automation.motion_flur_wohnung
            - automation.motion_haustur
            - automation.motion_kuche_2
            - automation.motion_esstisch
        - alias: Reset Adaptive Lighting to default settings
          action: adaptive_lighting.change_switch_settings
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_badezimmer
            - switch.adaptive_lighting_flur
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_kueche
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
          data:
            max_brightness: 100
            min_brightness: 10
    - alias: Sonnenaufgang - Schlafenszeit beenden
      conditions:
      - condition: trigger
        id: sun
      sequence:
      - alias: Schlafenszeit automatisch beenden bei Sonnenaufgang
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.schlafenszeit
      - alias: Sleep Mode für alle Räume deaktivieren bei Sonnenaufgang
        action: switch.turn_off
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_badezimmer
          - switch.adaptive_lighting_sleep_mode_balkon
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_kueche
          - switch.adaptive_lighting_sleep_mode_waschzimmer
          - switch.adaptive_lighting_sleep_mode_wohnzimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
    - alias: Einschlafzeit - Schlafmodus aktivieren
      conditions:
      - condition: trigger
        id: einschlafzeit
      - condition: state
        entity_id: input_boolean.alle_sind_weg
        state: 'off'
      sequence:
      - alias: Schlafenszeit aktivieren
        action: input_boolean.turn_on
        target:
          entity_id: input_boolean.schlafenszeit
      - alias: Automation-Zeitfenster auf nächste Dämmerung setzen
        action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.automation_lauft_nicht_vor
        data:
          timestamp: '{{ (state_attr(''sun.sun'', ''next_dusk'')|as_datetime).timestamp()
            }}'
      - alias: Automation-Zeitfenster auf nächste Morgendämmerung setzen
        action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.automation_lauft_erst_ab
        data:
          timestamp: '{{ (state_attr(''sun.sun'', ''next_dawn'')|as_datetime).timestamp()
            }}'
      - alias: Klimaanlage auf Schlafmodus (wenn verfügbar)
        if:
        - alias: Klimaanlage ist verfügbar
          condition: template
          value_template: '{{ has_value(''climate.ac'') and not is_state(''climate.ac'', ''unavailable'') }}'
        then:
        - action: climate.set_preset_mode
          target:
            entity_id: climate.ac
          data:
            preset_mode: sleep
    - alias: Frühe Schlafenszeit - Sleep Mode für wichtige Räume
      conditions:
      - condition: trigger
        id: early-schlafenszeit
      sequence:
      - alias: Sleep Mode für Haupträume aktivieren
        action: switch.turn_on
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
    - alias: 22:00 Uhr - Kompletter Nachtmodus
      conditions:
      - condition: trigger
        id: schlafenszeit
      - condition: state
        entity_id: input_boolean.alle_sind_weg
        state: 'off'
      sequence:
      - alias: Sleep Mode für alle Räume aktivieren
        action: switch.turn_on
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_badezimmer
          - switch.adaptive_lighting_sleep_mode_balkon
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kueche
          - switch.adaptive_lighting_sleep_mode_waschzimmer
          - switch.adaptive_lighting_sleep_mode_wohnzimmer
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
      - alias: Hauptlichter in Schlaf-/Kinderzimmern ausschalten
        action: light.turn_off
        target:
          entity_id:
          - light.alle_kinderzimmer_lichter
          - light.alle_schlafzimmer_lichter
          - light.alle_arbeitszimmer_lichter
  mode: queued
  max: 10
- id: es_ist_dunkel_toggle
  alias: Helper » Dunkel – an/aus je nach Sonnenstand
  description: Schaltet den Boolean ein bei Sonnenuntergang und aus bei Sonnenaufgang.
  triggers:
  - event: sunset
    id: sunset
    trigger: sun
    offset: 00:30:00
  - event: sunrise
    id: sunrise
    trigger: sun
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: sunset
      sequence:
      - target:
          entity_id: input_boolean.es_ist_dunkel
        action: input_boolean.turn_on
        data: {}
    - conditions:
      - condition: trigger
        id: sunrise
      sequence:
      - target:
          entity_id: input_boolean.es_ist_dunkel
        action: input_boolean.turn_off
        data: {}
  mode: single
- id: adaptive_lighting_sunset_color_transition
  alias: Adaptive Lighting » Gradual Warm Color at Sunset
  description: Gradually warm color temperature over 90 minutes starting at sunset
  triggers:
  - trigger: sun
    event: sunset
    offset: "00:00:00"
    id: sunset
  conditions: []
  actions:
  - alias: Gradually reduce color temp from 4000K to 2200K over 90 minutes (aborts if scene activates)
    repeat:
      while:
        - alias: Keine Szene aktiv (Film, Party, etc.)
          condition: state
          entity_id: binary_sensor.any_scene_active
          state: 'off'
        - alias: Max 18 Iterationen (90 Minuten)
          condition: template
          value_template: "{{ repeat.index <= 18 }}"
      sequence:
      - alias: "Step {{ repeat.index }}/18: Set color temp to {{ 4000 - (repeat.index * 100) }}K"
        action: adaptive_lighting.change_switch_settings
        target:
          entity_id:
          - switch.adaptive_lighting_arbeitszimmer
          - switch.adaptive_lighting_ankleide
          - switch.adaptive_lighting_badezimmer
          - switch.adaptive_lighting_balkon
          - switch.adaptive_lighting_flur
          - switch.adaptive_lighting_kinderzimmer
          - switch.adaptive_lighting_kueche
          - switch.adaptive_lighting_schlafzimmer
          - switch.adaptive_lighting_waschzimmer
          - switch.adaptive_lighting_wohnzimmer
        data:
          # Gradually reduce max_color_temp: 3900K → 3800K → ... → 2200K
          max_color_temp: >-
            {{ 4000 - (repeat.index * 100) }}
          # Keep brightness high during color transition
          min_brightness: 80
          max_brightness: 100
      - alias: Wait 5 minutes before next step
        delay: "00:05:00"
  mode: restart
- id: adaptive_lighting_dynamic_sunset
  alias: Adaptive Lighting » Fade Over 30 Minutes When Schlafenszeit Starts
  description: When schlafenszeit activates, fade lights over 30 minutes
  triggers:
  # Trigger when schlafenszeit turns ON
  - trigger: state
    entity_id: input_boolean.schlafenszeit
    from: 'off'
    to: 'on'
    id: schlafenszeit_on
  conditions: []
  actions:
  - alias: Start 30-minute fade-down when schlafenszeit activates
    action: adaptive_lighting.change_switch_settings
    target:
      entity_id:
      - switch.adaptive_lighting_arbeitszimmer
      - switch.adaptive_lighting_ankleide
      - switch.adaptive_lighting_badezimmer
      - switch.adaptive_lighting_balkon
      - switch.adaptive_lighting_flur
      - switch.adaptive_lighting_kinderzimmer
      - switch.adaptive_lighting_kueche
      - switch.adaptive_lighting_schlafzimmer
      - switch.adaptive_lighting_waschzimmer
      - switch.adaptive_lighting_wohnzimmer
    data:
      # Start transition now
      min_sunset_time: >-
        {{ now().strftime('%H:%M:%S') }}
      # End transition 30 minutes from now
      max_sunset_time: >-
        {{ (now() + timedelta(minutes=30)).strftime('%H:%M:%S') }}
      # Dim down to sleep brightness
      min_brightness: 10
      max_brightness: 100
  mode: single
- id: adaptive_lighting_morning_reset
  alias: Adaptive Lighting » Morning Reset to Default Sunset Times
  description: Resets adaptive lighting to conservative default times in the morning
  triggers:
  # Reset at sunrise or when sleep mode ends
  - trigger: state
    entity_id: input_boolean.schlafenszeit
    from: 'on'
    to: 'off'
    id: sleep_mode_ended
  - trigger: sun
    event: sunrise
    id: sunrise
  conditions: []
  actions:
  - alias: Reset all adaptive lighting switches to default settings
    action: adaptive_lighting.change_switch_settings
    target:
      entity_id:
      - switch.adaptive_lighting_arbeitszimmer
      - switch.adaptive_lighting_ankleide
      - switch.adaptive_lighting_badezimmer
      - switch.adaptive_lighting_balkon
      - switch.adaptive_lighting_flur
      - switch.adaptive_lighting_kinderzimmer
      - switch.adaptive_lighting_kueche
      - switch.adaptive_lighting_schlafzimmer
      - switch.adaptive_lighting_waschzimmer
      - switch.adaptive_lighting_wohnzimmer
    data:
      # Reset to defaults (will be overridden in evening)
      min_sunset_time: "20:00:00"
      max_sunset_time: "20:30:00"
      min_brightness: 10
      max_brightness: 100
      # Reset color temp to allow full range (neutral white during day)
      max_color_temp: 4000
  mode: single
