# Lighting - Day Night.Yaml
# Generated by automation splitter - 3 automations
# Part of Home Assistant configuration

- id: '1645377860470'
  alias: State » Tag/Nacht
  description: Steuert Tag/Nacht-Übergänge mit Alarm, Beleuchtung und adaptiver Beleuchtung
  triggers:
  - trigger: time
    at: sensor.wakeup_light_timestamp
    id: wakeup
  - trigger: numeric_state
    entity_id: sun.sun
    attribute: elevation
    above: -3.5
    id: sun
  - trigger: time
    at: 06:45:00
    id: sun
  - trigger: time
    at: sensor.einschlafzeit_timestamp
    id: einschlafzeit
  - trigger: state
    entity_id: input_boolean.schlafenszeit
    from: 'off'
    to: 'on'
    for: 00:00:30
    id: early-schlafenszeit
  - trigger: time
    at: '22:00:00'
    id: schlafenszeit
  conditions: []
  actions:
  - choose:
    - alias: Aufwachen - Alarm deaktivieren und sanftes Licht
      conditions:
      - condition: trigger
        id: wakeup
      sequence:
      - alias: Schlafenszeit beenden
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.schlafenszeit
      - alias: Sleep Mode für alle Räume deaktivieren
        action: switch.turn_off
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_badezimmer
          - switch.adaptive_lighting_sleep_mode_balkon
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_kueche
          - switch.adaptive_lighting_sleep_mode_waschzimmer
          - switch.adaptive_lighting_sleep_mode_wohnzimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
      - alias: Sanftes Aufwachlicht nur an Werktagen wenn jemand da ist
        if:
        - alias: Ist Werktag
          condition: state
          entity_id: binary_sensor.workday_sensor
          state: 'on'
        - condition: template
          value_template: "{{ has_value('binary_sensor.workday_sensor') and has_value('input_boolean.alle_sind_weg') }}"
        - alias: Jemand ist zu Hause
          condition: state
          entity_id: input_boolean.alle_sind_weg
          state: 'off'
        then:
        - alias: Adaptive Beleuchtung komplett deaktivieren (verhindert Auto-Reset)
          action: switch.turn_off
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
        - alias: Motion-Automationen STOPPEN (während Wake-Up-Routine)
          action: automation.turn_off
          target:
            entity_id:
            - automation.motion_schlafzimmer
            - automation.kinderzimmer_motion
            - automation.arbeitszimmer_motion
          data:
            stop_actions: true
        # 30-Minute Gradual Wake-Up Light Routine (Research-Backed)
        # Exponential brightness curve: 1% → 10% → 40% → 100%
        # Color temp curve: 2200K (warm) → 2700K → 3400K → 4000K (cool)
        - alias: "Phase 1: Initial light at 1% (sehr warm, 2200K)"
          action: light.turn_on
          target:
            entity_id:
            - light.alle_schlafzimmer_lichter
            - light.alle_kinderzimmer_lichter
            - light.alle_wohnzimmer_lichter
            - light.alle_arbeitszimmer_lichter
          data:
            brightness_pct: 1
            color_temp_kelvin: 2200
        - alias: "Warte 10 Minuten (Augen passen sich an)"
          delay: 00:10:00
        - alias: "Phase 2: Erhöhe auf 10% Helligkeit (warm, 2700K)"
          action: light.turn_on
          target:
            entity_id:
            - light.alle_schlafzimmer_lichter
            - light.alle_kinderzimmer_lichter
            - light.alle_wohnzimmer_lichter
            - light.alle_arbeitszimmer_lichter
          data:
            brightness_pct: 10
            color_temp_kelvin: 2700
        - alias: "Warte 10 Minuten (langsame Anpassung)"
          delay: 00:10:00
        - alias: "Phase 3: Erhöhe auf 40% Helligkeit (neutral, 3400K)"
          action: light.turn_on
          target:
            entity_id:
            - light.alle_schlafzimmer_lichter
            - light.alle_kinderzimmer_lichter
            - light.alle_wohnzimmer_lichter
            - light.alle_arbeitszimmer_lichter
          data:
            brightness_pct: 40
            color_temp_kelvin: 3400
        - alias: "Warte 10 Minuten (fortgesetzte Anpassung)"
          delay: 00:10:00
        - alias: "Phase 4: Volle Helligkeit (100%, kühl, 4000K)"
          action: light.turn_on
          target:
            entity_id:
            - light.alle_schlafzimmer_lichter
            - light.alle_kinderzimmer_lichter
            - light.alle_wohnzimmer_lichter
            - light.alle_arbeitszimmer_lichter
          data:
            brightness_pct: 100
            color_temp_kelvin: 4000
        - alias: "Warte bis 8:00 Uhr (Motion-Sensoren bleiben deaktiviert)"
          delay:
            seconds: >-
              {% set target_time = today_at('08:00:00') %}
              {% set now_time = now() %}
              {% if now_time < target_time %}
                {{ (target_time - now_time).total_seconds() | int }}
              {% else %}
                0
              {% endif %}
        - alias: Motion-Automationen wieder aktivieren (nach Wake-Up-Routine)
          action: automation.turn_on
          target:
            entity_id:
            - automation.motion_schlafzimmer
            - automation.kinderzimmer_motion
            - automation.arbeitszimmer_motion
        - alias: Adaptive Beleuchtung wieder aktivieren
          action: switch.turn_on
          target:
            entity_id:
            - switch.adaptive_lighting_arbeitszimmer
            - switch.adaptive_lighting_kinderzimmer
            - switch.adaptive_lighting_schlafzimmer
            - switch.adaptive_lighting_wohnzimmer
    - alias: Sonnenaufgang - Schlafenszeit beenden
      conditions:
      - condition: trigger
        id: sun
      sequence:
      - alias: Schlafenszeit automatisch beenden bei Sonnenaufgang
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.schlafenszeit
      - alias: Sleep Mode für alle Räume deaktivieren bei Sonnenaufgang
        action: switch.turn_off
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_badezimmer
          - switch.adaptive_lighting_sleep_mode_balkon
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_kueche
          - switch.adaptive_lighting_sleep_mode_waschzimmer
          - switch.adaptive_lighting_sleep_mode_wohnzimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
    - alias: Einschlafzeit - Schlafmodus aktivieren
      conditions:
      - condition: trigger
        id: einschlafzeit
      sequence:
      - alias: Schlafenszeit aktivieren
        action: input_boolean.turn_on
        target:
          entity_id: input_boolean.schlafenszeit
      - alias: Automation-Zeitfenster auf nächste Dämmerung setzen
        action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.automation_lauft_nicht_vor
        data:
          timestamp: '{{ (state_attr(''sun.sun'', ''next_dusk'')|as_datetime).timestamp()
            }}'
      - alias: Automation-Zeitfenster auf nächste Morgendämmerung setzen
        action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.automation_lauft_erst_ab
        data:
          timestamp: '{{ (state_attr(''sun.sun'', ''next_dawn'')|as_datetime).timestamp()
            }}'
      - alias: Klimaanlage auf Schlafmodus (wenn verfügbar)
        if:
        - alias: Klimaanlage ist verfügbar
          condition: not
          conditions:
          - condition: state
            entity_id: climate.ac
            state: unavailable
        then:
        - action: climate.set_preset_mode
          target:
            entity_id: climate.ac
          data:
            preset_mode: sleep
    - alias: Frühe Schlafenszeit - Sleep Mode für wichtige Räume
      conditions:
      - condition: trigger
        id: early-schlafenszeit
      sequence:
      - alias: Sleep Mode für Haupträume aktivieren
        action: switch.turn_on
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
    - alias: 22:00 Uhr - Kompletter Nachtmodus
      conditions:
      - condition: trigger
        id: schlafenszeit
      sequence:
      - alias: Sleep Mode für alle Räume aktivieren
        action: switch.turn_on
        target:
          entity_id:
          - switch.adaptive_lighting_sleep_mode_badezimmer
          - switch.adaptive_lighting_sleep_mode_balkon
          - switch.adaptive_lighting_sleep_mode_flur
          - switch.adaptive_lighting_sleep_mode_kueche
          - switch.adaptive_lighting_sleep_mode_waschzimmer
          - switch.adaptive_lighting_sleep_mode_wohnzimmer
          - switch.adaptive_lighting_sleep_mode_kinderzimmer
          - switch.adaptive_lighting_sleep_mode_arbeitszimmer
          - switch.adaptive_lighting_sleep_mode_schlafzimmer
      - alias: Hauptlichter in Schlaf-/Kinderzimmern ausschalten
        action: light.turn_off
        target:
          entity_id:
          - light.alle_kinderzimmer_lichter
          - light.alle_schlafzimmer_lichter
          - light.alle_arbeitszimmer_lichter
  mode: queued
  max: 10
- id: es_ist_dunkel_toggle
  alias: Helper » Dunkel – an/aus je nach Sonnenstand
  description: Schaltet den Boolean ein bei Sonnenuntergang und aus bei Sonnenaufgang.
  triggers:
  - event: sunset
    id: sunset
    trigger: sun
    offset: 00:30:00
  - event: sunrise
    id: sunrise
    trigger: sun
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: sunset
      sequence:
      - target:
          entity_id: input_boolean.es_ist_dunkel
        action: input_boolean.turn_on
        data: {}
    - conditions:
      - condition: trigger
        id: sunrise
      sequence:
      - target:
          entity_id: input_boolean.es_ist_dunkel
        action: input_boolean.turn_off
        data: {}
  mode: single
