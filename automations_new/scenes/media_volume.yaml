# Scenes - Media Volume.yaml
# Scene-based HomePod volume control
# Part of Home Assistant configuration

- id: 'scene_homepod_volume_control'
  alias: 'Scenen » HomePod Lautstärke'
  description: >
    Passt die HomePod-Lautstärke basierend auf aktiven Szenen an.
    Szenen überschreiben Schlafenszeit; bei Szenenende während Schlafenszeit
    wird die Wiedergabe gestoppt und Volume auf 15% gesetzt.
  triggers:
    - trigger: state
      entity_id: input_boolean.schlafenszeit
      to: 'on'
      id: schlafenszeit-an
    - trigger: state
      entity_id: input_boolean.schlafenszeit
      to: 'off'
      id: schlafenszeit-aus
    - trigger: state
      entity_id: input_boolean.kochen
      to: 'on'
      id: kochen-an
    - trigger: state
      entity_id: input_boolean.kochen
      to: 'off'
      id: kochen-aus
    - trigger: state
      entity_id: input_boolean.essen
      to: 'on'
      id: essen-an
    - trigger: state
      entity_id: input_boolean.essen
      to: 'off'
      id: essen-aus
    - trigger: state
      entity_id: input_boolean.baden
      to: 'on'
      id: baden-an
    - trigger: state
      entity_id: input_boolean.baden
      to: 'off'
      id: baden-aus
    - trigger: state
      entity_id: input_boolean.sauna
      to: 'on'
      id: sauna-an
    - trigger: state
      entity_id: input_boolean.sauna
      to: 'off'
      id: sauna-aus
    - trigger: state
      entity_id: input_boolean.party_wohnzimmer
      to: 'on'
      id: party-wz-an
    - trigger: state
      entity_id: input_boolean.party_wohnzimmer
      to: 'off'
      id: party-wz-aus
    - trigger: state
      entity_id: input_boolean.arbeit
      to: 'on'
      id: arbeit-an
    - trigger: state
      entity_id: input_boolean.arbeit
      to: 'off'
      id: arbeit-aus
    - trigger: state
      entity_id: input_boolean.party
      to: 'on'
      id: party-an
    - trigger: state
      entity_id: input_boolean.party
      to: 'off'
      id: party-aus
  conditions: []
  actions:
    - choose:
        # =======================================================
        # SCHLAFENSZEIT AN — All HomePods fade to 15%
        # =======================================================
        - conditions:
            - condition: trigger
              id: schlafenszeit-an
          sequence:
            - action: script.fade_volume
              data:
                target_player: media_player.homepods
                target_volume: 0.15
                duration: 60
                curve: linear

        # =======================================================
        # SCHLAFENSZEIT AUS — Fade back to 35% (if no scene active)
        # =======================================================
        - conditions:
            - condition: trigger
              id: schlafenszeit-aus
          sequence:
            - condition: template
              value_template: >
                {{ not (is_state('input_boolean.kochen', 'on') or
                        is_state('input_boolean.essen', 'on') or
                        is_state('input_boolean.baden', 'on') or
                        is_state('input_boolean.sauna', 'on') or
                        is_state('input_boolean.party_wohnzimmer', 'on') or
                        is_state('input_boolean.party', 'on')) }}
            - action: script.fade_volume
              data:
                target_player: media_player.homepods
                target_volume: 0.35
                duration: 60
                curve: linear

        # =======================================================
        # KOCHEN AN — Küche to 35%
        # =======================================================
        - conditions:
            - condition: trigger
              id: kochen-an
          sequence:
            - condition: template
              value_template: >
                {{ states('media_player.homepod_kueche') in ['playing', 'paused'] }}
            - if:
                - condition: template
                  value_template: >
                    {{ not (is_state('input_boolean.party', 'on') or
                            is_state('input_boolean.party_wohnzimmer', 'on')) }}
              then:
                - action: input_number.set_value
                  target:
                    entity_id: input_number.saved_volume_kueche
                  data:
                    value: >
                      {{ state_attr('media_player.homepod_kueche', 'volume_level') | float(0.35) }}
            - action: media_player.volume_set
              target:
                entity_id: media_player.homepod_kueche
              data:
                volume_level: 0.35

        # =======================================================
        # KOCHEN AUS — Restore Küche
        # =======================================================
        - conditions:
            - condition: trigger
              id: kochen-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kueche
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id: media_player.homepod_kueche
              else:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kueche
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') or
                            is_state('input_boolean.party_wohnzimmer', 'on') %}
                        0.50
                      {% else %}
                        {{ states('input_number.saved_volume_kueche') | float(0.35) }}
                      {% endif %}

        # =======================================================
        # ESSEN AN — Wohnzimmer to 25%
        # =======================================================
        - conditions:
            - condition: trigger
              id: essen-an
          sequence:
            - condition: template
              value_template: >
                {{ states('media_player.homepod_wohnzimmer') in ['playing', 'paused'] }}
            - if:
                - condition: template
                  value_template: >
                    {{ not (is_state('input_boolean.party', 'on') or
                            is_state('input_boolean.party_wohnzimmer', 'on')) }}
              then:
                - action: input_number.set_value
                  target:
                    entity_id: input_number.saved_volume_wohnzimmer
                  data:
                    value: >
                      {{ state_attr('media_player.homepod_wohnzimmer', 'volume_level') | float(0.35) }}
            - action: media_player.volume_set
              target:
                entity_id: media_player.homepod_wohnzimmer
              data:
                volume_level: 0.25

        # =======================================================
        # ESSEN AUS — Restore Wohnzimmer
        # =======================================================
        - conditions:
            - condition: trigger
              id: essen-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_wohnzimmer
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id: media_player.homepod_wohnzimmer
              else:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_wohnzimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') or
                            is_state('input_boolean.party_wohnzimmer', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.essen', 'on') %}
                        0.25
                      {% else %}
                        {{ states('input_number.saved_volume_wohnzimmer') | float(0.35) }}
                      {% endif %}

        # =======================================================
        # BADEN AN — Badezimmer to 35%
        # =======================================================
        - conditions:
            - condition: trigger
              id: baden-an
          sequence:
            - condition: template
              value_template: >
                {{ states('media_player.homepod_badezimmer') in ['playing', 'paused'] }}
            - if:
                - condition: template
                  value_template: >
                    {{ not (is_state('input_boolean.party', 'on') or
                            is_state('input_boolean.sauna', 'on')) }}
              then:
                - action: input_number.set_value
                  target:
                    entity_id: input_number.saved_volume_badezimmer
                  data:
                    value: >
                      {{ state_attr('media_player.homepod_badezimmer', 'volume_level') | float(0.35) }}
            - action: media_player.volume_set
              target:
                entity_id: media_player.homepod_badezimmer
              data:
                volume_level: 0.35

        # =======================================================
        # BADEN AUS — Restore Badezimmer
        # =======================================================
        - conditions:
            - condition: trigger
              id: baden-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_badezimmer
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id: media_player.homepod_badezimmer
              else:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_badezimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.sauna', 'on') %}
                        0.25
                      {% else %}
                        {{ states('input_number.saved_volume_badezimmer') | float(0.35) }}
                      {% endif %}

        # =======================================================
        # SAUNA AN — Badezimmer to 25%
        # =======================================================
        - conditions:
            - condition: trigger
              id: sauna-an
          sequence:
            - condition: template
              value_template: >
                {{ states('media_player.homepod_badezimmer') in ['playing', 'paused'] }}
            - if:
                - condition: template
                  value_template: >
                    {{ not (is_state('input_boolean.party', 'on') or
                            is_state('input_boolean.baden', 'on')) }}
              then:
                - action: input_number.set_value
                  target:
                    entity_id: input_number.saved_volume_badezimmer
                  data:
                    value: >
                      {{ state_attr('media_player.homepod_badezimmer', 'volume_level') | float(0.35) }}
            - action: media_player.volume_set
              target:
                entity_id: media_player.homepod_badezimmer
              data:
                volume_level: 0.25

        # =======================================================
        # SAUNA AUS — Restore Badezimmer
        # =======================================================
        - conditions:
            - condition: trigger
              id: sauna-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_badezimmer
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id: media_player.homepod_badezimmer
              else:
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_badezimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.baden', 'on') %}
                        0.35
                      {% else %}
                        {{ states('input_number.saved_volume_badezimmer') | float(0.35) }}
                      {% endif %}

        # =======================================================
        # ARBEIT AN — Arbeitszimmer (Stereopaar) to 25%
        # =======================================================
        - conditions:
            - condition: trigger
              id: arbeit-an
          sequence:
            - condition: template
              value_template: >
                {{ states('media_player.homepod_arbeitszimmer') in ['playing', 'paused'] }}
            - if:
                - condition: template
                  value_template: >
                    {{ not is_state('input_boolean.party', 'on') }}
              then:
                - action: input_number.set_value
                  target:
                    entity_id: input_number.saved_volume_arbeitszimmer
                  data:
                    value: >
                      {{ state_attr('media_player.homepod_arbeitszimmer', 'volume_level') | float(0.35) }}
            - action: media_player.volume_set
              target:
                entity_id:
                  - media_player.homepod_arbeitszimmer
                  - media_player.arbeitszimmer_2
              data:
                volume_level: 0.25

        # =======================================================
        # ARBEIT AUS — Restore Arbeitszimmer
        # =======================================================
        - conditions:
            - condition: trigger
              id: arbeit-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id:
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id:
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
              else:
                - action: media_player.volume_set
                  target:
                    entity_id:
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') %}
                        0.50
                      {% else %}
                        {{ states('input_number.saved_volume_arbeitszimmer') | float(0.35) }}
                      {% endif %}

        # =======================================================
        # PARTY WZ AN — WZ + Küche to 50%
        # =======================================================
        - conditions:
            - condition: trigger
              id: party-wz-an
          sequence:
            # Wohnzimmer
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_wohnzimmer') in ['playing', 'paused'] }}
              then:
                - if:
                    - condition: template
                      value_template: >
                        {{ not is_state('input_boolean.essen', 'on') }}
                  then:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.saved_volume_wohnzimmer
                      data:
                        value: >
                          {{ state_attr('media_player.homepod_wohnzimmer', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_wohnzimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.essen', 'on') %}
                        0.25
                      {% else %}
                        0.50
                      {% endif %}
            # Küche
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_kueche') in ['playing', 'paused'] }}
              then:
                - if:
                    - condition: template
                      value_template: >
                        {{ not is_state('input_boolean.kochen', 'on') }}
                  then:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.saved_volume_kueche
                      data:
                        value: >
                          {{ state_attr('media_player.homepod_kueche', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kueche
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.kochen', 'on') %}
                        0.35
                      {% else %}
                        0.50
                      {% endif %}

        # =======================================================
        # PARTY WZ AUS — Restore WZ + Küche
        # =======================================================
        - conditions:
            - condition: trigger
              id: party-wz-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id:
                      - media_player.homepod_wohnzimmer
                      - media_player.homepod_kueche
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id:
                      - media_player.homepod_wohnzimmer
                      - media_player.homepod_kueche
              else:
                # Wohnzimmer
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_wohnzimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.essen', 'on') %}
                        0.25
                      {% else %}
                        {{ states('input_number.saved_volume_wohnzimmer') | float(0.35) }}
                      {% endif %}
                # Küche
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kueche
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.kochen', 'on') %}
                        0.35
                      {% else %}
                        {{ states('input_number.saved_volume_kueche') | float(0.35) }}
                      {% endif %}

        # =======================================================
        # PARTY AN — All 6 HomePods to 50%
        # =======================================================
        - conditions:
            - condition: trigger
              id: party-an
          sequence:
            # Wohnzimmer
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_wohnzimmer') in ['playing', 'paused'] }}
              then:
                - if:
                    - condition: template
                      value_template: >
                        {{ not (is_state('input_boolean.essen', 'on') or
                                is_state('input_boolean.party_wohnzimmer', 'on')) }}
                  then:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.saved_volume_wohnzimmer
                      data:
                        value: >
                          {{ state_attr('media_player.homepod_wohnzimmer', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_wohnzimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.essen', 'on') %}
                        0.25
                      {% else %}
                        0.50
                      {% endif %}
            # Küche
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_kueche') in ['playing', 'paused'] }}
              then:
                - if:
                    - condition: template
                      value_template: >
                        {{ not (is_state('input_boolean.kochen', 'on') or
                                is_state('input_boolean.party_wohnzimmer', 'on')) }}
                  then:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.saved_volume_kueche
                      data:
                        value: >
                          {{ state_attr('media_player.homepod_kueche', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kueche
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.kochen', 'on') %}
                        0.35
                      {% else %}
                        0.50
                      {% endif %}
            # Badezimmer
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_badezimmer') in ['playing', 'paused'] }}
              then:
                - if:
                    - condition: template
                      value_template: >
                        {{ not (is_state('input_boolean.baden', 'on') or
                                is_state('input_boolean.sauna', 'on')) }}
                  then:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.saved_volume_badezimmer
                      data:
                        value: >
                          {{ state_attr('media_player.homepod_badezimmer', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_badezimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.sauna', 'on') %}
                        0.25
                      {% elif is_state('input_boolean.baden', 'on') %}
                        0.35
                      {% else %}
                        0.50
                      {% endif %}
            # Kinderzimmer
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_kinderzimmer') in ['playing', 'paused'] }}
              then:
                - action: input_number.set_value
                  target:
                    entity_id: input_number.saved_volume_kinderzimmer
                  data:
                    value: >
                      {{ state_attr('media_player.homepod_kinderzimmer', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kinderzimmer
                  data:
                    volume_level: 0.50
            # Arbeitszimmer (Stereopaar)
            - if:
                - condition: template
                  value_template: >
                    {{ states('media_player.homepod_arbeitszimmer') in ['playing', 'paused'] }}
              then:
                - if:
                    - condition: template
                      value_template: >
                        {{ not is_state('input_boolean.arbeit', 'on') }}
                  then:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.saved_volume_arbeitszimmer
                      data:
                        value: >
                          {{ state_attr('media_player.homepod_arbeitszimmer', 'volume_level') | float(0.35) }}
                - action: media_player.volume_set
                  target:
                    entity_id:
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.arbeit', 'on') %}
                        0.25
                      {% else %}
                        0.50
                      {% endif %}

        # =======================================================
        # PARTY AUS — Restore all 6 HomePods
        # =======================================================
        - conditions:
            - condition: trigger
              id: party-aus
          sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.schlafenszeit
                  state: 'on'
              then:
                - action: media_player.volume_set
                  target:
                    entity_id:
                      - media_player.homepod_wohnzimmer
                      - media_player.homepod_kueche
                      - media_player.homepod_badezimmer
                      - media_player.homepod_kinderzimmer
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
                  data:
                    volume_level: 0.15
                - action: media_player.media_stop
                  target:
                    entity_id:
                      - media_player.homepod_wohnzimmer
                      - media_player.homepod_kueche
                      - media_player.homepod_badezimmer
                      - media_player.homepod_kinderzimmer
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
              else:
                # Wohnzimmer
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_wohnzimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party_wohnzimmer', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.essen', 'on') %}
                        0.25
                      {% else %}
                        {{ states('input_number.saved_volume_wohnzimmer') | float(0.35) }}
                      {% endif %}
                # Küche
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kueche
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.party_wohnzimmer', 'on') %}
                        0.50
                      {% elif is_state('input_boolean.kochen', 'on') %}
                        0.35
                      {% else %}
                        {{ states('input_number.saved_volume_kueche') | float(0.35) }}
                      {% endif %}
                # Badezimmer
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_badezimmer
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.baden', 'on') %}
                        0.35
                      {% elif is_state('input_boolean.sauna', 'on') %}
                        0.25
                      {% else %}
                        {{ states('input_number.saved_volume_badezimmer') | float(0.35) }}
                      {% endif %}
                # Kinderzimmer
                - action: media_player.volume_set
                  target:
                    entity_id: media_player.homepod_kinderzimmer
                  data:
                    volume_level: >
                      {{ states('input_number.saved_volume_kinderzimmer') | float(0.35) }}
                # Arbeitszimmer (Stereopaar)
                - action: media_player.volume_set
                  target:
                    entity_id:
                      - media_player.homepod_arbeitszimmer
                      - media_player.arbeitszimmer_2
                  data:
                    volume_level: >
                      {% if is_state('input_boolean.arbeit', 'on') %}
                        0.25
                      {% else %}
                        {{ states('input_number.saved_volume_arbeitszimmer') | float(0.35) }}
                      {% endif %}
  mode: queued
  max: 4
