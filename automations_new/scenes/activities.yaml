# Scenes - Activities.Yaml
# Generated by automation splitter - 3 automations
# Part of Home Assistant configuration

- id: '1722519061740'
  alias: Scenen » Gäste
  description: Deaktiviert bestimmte Automationen im Gästemodus für mehr Privatsphäre
  triggers:
  - entity_id: input_boolean.guest_or_away
    to: 'on'
    for:
      minutes: 1
    id: gäste-an
    trigger: state
  - entity_id: input_boolean.guest_or_away
    to: 'off'
    for:
      minutes: 1
    id: gäste-aus
    trigger: state
  - event_type: timer.finished
    event_data:
      entity_id: timer.lock_door_after_guest
    id: timer-abgelaufen
    trigger: event
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: gäste-an
      sequence:
      - action: automation.turn_off
        target:
          entity_id:
          - automation.helper_workday_musik  # Helper » Workday Musik - Automatic workday music
        data: {}
      - target:
          entity_id:
          - switch.wohnzimmer_steckdose
          - switch.kuchengerate
        action: switch.turn_on
    - conditions:
      - condition: trigger
        id: gäste-aus
      sequence:
      - target:
          entity_id:
          - automation.helper_workday_musik  # Helper » Workday Musik - Automatic workday music
        action: automation.turn_on
      - target:
          entity_id:
          - switch.wohnzimmer_steckdose
          - switch.kuchengerate
        action: switch.turn_off
    - conditions:
      - condition: trigger
        id: timer-abgelaufen
      - condition: state
        entity_id: lock.smart_lock_pro
        state: unlocked
      - condition: template
        value_template: "{{ has_value('lock.smart_lock_pro') }}"
      - condition: state
        entity_id: input_boolean.alle_sind_weg
        state: 'on'
      - condition: template
        value_template: "{{ has_value('input_boolean.alle_sind_weg') }}"
      sequence:
      - target:
          entity_id: lock.smart_lock_pro
        action: lock.lock
      - action: logbook.log
        data:
          name: Tür automatisch verschlossen
          message: Nach Ablauf des Timers automatisch verschlossen
          domain: automation
  mode: single
- id: '1737546608146'
  alias: Scenen » Party
  description: Aktiviert Party-Modus in allen Räumen mit dynamischer Beleuchtung und
    deaktivierten Bewegungsmeldern
  triggers:
  - entity_id:
    - input_boolean.party
    to: 'on'
    id: 'on'
    trigger: state
  - entity_id:
    - input_boolean.party
    to: 'off'
    id: 'off'
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: 'on'
      sequence:
      # 1. Disable motion automations FIRST (stop new triggers)
      - alias: "Disable motion automations"
        action: automation.turn_off
        target:
          entity_id:
          - automation.motion_kuche_2  # Kitchen motion
          - automation.motion_flur_wohnung  # Hallway motion
          - automation.arbeitszimmer_motion  # Office motion
          - automation.motion_schlafzimmer  # Bedroom motion
          - automation.motion_badezimmer_gross  # Bathroom motion
          - automation.kinderzimmer_motion  # Kids room motion
          - automation.motion_haustur  # Front door motion
          - automation.motion_spieletisch  # Game table motion
      - alias: "Deaktiviere Esstisch-Motion wenn nicht gegessen wird"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.essen
            state: 'off'
          sequence:
          - action: automation.turn_off
            target:
              entity_id: automation.motion_esstisch
      # 2. Mark white-only lights as manual control (prevents AL from touching them)
      # Note: Must call separately per switch - can't pass multiple switches with lights
      - alias: "Mark Wohnzimmer white lights as manual"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_wohnzimmer
          lights:
          - light.wohnzimmer_wand_1
          - light.wohnzimmer_wand_2
          - light.wohnzimmer_wand_3
          - light.wohnzimmer_wand_4
          - light.wohnzimmer_wand_5
          - light.wohnzimmer_wand_6
          - light.wohnzimmer_esstisch_2
          - light.wohnzimmer_esstisch_3
          manual_control: true
      - alias: "Mark Küche white lights as manual"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_kueche
          lights:
          - light.kuche_decke_1
          - light.kuche_decke_2
          manual_control: true
      - alias: "Mark Flur white lights as manual"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_flur
          lights:
          - light.flur_decke_1
          - light.flur_decke_2
          - light.flur_decke_3
          - light.flur_decke_4
          - light.flur_decke_5
          - light.flur_decke_6
          manual_control: true
      - alias: "Mark Schlafzimmer white lights as manual"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_schlafzimmer
          lights:
          - light.schlafzimmer_decke_1
          - light.schlafzimmer_decke_2
          - light.schlafzimmer_tv
          manual_control: true
      - alias: "Mark Ankleide white lights as manual"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_ankleide
          lights:
          - light.ankleide_decke_1
          - light.ankleide_decke_2
          manual_control: true
      - alias: "Mark Kinderzimmer white lights as manual"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_kinderzimmer
          lights:
          - light.kinderzimmer_decke
          manual_control: true
      # 3. Disable AL switches (prevents any adaptation)
      - alias: "Disable adaptive lighting"
        action: switch.turn_off
        target:
          entity_id:
          - switch.adaptive_lighting_wohnzimmer
          - switch.adaptive_lighting_kueche
          - switch.adaptive_lighting_badezimmer
          - switch.adaptive_lighting_kinderzimmer
          - switch.adaptive_lighting_arbeitszimmer
          - switch.adaptive_lighting_flur
          - switch.adaptive_lighting_schlafzimmer
          - switch.adaptive_lighting_waschzimmer
          - switch.adaptive_lighting_balkon
      # 4. Wait for in-flight commands to complete
      - alias: "Wait for in-flight commands"
        delay:
          milliseconds: 500
      # 5. Turn off ALL lights (clean slate)
      - alias: "Turn off all lights"
        action: light.turn_off
        data:
          transition: 5
        target:
          entity_id:
          - light.alle_wohnzimmer_lichter
          - light.alle_kuche_lichter
          - light.alle_flur_lichter
          - light.alle_schlafzimmer_lichter
          - light.alle_ankleide_lichter
          - light.alle_badezimmer_lichter
          - light.alle_kinderzimmer_lichter
      - alias: "Leselicht wiederherstellen falls aktiv"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.leselicht
            state: 'on'
          sequence:
          - delay:
              milliseconds: 500
          - action: light.turn_on
            target:
              entity_id: light.wohnzimmer_wand_2
            data:
              brightness_pct: 100
              color_temp_kelvin: 4000
      # 6. Start dynamic scene on RGB lights ONLY
      - alias: "Start dynamic scene on RGB lights only"
        action: scene_presets.start_dynamic_scene
        data:
          preset_id: 9565033d-f2ea-4821-bfba-7dd9b35be20a
          targets:
            entity_id:
            - light.alle_wohnzimmer_rgb_lichter
            - light.alle_kuche_rgb_lichter
            - light.alle_flur_rgb_lichter
            - light.alle_schlafzimmer_rgb_lichter
            - light.alle_badezimmer_rgb_lichter
            - light.alle_kinderzimmer_rgb_lichter
          transition: 45
          interval: 60
    - conditions:
      - condition: trigger
        id: 'off'
      sequence:
      - alias: "Stop dynamic scene for all party lights"
        action: scene_presets.stop_dynamic_scenes_for_targets
        data:
          targets:
            entity_id:
            - light.alle_wohnzimmer_rgb_lichter
            - light.alle_kuche_rgb_lichter
            - light.alle_flur_rgb_lichter
            - light.alle_schlafzimmer_rgb_lichter
            - light.alle_badezimmer_rgb_lichter
            - light.alle_kinderzimmer_rgb_lichter
      - alias: "Turn off all party lights"
        action: light.turn_off
        data:
          transition: 5
        target:
          entity_id:
          - light.alle_wohnzimmer_lichter
          - light.alle_kuche_lichter
          - light.alle_flur_lichter
          - light.alle_schlafzimmer_lichter
          - light.alle_ankleide_lichter
          - light.alle_badezimmer_lichter
          - light.alle_kinderzimmer_lichter
      - delay:
          seconds: 6
      # Clear manual control flags before re-enabling AL
      # Note: Must call separately per switch - can't pass multiple switches with lights
      - alias: "Clear Wohnzimmer manual control"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_wohnzimmer
          lights:
          - light.wohnzimmer_wand_1
          - light.wohnzimmer_wand_2
          - light.wohnzimmer_wand_3
          - light.wohnzimmer_wand_4
          - light.wohnzimmer_wand_5
          - light.wohnzimmer_wand_6
          - light.wohnzimmer_esstisch_2
          - light.wohnzimmer_esstisch_3
          manual_control: false
      - alias: "Clear Küche manual control"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_kueche
          lights:
          - light.kuche_decke_1
          - light.kuche_decke_2
          manual_control: false
      - alias: "Clear Flur manual control"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_flur
          lights:
          - light.flur_decke_1
          - light.flur_decke_2
          - light.flur_decke_3
          - light.flur_decke_4
          - light.flur_decke_5
          - light.flur_decke_6
          manual_control: false
      - alias: "Clear Schlafzimmer manual control"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_schlafzimmer
          lights:
          - light.schlafzimmer_decke_1
          - light.schlafzimmer_decke_2
          - light.schlafzimmer_tv
          manual_control: false
      - alias: "Clear Ankleide manual control"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_ankleide
          lights:
          - light.ankleide_decke_1
          - light.ankleide_decke_2
          manual_control: false
      - alias: "Clear Kinderzimmer manual control"
        action: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_kinderzimmer
          lights:
          - light.kinderzimmer_decke
          manual_control: false
      - alias: "Re-enable living room adaptive lighting if party_wohnzimmer is off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.party_wohnzimmer
            state: 'off'
          - condition: state
            entity_id: input_boolean.movie
            state: 'off'
          sequence:
          - action: switch.turn_on
            target:
              entity_id: switch.adaptive_lighting_wohnzimmer
      - alias: "Re-enable kitchen adaptive lighting if cooking/movie/party_wohnzimmer off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.kochen
            state: 'off'
          - condition: state
            entity_id: input_boolean.movie
            state: 'off'
          - condition: state
            entity_id: input_boolean.party_wohnzimmer
            state: 'off'
          sequence:
          - action: switch.turn_on
            target:
              entity_id: switch.adaptive_lighting_kueche
      - alias: "Re-enable bathroom adaptive lighting if sauna/baden off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.sauna
            state: 'off'
          - condition: state
            entity_id: input_boolean.baden
            state: 'off'
          sequence:
          - action: switch.turn_on
            target:
              entity_id: switch.adaptive_lighting_badezimmer
      - alias: "Re-enable other room adaptive lighting unconditionally"
        action: switch.turn_on
        target:
          entity_id:
          - switch.adaptive_lighting_kinderzimmer
          - switch.adaptive_lighting_arbeitszimmer
          - switch.adaptive_lighting_flur
          - switch.adaptive_lighting_schlafzimmer
          - switch.adaptive_lighting_waschzimmer
          - switch.adaptive_lighting_balkon
      - alias: "Re-enable kitchen motion if no conflicting scenes"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.movie
            state: 'off'
          - condition: state
            entity_id: input_boolean.kochen
            state: 'off'
          - condition: state
            entity_id: input_boolean.essen
            state: 'off'
          - condition: state
            entity_id: input_boolean.party_wohnzimmer
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.motion_kuche_2  # Kitchen motion
      - alias: "Re-enable hallway motion if no conflicting scenes"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.movie
            state: 'off'
          - condition: state
            entity_id: input_boolean.party_wohnzimmer
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.motion_flur_wohnung  # Hallway motion
      - alias: "Re-enable office motion if work/gaming mode is off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.arbeit
            state: 'off'
          - condition: state
            entity_id: input_boolean.gaming
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.arbeitszimmer_motion  # Office motion
      - alias: "Re-enable dining table motion if eating/movie mode is off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.essen
            state: 'off'
          - condition: state
            entity_id: input_boolean.movie
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.motion_esstisch  # Dining table motion
      - alias: "Re-enable game table motion if movie is off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.movie
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.motion_spieletisch  # Game table motion
      - alias: "Re-enable bathroom motion if sauna/baden mode is off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.sauna
            state: 'off'
          - condition: state
            entity_id: input_boolean.baden
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.motion_badezimmer_gross  # Bathroom motion
      - alias: "Re-enable bedroom motion if gaming/schlafenszeit is off and no TV playing"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.gaming
            state: 'off'
          - condition: state
            entity_id: input_boolean.schlafenszeit
            state: 'off'
          - condition: not
            conditions:
            - condition: state
              entity_id: media_player.appletv
              state: 'playing'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.motion_schlafzimmer  # Bedroom motion
      - alias: "Re-enable kinderzimmer motion if schlafenszeit is off"
        choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.schlafenszeit
            state: 'off'
          sequence:
          - action: automation.turn_on
            target:
              entity_id: automation.kinderzimmer_motion  # Kids room motion
      - alias: "Re-enable front door motion"
        action: automation.turn_on
        target:
          entity_id: automation.motion_haustur  # Front door motion
    default: []
  mode: restart
# "Szene » Arbeit" removed - now handled by arbeitszimmer.yaml with blueprint bypass

# Guardian automation to prevent white-only lights from turning on during party mode
- id: 'party_white_light_guardian'
  alias: 'Party » Weisslicht Wächter'
  description: Schaltet Weiss-Lichter sofort aus wenn sie während Party eingeschaltet werden
  mode: queued
  max: 20
  triggers:
  - trigger: state
    entity_id:
    # Wohnzimmer
    - light.wohnzimmer_wand_1
    - light.wohnzimmer_wand_2
    - light.wohnzimmer_wand_3
    - light.wohnzimmer_wand_4
    - light.wohnzimmer_wand_5
    - light.wohnzimmer_wand_6
    # Küche
    - light.kuche_decke_1
    - light.kuche_decke_2
    # Flur
    - light.flur_decke_1
    - light.flur_decke_2
    - light.flur_decke_3
    - light.flur_decke_4
    - light.flur_decke_5
    - light.flur_decke_6
    # Schlafzimmer
    - light.schlafzimmer_decke_1
    - light.schlafzimmer_decke_2
    # Ankleide
    - light.ankleide_decke_1
    - light.ankleide_decke_2
    # Kinderzimmer
    - light.kinderzimmer_decke
    to: 'on'
  conditions:
  - condition: or
    conditions:
    - condition: state
      entity_id: input_boolean.party
      state: 'on'
    - condition: state
      entity_id: input_boolean.party_wohnzimmer
      state: 'on'
  - alias: "Leselicht nicht ausschalten"
    condition: template
    value_template: >
      {{ trigger.entity_id != 'light.wohnzimmer_wand_2' or
         is_state('input_boolean.leselicht', 'off') }}
  actions:
  - action: light.turn_off
    target:
      entity_id: "{{ trigger.entity_id }}"
    data:
      transition: 1
