---
# Helpers - Presence.Yaml
# Generated by automation splitter - 4 automations
# Part of Home Assistant configuration

- id: '1648113506269'
  alias: Helper ¬ª Alle sind weg
  description: Erkennt wenn niemand zu Hause ist basierend auf Standortdaten
  triggers:
  - entity_id: person.alex
    zone: zone.home
    event: leave
    trigger: zone
  - entity_id: person.rafael
    zone: zone.home
    event: leave
    trigger: zone
  conditions:
  - condition: not
    conditions:
    - condition: zone
      entity_id: person.alex
      zone: zone.home
  - condition: not
    conditions:
    - condition: zone
      entity_id: person.rafael
      zone: zone.home
  actions:
  - target:
      entity_id: input_boolean.alle_sind_weg
    action: input_boolean.turn_on
  mode: single
- id: '1648229228602'
  alias: Helper ¬ª Jemand kommt nachhause
  description: Setzt den 'Alle sind weg'-Status zur√ºck wenn jemand nach Hause kommt
  triggers:
  - entity_id: device_tracker.alex_iphone_alex
    to: home
    id: alex-da
    trigger: state
  - entity_id: device_tracker.iphone_rafael
    to: home
    id: rafael-da
    trigger: state
  conditions: []
  actions:
  - target:
      entity_id: input_boolean.alle_sind_weg
    action: input_boolean.turn_off
  mode: restart
- id: '1662914276095'
  alias: Helper ¬ª Better Presence
  description: 'Verwaltet detaillierte Anwesenheitsstatus (Gerade angekommen, Weg,
    L√§nger weg) f√ºr Personen

    '
  triggers:
  - entity_id:
    - person.rafael
    - person.alex
    from: not_home
    to: home
    id: Just Arrived
    variables:
      name: '{{ trigger.entity_id | replace(''person.'', '''') }}'
    trigger: state
  - entity_id:
    - input_select.status_rafael
    - input_select.status_alex
    to: Just Arrived
    for:
      minutes: 10
    id: Home
    variables:
      name: '{{ trigger.entity_id | replace(''input_select.status_'', '''') }}'
    trigger: state
  - entity_id:
    - person.rafael
    - person.alex
    from: home
    to: not_home
    id: Just Left
    variables:
      name: '{{ trigger.entity_id | replace(''person.'', '''') }}'
    trigger: state
  - entity_id:
    - input_select.status_rafael
    - input_select.status_alex
    to: Just Left
    for:
      minutes: 10
    id: Away
    variables:
      name: '{{ trigger.entity_id | replace(''input_select.status_'', '''') }}'
    trigger: state
  - entity_id:
    - input_select.status_rafael
    - input_select.status_alex
    to: Away
    for:
      hours: 24
    id: Extended Away
    variables:
      name: '{{ trigger.entity_id | replace(''input_select.status_'', '''') }}'
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: Just Arrived
      sequence:
      - choose:
        - conditions:
          - condition: or
            conditions:
            - condition: template
              value_template: '{{ is_state(''input_select.status_'' ~ name, ''Just
                Left'') }}

                '
            - condition: template
              value_template: '{{ is_state(''input_select.status_'' ~ name, ''Just
                Arrived'') }}

                '
          sequence:
          - data:
              option: home
            target:
              entity_id: '{{ ''input_select.status_'' ~ name }}'
            action: input_select.select_option
        default:
        - data:
            option: Just Arrived
          target:
            entity_id: '{{ ''input_select.status_'' ~ name }}'
          action: input_select.select_option
    - conditions:
      - condition: trigger
        id: Home
      sequence:
      - data:
          option: home
        target:
          entity_id: '{{ ''input_select.status_'' ~ name }}'
        action: input_select.select_option
    - conditions:
      - condition: trigger
        id: Just Left
      sequence:
      - data:
          option: Just Left
        target:
          entity_id: '{{ ''input_select.status_'' ~ name }}'
        action: input_select.select_option
    - conditions:
      - condition: trigger
        id: Away
      sequence:
      - data:
          option: Away
        target:
          entity_id: '{{ ''input_select.status_'' ~ name }}'
        action: input_select.select_option
    - conditions:
      - condition: trigger
        id: Extended Away
      sequence:
      - data:
          option: Extended Away
        target:
          entity_id: '{{ ''input_select.status_'' ~ name }}'
        action: input_select.select_option
  mode: parallel
- id: '1720627612083'
  alias: State ¬ª Anwesen- / Abwesenheit
  description: Verwaltet Anwesenheits-Status und zugeh√∂rige Aktionen
  triggers:
  - trigger: state
    entity_id:
    - input_boolean.alle_sind_weg
    to: 'on'
    for:
      hours: 0
      minutes: 15
      seconds: 0
    id: alle-weg-kurz
  - trigger: state
    entity_id: input_boolean.alle_sind_weg
    to: 'on'
    for: '24:00:00'
    id: alle-weg-lang
  - trigger: state
    entity_id: input_boolean.alle_sind_weg
    to: 'off'
    id: alle-da
  - trigger: state
    entity_id: lock.smart_lock_pro
    to: locked
    for: 00:15:00
    id: locked
  - trigger: state
    entity_id: lock.smart_lock_pro
    to: unlocked
    id: unlocked
  - trigger: time
    at: '22:00:00'
    id: nightmode_lock
  - trigger: state
    entity_id: timer.timer_fur_automatisches_turverschliessen
    from: active
    to: idle
    id: timer
  conditions: []
  actions:
  - choose:
    - alias: Warnung bei offenen Fenstern/T√ºren
      conditions:
      - condition: trigger
        id: alle-weg-kurz
      - alias: Kein Gast-Modus aktiv
        condition: state
        entity_id: input_boolean.guest_or_away
        state: 'off'
      - condition: template
        value_template: "{{ has_value('input_boolean.guest_or_away') }}"
      - alias: Fenster oder T√ºren sind offen
        condition: state
        entity_id: input_boolean.fenster_tueren_offen
        state: 'on'
      sequence:
      - alias: Log offene Fenster/T√ºren
        action: logbook.log
        data:
          name: Offene Fenster/T√ºren
          message: >-
            {% set doors = state_attr('binary_sensor.fenster_tueren', 'entity_id') %}
            {{ expand(doors) | selectattr('state','in',['on', 'open'])
            | map(attribute='name') | join(', ') | default('Alle geschlossen', true) }}
          domain: automation
    - alias: Alle weg (kurze Abwesenheit) - Energiesparmodus
      conditions:
      - condition: trigger
        id: alle-weg-kurz
      - alias: Kein Gast-Modus aktiv
        condition: state
        entity_id: input_boolean.guest_or_away
        state: 'off'
      - condition: template
        value_template: "{{ has_value('input_boolean.guest_or_away') }}"
      sequence:
      - alias: Alle eingeschalteten Lichter ausschalten
        choose:
        - conditions:
          - alias: Es sind Lichter an
            condition: template
            value_template: "{{ states.light | selectattr('state', 'eq', 'on') |\n\
              \   rejectattr('state', 'in', ['unavailable', 'unknown']) |\n   list\
              \ | count > 0 }}\n"
          sequence:
          - alias: Lichter ausschalten
            action: light.turn_off
            data:
              entity_id: "{{ states.light | selectattr('state', 'eq', 'on') |\n  \
                \ rejectattr('state', 'in', ['unavailable', 'unknown']) |\n   map(attribute='entity_id')\
                \ | join(', ') }}\n"
      - alias: Standard-Steckdosen ausschalten
        action: switch.turn_off
        target:
          entity_id:
          - switch.steckdose_avr
          - switch.wohnzimmer_steckdose
          - switch.flur_licht
          - switch.arbeitszimmer_steckdose
          - switch.steckdose_kuechengeraete
          - switch.steckdose_kinderzimmer
          - switch.schlafzimmer_tv_steckdose
          - switch.steckdose_arbeitszimmer
          - switch.steckdose_pc_alex
        data: {}
      - alias: Trockner ausschalten wenn im Aus-Zustand
        if:
        - condition: template
          value_template: '{{ has_value(''input_select.trockner'') and is_state(''input_select.trockner'', ''Aus'') }}'
        then:
        - action: switch.turn_off
          target:
            entity_id: switch.trockner
          data: {}
      - alias: Waschmaschine ausschalten wenn im Aus-Zustand
        if:
        - condition: template
          value_template: >-
            {{ has_value('input_select.waschmaschine')
            and is_state('input_select.waschmaschine', 'Aus') }}
        then:
        - action: switch.turn_off
          target:
            entity_id: switch.steckdose_waschmaschine
          data: {}
      - alias: Robbi starten wenn noch nicht gelaufen
        if:
        - condition: state
          entity_id: input_boolean.robbi_lief_heute_bereits
          state: 'off'
        - condition: template
          value_template: '{{ states(''vacuum.s7_maxv'') not in [''unknown'', ''unavailable'',
            ''cleaning'', ''returning''] }}

            '
        then:
        - action: vacuum.start
          target:
            entity_id: vacuum.s7_maxv
          data: {}
      - alias: HomePods stoppen
        action: media_player.media_stop
        target:
          entity_id:
          - media_player.homepod_wohnzimmer
          - media_player.homepod_kueche
          - media_player.homepod_badezimmer
          - media_player.homepod_kinderzimmer
          - media_player.arbeitszimmer
          - media_player.schlafzimmer
        data: {}
      - alias: T√ºre abschlie√üen wenn offen
        if:
        - condition: state
          entity_id: lock.smart_lock_pro
          state: unlocked
        - alias: Verifikation - Alle sind wirklich weg
          condition: and
          conditions:
          - condition: template
            value_template: "{{ has_value('person.rafael') and is_state('person.rafael', 'not_home') }}"
          - condition: template
            value_template: "{{ has_value('person.alex') and is_state('person.alex', 'not_home') }}"
        then:
        - alias: Benachrichtigung mit Abbruchm√∂glichkeit
          action: notify.family
          data:
            title: "üîê Automatische T√ºrverriegelung"
            message: "Die Haust√ºr wird in 30 Sekunden automatisch verriegelt, da alle das Haus verlassen haben."
            data:
              push:
                interruption-level: time-sensitive
        - alias: Wartezeit f√ºr manuellen Abbruch
          delay: 00:00:30
        - alias: Finale Pr√ºfung vor dem Abschlie√üen
          if:
          - condition: state
            entity_id: lock.smart_lock_pro
            state: unlocked
          - condition: template
            value_template: "{{ has_value('person.rafael') and is_state('person.rafael', 'not_home') }}"
          - condition: template
            value_template: "{{ has_value('person.alex') and is_state('person.alex', 'not_home') }}"
          then:
          - action: lock.lock
            target:
              entity_id: lock.smart_lock_pro
            data: {}
          - alias: Warte auf Verriegelungsbest√§tigung (max 30 Sek)
            wait_template: "{{ is_state('lock.smart_lock_pro', 'locked') }}"
            timeout: "00:00:30"
            continue_on_timeout: true
          - alias: Pr√ºfe ob Verriegelung erfolgreich war
            if:
            - condition: template
              value_template: "{{ not is_state('lock.smart_lock_pro', 'locked') }}"
            then:
            - action: notify.family
              data:
                title: "‚ö†Ô∏è T√ºrverriegelung fehlgeschlagen"
                message: "Die Haust√ºr konnte nicht automatisch verriegelt werden! Bitte manuell pr√ºfen."
                data:
                  push:
                    sound:
                      name: default
                      critical: 1
                    interruption-level: critical
            else:
            - alias: Log-Eintrag f√ºr erfolgreiche Verriegelung
              action: logbook.log
              data:
                name: "üîê Automatische T√ºrverriegelung"
                message: "Haust√ºr wurde automatisch verriegelt (alle Personen nicht zuhause)"
                domain: lock
      - alias: Klimaanlage ausschalten wenn an
        if:
        - condition: template
          value_template: "{{ has_value('climate.ac') and is_state('climate.ac', 'on') }}"
        then:
        - action: climate.turn_off
          target:
            entity_id: climate.ac
          data: {}
    - alias: Alle da - Willkommensmodus
      conditions:
      - condition: trigger
        id: alle-da
      sequence:
      - alias: T√ºre aufschlie√üen wenn abgeschlossen
        if:
        - condition: state
          entity_id: lock.smart_lock_pro
          state: locked
        then:
        - action: lock.unlock
          target:
            entity_id: lock.smart_lock_pro
          data: {}
      - alias: Werktag-Musik kurz aktivieren (Trigger f√ºr andere Automationen)
        action: input_boolean.turn_on
        target:
          entity_id: input_boolean.werktag_musik
        data: {}
      - delay: 00:00:05
      - alias: Werktag-Musik wieder deaktivieren
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.werktag_musik
        data: {}
      - delay: 00:01:00
      - alias: Wichtige Steckdosen wieder einschalten
        action: switch.turn_on
        target:
          entity_id:
          - switch.wohnzimmer_steckdose
          - switch.arbeitszimmer_steckdose
          - switch.kuchengerate
          - switch.steckdose_kinderzimmer
          - switch.schlafzimmer_tv_steckdose
          - switch.steckdose_arbeitszimmer
        data: {}
      - alias: Schlafenszeit aktivieren wenn bereits Schlafenszeit
        if:
        - condition: template
          value_template: >-
            {% set einschlafzeit = states('sensor.einschlafzeit_timestamp') %}
            {% if einschlafzeit not in ['unknown', 'unavailable', 'none'] %}
              {% set sleep_time = as_datetime(einschlafzeit) %}
              {% if sleep_time is not none %}
                {{ now() >= sleep_time }}
              {% else %}
                {{ now().hour >= 19 }}
              {% endif %}
            {% else %}
              {{ now().hour >= 19 }}
            {% endif %}
        then:
        - action: input_boolean.turn_on
          target:
            entity_id: input_boolean.schlafenszeit
          data: {}
    - alias: Alle weg (lange Abwesenheit) - Tiefschlafmodus
      conditions:
      - condition: trigger
        id: alle-weg-lang
      - alias: Kein Gast-Modus aktiv
        condition: state
        entity_id: input_boolean.guest_or_away
        state: 'off'
      - condition: template
        value_template: "{{ has_value('input_boolean.guest_or_away') }}"
      sequence:
      - alias: Alle Lichter ausschalten (nur wenn welche an sind)
        if:
        - condition: template
          value_template: "{{ states.light | selectattr('state','eq','on') | list | count > 0 }}"
        then:
        - action: light.turn_off
          target:
            entity_id: "{{ states.light | selectattr('state','eq','on') | map(attribute='entity_id') | list }}"
          data: {}
      - alias: Alle Steckdosen ausschalten (lang)
        action: switch.turn_off
        target:
          entity_id:
          - switch.steckdose_avr
          - switch.wohnzimmer_steckdose
          - switch.flur_licht
          - switch.arbeitszimmer_steckdose
          - switch.steckdose_kuechengeraete
          - switch.steckdose_waschmaschine
          - switch.trockner
          - switch.kuchengerate
          - switch.steckdose_kinderzimmer
          - switch.schlafzimmer_tv_steckdose
          - switch.steckdose_arbeitszimmer
          - switch.steckdose_pc_alex
        data: {}
      - alias: T√ºre abschlie√üen wenn offen
        if:
        - condition: state
          entity_id: lock.smart_lock_pro
          state: unlocked
        then:
        - action: lock.lock
          target:
            entity_id: lock.smart_lock_pro
          data: {}
        - alias: Warte auf Verriegelungsbest√§tigung (max 30 Sek)
          wait_template: "{{ is_state('lock.smart_lock_pro', 'locked') }}"
          timeout: "00:00:30"
          continue_on_timeout: true
        - alias: Benachrichtigung bei Fehler
          if:
          - condition: template
            value_template: "{{ not is_state('lock.smart_lock_pro', 'locked') }}"
          then:
          - action: notify.family
            data:
              title: "‚ö†Ô∏è T√ºrverriegelung fehlgeschlagen"
              message: "Die Haust√ºr konnte nicht automatisch verriegelt werden (lange Abwesenheit)!"
              data:
                push:
                  sound:
                    name: default
                    critical: 1
      - alias: Klimaanlage ausschalten wenn an
        if:
        - condition: template
          value_template: "{{ has_value('climate.ac') and is_state('climate.ac', 'on') }}"
        then:
        - action: climate.turn_off
          target:
            entity_id: climate.ac
          data: {}
    - alias: Timer abgelaufen - Gast-Modus beenden
      conditions:
      - condition: trigger
        id: timer
      sequence:
      - alias: Gast-Modus deaktivieren
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.guest_or_away
        data: {}
      - alias: T√ºre automatisch abschlie√üen
        action: lock.lock
        target:
          entity_id: lock.smart_lock_pro
        data: {}
      - alias: Warte auf Verriegelungsbest√§tigung (max 30 Sek)
        wait_template: "{{ is_state('lock.smart_lock_pro', 'locked') }}"
        timeout: "00:00:30"
        continue_on_timeout: true
      - alias: Benachrichtigung bei Fehler
        if:
        - condition: template
          value_template: "{{ not is_state('lock.smart_lock_pro', 'locked') }}"
        then:
        - action: notify.family
          data:
            title: "‚ö†Ô∏è T√ºrverriegelung fehlgeschlagen"
            message: "Die Haust√ºr konnte nicht automatisch verriegelt werden (nach Gast-Modus)!"
            data:
              push:
                sound:
                  name: default
                  critical: 1
  mode: single
  max_exceeded: silent
  variables:
    lock_timeout: 01:00:00
    guest_mode_timeout: '12:00:00'
    timestamp: '{{ now() }}'
- id: '1736456789001'
  alias: Helper ¬ª Alex PC Steckdose aus wenn weg
  description: Schaltet die PC-Steckdose von Alex aus wenn sie das Geb√§ude verl√§sst
  triggers:
  - entity_id: person.alex
    zone: zone.home
    event: leave
    trigger: zone
  conditions: []
  actions:
  - action: switch.turn_off
    target:
      entity_id: switch.steckdose_pc_alex
    data: {}
  mode: single
- id: '1736456789002'
  alias: Helper ¬ª Alex PC Steckdose an wenn zur√ºck
  description: Schaltet die PC-Steckdose von Alex ein wenn sie zur√ºck kommt
  triggers:
  - entity_id: person.alex
    zone: zone.home
    event: enter
    trigger: zone
  conditions: []
  actions:
  - action: switch.turn_on
    target:
      entity_id: switch.steckdose_pc_alex
    data: {}
  mode: single
