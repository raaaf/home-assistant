# Helpers - System.Yaml
# Generated by automation splitter - 3 automations
# Part of Home Assistant configuration

- id: '1662367427590'
  alias: Helper » After HA Restart
  description: Lädt Personeninformationen beim Neustart und aktualisiert MediaPlayer einmalig
  triggers:
  - event: start
    trigger: homeassistant
  conditions: []
  actions:
  - action: person.reload
  - target:
      entity_id:
      - media_player.appletv
      - media_player.wohnzimmer
      - media_player.denon_avr_x3200w
      - media_player.homepod_arbeitszimmer
      - media_player.arbeitszimmer_2
      - media_player.homepod_badezimmer
      - media_player.homepod_kinderzimmer
      - media_player.homepod_wohnzimmer
      - media_player.homepod_kueche
      - media_player.smarttv_4k
    action: homeassistant.update_entity
  mode: single
- id: '1744630508158'
  alias: Helper » Media Player nur wenn inaktiv aktualisieren
  description: 'Führt stündlich zwischen 06:00 und 22:00 Uhr ein Update für
    alle media_player-Entitäten durch, aber nur wenn sie nicht aktiv sind.

    '
  triggers:
  - hours: /1
    minutes: 0
    trigger: time_pattern
  conditions:
  - condition: time
    after: 06:00:00
    before: '22:00:00'
  variables:
    media_players:
      - media_player.appletv
      - media_player.wohnzimmer
      - media_player.denon_avr_x3200w
      - media_player.homepod_arbeitszimmer
      - media_player.arbeitszimmer_2
      - media_player.homepod_badezimmer
      - media_player.homepod_kinderzimmer
      - media_player.homepod_wohnzimmer
      - media_player.homepod_kueche
      - media_player.smarttv_4k
    idle_players: >
      {{ media_players | select('has_value') | reject('is_state', 'playing') | list }}
  actions:
  - repeat:
      count: "{{ idle_players | length }}"
      sequence:
      - condition: template
        value_template: "{{ repeat.index <= (idle_players | length) }}"
      - action: homeassistant.update_entity
        target:
          entity_id: "{{ idle_players[repeat.index - 1] }}"
  mode: single
- id: '1737546250999'
  alias: Helper » HomeKit Controller Reload bei Verbindungsverlust
  description: Lädt die HomeKit Controller Integration neu, wenn HomePods oder Apple TVs unavailable werden
  triggers:
  - trigger: state
    entity_id:
    # HomePods (6)
    - media_player.homepod_arbeitszimmer
    - media_player.arbeitszimmer_2
    - media_player.homepod_badezimmer
    - media_player.homepod_kinderzimmer
    - media_player.homepod_wohnzimmer
    - media_player.homepod_kueche
    # Apple TVs (2)
    - media_player.appletv
    - media_player.wohnzimmer
    to: unavailable
    for:
      seconds: 30
  conditions:
  - condition: template
    value_template: "{{ trigger.from_state is not defined or trigger.from_state.state != 'unavailable' }}"
  variables:
    all_devices:
      - media_player.homepod_arbeitszimmer
      - media_player.arbeitszimmer_2
      - media_player.homepod_badezimmer
      - media_player.homepod_kinderzimmer
      - media_player.homepod_wohnzimmer
      - media_player.homepod_kueche
      - media_player.appletv
      - media_player.wohnzimmer
  actions:
  - choose:
    - alias: "Manueller Trigger - alle Geräte neu laden"
      conditions:
        - condition: template
          value_template: "{{ trigger.entity_id is not defined }}"
      sequence:
      - repeat:
          for_each: "{{ all_devices | select('has_value') | list }}"
          sequence:
          - condition: template
            value_template: "{{ device_id(repeat.item) is not none }}"
          - action: homeassistant.reload_config_entry
            target:
              device_id: "{{ device_id(repeat.item) }}"
            continue_on_error: true
          - delay:
              seconds: 2
      - action: logbook.log
        data:
          name: Apple TV Reload
          message: "Manueller Trigger - alle Apple TV/HomePod Config Entries neu geladen"
    default:
    - alias: "Automatischer Trigger - einzelnes Gerät neu laden"
      delay:
        seconds: 10
    - action: homeassistant.reload_config_entry
      target:
        device_id: "{{ device_id(trigger.entity_id) }}"
      continue_on_error: true
    - action: logbook.log
      data:
        name: Apple TV Reload
        message: "{{ trigger.entity_id }} wurde unavailable - Config Entry neu geladen"
  mode: parallel
  max: 4
