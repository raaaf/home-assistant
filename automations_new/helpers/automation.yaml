# Helpers - Automation.Yaml
# Generated by automation splitter - 6 automations
# Part of Home Assistant configuration

- id: '1733060000001'
  alias: Helper » HomePod Pre-Wake
  description: 'Weckt alle HomePods 10 Minuten vor der Aufwachzeit auf, damit sie für
    die Musik-Automation bereit sind.

    '
  triggers:
  - trigger: template
    value_template: >
      {% set wake_time = states('sensor.wakeup_light_timestamp') %}
      {% if wake_time not in ['unknown', 'unavailable', 'none'] %}
        {% set wake_dt = as_datetime(wake_time) %}
        {% if wake_dt is not none %}
          {% set pre_wake = wake_dt - timedelta(minutes=10) %}
          {{ now() >= pre_wake and now() < wake_dt }}
        {% else %}
          false
        {% endif %}
      {% else %}
        false
      {% endif %}
    id: pre-wake
  conditions:
  - condition: state
    entity_id: input_boolean.alle_sind_weg
    state: 'off'
  - condition: template
    value_template: "{{ has_value('input_boolean.alle_sind_weg') }}"
  - condition: time
    after: 04:50:00
    before: '10:00:00'
  actions:
  - alias: "HomePods aufwecken mit turn_on"
    action: media_player.turn_on
    target:
      entity_id:
      - media_player.homepod_arbeitszimmer
      - media_player.arbeitszimmer_2
      - media_player.homepod_badezimmer
      - media_player.homepod_kinderzimmer
      - media_player.homepod_kuche
      - media_player.homepod_kueche
  - delay: 00:00:03
  - alias: "Entity-Status aktualisieren"
    action: homeassistant.update_entity
    target:
      entity_id:
      - media_player.homepod_arbeitszimmer
      - media_player.arbeitszimmer_2
      - media_player.homepod_badezimmer
      - media_player.homepod_kinderzimmer
      - media_player.homepod_kuche
      - media_player.homepod_kueche
      - media_player.homepods
  - action: logbook.log
    data:
      name: HomePod Pre-Wake
      message: 'HomePods aufgeweckt um {{ now().strftime(''%H:%M'') }} - 10 Min vor Wakeup-Zeit'
      domain: automation
  mode: single

- id: '1696241451967'
  alias: Helper » Workday Musik
  description: 'Startet sanfte Musik zum Aufwachen an Werktagen. Nutzt alle HomePods
    (4 Minis + 2 OG) in einer Gruppe.

    '
  triggers:
  - at: sensor.wakeup_light_timestamp
    trigger: time
    id: wakeup-time
  conditions:
  - condition: state
    entity_id: input_boolean.alle_sind_weg
    state: 'off'
  - condition: template
    value_template: "{{ has_value('input_boolean.alle_sind_weg') }}"
  - condition: time
    after: 05:00:00
    before: '10:00:00'
  actions:
  - alias: "HomeKit-Trigger (startet Musik via Apple Home mit 5% Volume)"
    action: input_boolean.turn_on
    target:
      entity_id:
      - input_boolean.werktag_aufwachen
      - input_boolean.werktag_musik
  - alias: "Warten bis Musik spielt"
    wait_template: '{{ is_state(''media_player.homepods'', ''playing'') }}'
    timeout: 00:00:20
    continue_on_timeout: true
  - alias: "Kurz warten bis HomeKit Volume gesetzt hat"
    delay: 00:00:05
  - action: script.fade_volume
    data:
      curve: linear
      target_player: media_player.homepods
      duration: 600
      target_volume: 0.35
  - alias: "HomePod Minis lauter stellen (40%)"
    delay: 00:00:02
  - action: media_player.volume_set
    target:
      entity_id:
      - media_player.homepod_badezimmer
      - media_player.homepod_kinderzimmer
      - media_player.homepod_arbeitszimmer
      - media_player.arbeitszimmer_2
    data:
      volume_level: 0.40
  - delay: 00:04:03
  - action: input_boolean.turn_off
    target:
      entity_id:
      - input_boolean.werktag_musik
      - input_boolean.werktag_aufwachen
    data: {}
  - action: logbook.log
    data:
      name: Guten Morgen Musik
      message: 'Wakeup Musik gestartet um {{ as_timestamp(states(''sensor.wakeup_light_timestamp''))
        | timestamp_custom(''%H:%M'') }} - HomePods (6 Geräte): {{ (state_attr(''media_player.homepods'',
        ''volume_level'') | float(0) * 100) | round(0) }}% Läuft: {{ state_attr(''media_player.homepods'',
        ''media_title'') | default(''Apple Home Musik'') }} - Fade: 4 Min mit Bezier-Kurve'
      domain: automation
  mode: single
