# Helpers - Energy.Yaml
# Generated by automation splitter - 2 automations
# Part of Home Assistant configuration

- id: '1729846723165'
  alias: Helper ¬ª Cowboys
  description: '√úberwacht Akkustand und Reichweite der Cowboy E-Bikes und sendet Benachrichtigungen

    '
  triggers:
  - entity_id: sensor.rennsemmel_remaining_battery
    below: 25
    id: rennsemmel-battery
    trigger: numeric_state
  - entity_id: sensor.butzabatza_remaining_battery
    below: 25
    id: butzabatza-battery
    trigger: numeric_state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: rennsemmel-battery
      sequence:
      - parallel:
          # TTS Ansage √ºber HomePods
          - action: script.hausgeraete_ansage
            data:
              message: "Alex, dein E-Bike Akku ist unter 25 Prozent. Zeit zum Laden"
              priority: "normal"
          
          # Mobile Benachrichtigung
          - action: notify.alex
            data:
              title: üöµ‚Äç‚ôÄÔ∏è Cowboy Battery <= 25%
              message: Wie w√§re es mit laden?
          
          # Persistent Notification als Backup
          - action: persistent_notification.create
            data:
              notification_id: "ebike_alex_battery"
              title: "üö¥ E-Bike Akku niedrig"
              message: "Alex's E-Bike: {{ states('sensor.rennsemmel_remaining_battery') }}% Akku verbleibend"
    - conditions:
      - condition: trigger
        id: butzabatza-battery
      sequence:
      - parallel:
          # TTS Ansage √ºber HomePods
          - action: script.hausgeraete_ansage
            data:
              message: "Rafael, dein E-Bike Akku ist unter 25 Prozent. Zeit zum Laden"
              priority: "normal"
          
          # Mobile Benachrichtigung
          - action: notify.rafael
            data:
              title: üöµ‚Äç‚ôÄÔ∏è Cowboy Battery <= 25%
              message: Wie w√§re es mit laden?
          
          # Persistent Notification als Backup
          - action: persistent_notification.create
            data:
              notification_id: "ebike_rafael_battery"
              title: "üö¥ E-Bike Akku niedrig"
              message: "Rafael's E-Bike: {{ states('sensor.butzabatza_remaining_battery') }}% Akku verbleibend"
    - conditions:
      - condition: trigger
        id: rennsemmel-range
      sequence:
      - data:
          title: üöµ‚Äç‚ôÄÔ∏è Cowboy Reichweite <= 10km
          message: Wie w√§re es mit laden?
        action: notify.alex
    - conditions:
      - condition: trigger
        id: butzabatza-range
      sequence:
      - data:
          title: üöµ‚Äç‚ôÄÔ∏è Cowboy Reichweite <= 10km
          message: Wie w√§re es mit laden?
        action: notify.rafael
  mode: restart

- id: '1745924954227'
  alias: Helper ¬ª Speichere Solarproduktion gestern
  description: 'Speichert die Tagesproduktion der Solaranlage kurz vor Mitternacht
    in eine Input Number f√ºr die sp√§tere Verwendung

    '
  triggers:
  - at: '23:55:00'
    trigger: time
  conditions:
  - condition: template
    value_template: '{{ has_value("sensor.dtu_ac_daily_energy") and states("sensor.dtu_ac_daily_energy") not in ["unknown", "unavailable"] }}'
  actions:
  - data:
      entity_id: input_number.solarproduktion_gestern
      value: '{{ (states("sensor.dtu_ac_daily_energy") | float(0) / 1000) | round(2) if has_value("sensor.dtu_ac_daily_energy") else 0 }}'
    action: input_number.set_value

# ============================================================================
# ECOFLOW MONITORING SYSTEM - NUR √úBERWACHUNG, KEINE STEUERUNG!
# ============================================================================
# WICHTIG: Steckdose muss IMMER AN bleiben f√ºr PV-Anlage!

- id: 'ecoflow_tagesbilanz'
  alias: 'EcoFlow ¬ª Tagesbilanz Monitoring'
  description: 'Erstellt t√§glich eine Statistik der EcoFlow-Performance (NUR Monitoring)'
  mode: single
  
  triggers:
    - platform: time
      at: "00:01:00"  # Nach der Energy-Bilanz um 00:05
  
  conditions:
    - condition: state
      entity_id: input_boolean.ecoflow_monitoring_aktiv
      state: 'on'
  
  actions:
    # Erweiterte Statistik-Nachricht
    - variables:
        soc_aktuell: "{{ states('sensor.ecoflow_aktueller_soc')|float(0) }}"
        pv_produktion: "{{ states('sensor.solarproduktion_gestern')|float(0) }}"
        einspeisung_heute: >
          {% set last_period = state_attr('sensor.tagliche_einspeisung', 'last_period') %}
          {{ last_period if last_period is not none else 0 }}
        netzbezug_heute: >
          {% set last_period = state_attr('sensor.taglicher_netzbezug', 'last_period') %}
          {{ last_period if last_period is not none else 0 }}
        eigenverbrauch_quote: >
          {% set pv = pv_produktion|float(0) %}
          {% set einsp = einspeisung_heute|float(0) %}
          {{ ((1 - einsp/pv) * 100)|round(1) if pv > 0 else 0 }}
        
    - service: persistent_notification.create
      data:
        notification_id: "ecoflow_tagesbilanz"
        title: "üìä EcoFlow Tagesbilanz (Monitoring)"
        message: >
          **‚ö° Energie-Performance:**
          PV-Produktion: {{ pv_produktion }} kWh
          Einspeisung: {{ einspeisung_heute }} kWh
          Netzbezug: {{ netzbezug_heute }} kWh
          Eigenverbrauch: {{ eigenverbrauch_quote }}%
          
          **üîã EcoFlow Status:**
          Aktueller SoC: {{ soc_aktuell }}%
          Steckdose: {{ 'AN ‚úÖ' if is_state('switch.steckdose_bkk', 'on') else 'AUS ‚ö†Ô∏è' }}
          
          **üîß System:**
          Monitoring: {{ 'Aktiv' if is_state('input_boolean.ecoflow_monitoring_aktiv', 'on') else 'Inaktiv' }}
          PV-Anlage: {{ 'OK' if states('sensor.inverter_ac_power')|float(0) > 0 or now().hour < 8 or now().hour > 19 else 'Pr√ºfen' }}
    
    # Logbook-Eintrag f√ºr Historie
    - service: logbook.log
      data:
        name: "EcoFlow Monitoring"
        domain: "automation"
        message: >
          Tagesbilanz: PV {{ pv_produktion }}kWh, 
          Eigenverbrauch {{ eigenverbrauch_quote }}%, 
          EcoFlow SoC {{ soc_aktuell }}%, 
          Steckdose {{ 'AN' if is_state('switch.steckdose_bkk', 'on') else 'AUS' }}

# ============================================================================
# ECOFLOW STECKDOSEN-WARNUNG - KRITISCH!
# ============================================================================

- id: 'ecoflow_steckdosen_warnung'
  alias: 'EcoFlow ¬ª Steckdosen-Warnung'
  description: 'KRITISCH: Warnt wenn Steckdose AUS ist - PV-Anlage w√ºrde stillstehen!'
  mode: restart
  
  triggers:
    - platform: state
      entity_id: switch.steckdose_bkk
      to: 'off'
      for: "00:01:00"  # 1 Minute Warnung
      id: 'steckdose_aus_warnung'
    
    - platform: state
      entity_id: switch.steckdose_bkk
      to: 'off'
      for: "00:05:00"  # 5 Minuten KRITISCH
      id: 'steckdose_aus_kritisch'
  
  conditions:
    - condition: state
      entity_id: input_boolean.ecoflow_monitoring_aktiv
      state: 'on'
  
  actions:
    - choose:
        # 1 Minute AUS - Warnung
        - conditions:
            - condition: trigger
              id: 'steckdose_aus_warnung'
          sequence:
            - service: persistent_notification.create
              data:
                notification_id: "ecoflow_steckdose_warnung"
                title: "‚ö†Ô∏è WARNUNG: EcoFlow Steckdose AUS"
                message: >
                  Die EcoFlow-Steckdose ist AUS! 
                  PV-Anlage kann NICHT ins Netz einspeisen!
                  Bitte sofort EINSCHALTEN!
        
        # 5 Minuten AUS - KRITISCH
        - conditions:
            - condition: trigger
              id: 'steckdose_aus_kritisch'
          sequence:
            - service: notify.rafael
              data:
                title: "üö® KRITISCH: EcoFlow Steckdose AUS"
                message: >
                  EcoFlow-Steckdose ist seit 5 Minuten AUS!
                  PV-Anlage steht still! Hoymiles ohne Grid-Verbindung!
                  SOFORT EINSCHALTEN!
                data:
                  push:
                    interruption-level: critical
            
            - service: persistent_notification.create
              data:
                notification_id: "ecoflow_steckdose_kritisch"
                title: "üö® KRITISCH: PV-Anlage steht still!"
                message: >
                  EcoFlow-Steckdose seit 5 Minuten AUS!
                  Hoymiles kann nicht ins Netz einspeisen!
                  Komplette PV-Produktion gestoppt!