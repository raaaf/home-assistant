# System - Core.Yaml
# Generated by automation splitter - 2 automations
# Part of Home Assistant configuration

- id: '1642085317177'
  alias: Helpers Â» Fenster / TÃ¼ren
  description: Intelligente Warnanzeige fÃ¼r offene Fenster/TÃ¼ren mit Eskalation, WetterberÃ¼cksichtigung
    und adaptiver Beleuchtung
  mode: restart
  max_exceeded: silent
  triggers:
  - trigger: state
    entity_id: binary_sensor.fenster_tueren
    to: 'on'
    for:
      hours: 0
      minutes: 1
      seconds: 0
    id: open
  - trigger: state
    entity_id: binary_sensor.fenster_tueren
    to: 'off'
    id: closed
  - trigger: state
    entity_id: binary_sensor.fenster_tueren
    to: 'on'
    for:
      hours: 0
      minutes: 10
      seconds: 0
    id: escalation
  - trigger: state
    entity_id: input_boolean.alle_sind_weg
    to: 'on'
    id: leaving
  conditions: []
  actions:
  - variables:
      open_elements: "{{ expand(state_attr('binary_sensor.fenster_tueren', 'entity_id'))\
        \ \n   | selectattr('state', 'in', ['on', 'open']) \n   | map(attribute='name')\
        \ | join(', ') | default('Unbekannt', true) }}\n"
      open_duration_minutes: '{{ ((now() - states.binary_sensor.fenster_tueren.last_changed).total_seconds()
        / 60) | round(1) }}

        '
      is_cold_outside: '{{ states(''sensor.temperatur_aussen'') | float(20) < 5 }}

        '
      is_bad_weather: "{{ states('weather.fuerth_bayern') in ['rainy', 'snowy', 'windy']\
        \ or \n   states('sensor.luftfeuchtigkeit_aussen') | float(50) > 85 }}\n"
      heating_active: '{{ (has_value(''climate.schlafzimmer'') and is_state(''climate.schlafzimmer'',
        ''on'')) or (has_value(''climate.ac'') and is_state(''climate.ac'', ''heat''))
        }}

        '
      is_night_quiet_hours: '{{ now().hour >= 22 or now().hour < 6 }}

        '
      is_critical_situation: '{{ is_cold_outside or (is_bad_weather and heating_active)
        }}

        '
      all_away: '{{ is_state(''input_boolean.alle_sind_weg'', ''on'') }}

        '
  - choose:
    - alias: Benachrichtigung beim Verlassen des Hauses
      conditions:
      - condition: trigger
        id: leaving
      - alias: Fenster/TÃ¼ren sind offen
        condition: state
        entity_id: binary_sensor.fenster_tueren
        state: 'on'
      sequence:
      - alias: Push-Benachrichtigung beim Verlassen
        if:
        - condition: template
          value_template: '{{ has_value(''notify.family'') }}'
        then:
        - action: notify.family
          data:
            title: ðŸ  Fenster/TÃ¼ren noch offen!
            message: 'Beim Verlassen des Hauses: {{ open_elements }} {% if is_cold_outside
              %}(AuÃŸentemperatur: {{ states(''sensor.temperatur_aussen'') }}Â°C){% endif
              %}{% if is_bad_weather %} - Schlechtes Wetter!{% endif %}'
            data:
              priority: high
              tag: fenster_tueren_verlassen
      - alias: Verlassen mit offenen Fenstern loggen
        action: logbook.log
        data:
          name: Fenster/TÃ¼ren beim Verlassen
          message: 'Haus verlassen mit offenen Fenstern/TÃ¼ren: {{ open_elements }}

            '
    - alias: Fenster/TÃ¼ren offen - Adaptive Warnung aktivieren (nur wenn zuhause)
      conditions:
      - condition: trigger
        id: open
      - alias: Jemand ist zuhause
        condition: state
        entity_id: input_boolean.alle_sind_weg
        state: 'off'
      - alias: Aqara Hub ist verfÃ¼gbar
        condition: template
        value_template: '{{ has_value(''light.aqara_hub_lightbulb'') }}'
      - alias: Warnung auch nachts nur bei kritischen Situationen
        condition: or
        conditions:
        - condition: template
          value_template: '{{ not is_night_quiet_hours }}'
        - condition: template
          value_template: '{{ is_critical_situation }}'
      sequence:
      - alias: Adaptive Warnbeleuchtung basierend auf Situation
        action: light.turn_on
        target:
          entity_id: light.aqara_hub_lightbulb
        data:
          rgb_color: "{% if is_critical_situation %}\n  [255, 0, 255]  # Magenta bei\
            \ kritischem Wetter/KÃ¤lte\n{% elif open_duration_minutes < 5 %}\n  [255,\
            \ 165, 0]  # Orange: 1-5 Min\n{% else %}\n  [255, 69, 0]   # Rot-Orange:\
            \ >5 Min\n{% endif %}\n"
          brightness_pct: "{% if is_critical_situation %}\n  60\n{% elif is_night_quiet_hours\
            \ %}\n  15  # GedÃ¤mpft nachts\n{% else %}\n  {{ min(25 + (open_duration_minutes\
            \ * 2), 50) | int }}\n{% endif %}\n"
          effect: '{{ ''color_loop'' if (is_critical_situation and heating_active)
            else ''none'' }}'
      - alias: Pulsierende Warnung bei kritischen Bedingungen
        if:
        - condition: template
          value_template: '{{ is_critical_situation }}'
        then:
        - repeat:
            count: 3
            sequence:
            - action: light.turn_on
              target:
                entity_id: light.aqara_hub_lightbulb
              data:
                brightness_pct: 80
            - delay: 00:00:01
            - action: light.turn_on
              target:
                entity_id: light.aqara_hub_lightbulb
              data:
                brightness_pct: 20
            - delay: 00:00:01
      - alias: Erste Warnung in Logbuch eintragen
        action: logbook.log
        data:
          name: Fenster/TÃ¼ren Warnung
          message: 'Fenster/TÃ¼ren seit 1+ Min offen - {{ ''KRITISCHE'' if is_critical_situation
            else ''Standard'' }} Warnung aktiviert. Offen: {{ open_elements }}. Bedingungen:
            AuÃŸentemp {{ states(''sensor.temperatur_aussen'') }}Â°C,  Wetter: {{ states(''weather.fuerth_bayern'')
            }},  Heizung: {{ ''an'' if heating_active else ''aus'' }}

            '
    - alias: Eskalation nach 10+ Minuten (nur wenn zuhause)
      conditions:
      - condition: trigger
        id: escalation
      - alias: Jemand ist zuhause
        condition: state
        entity_id: input_boolean.alle_sind_weg
        state: 'off'
      - alias: Aqara Hub ist verfÃ¼gbar
        condition: template
        value_template: '{{ has_value(''light.aqara_hub_lightbulb'') }}'
      sequence:
      - alias: Intensivere Warnbeleuchtung
        action: light.turn_on
        target:
          entity_id: light.aqara_hub_lightbulb
        data:
          rgb_color:
          - 255
          - 0
          - 0
          brightness_pct: '{{ 80 if is_critical_situation else 60 }}

            '
          effect: '{{ ''color_loop'' if is_critical_situation else ''none'' }}'
      - alias: Eskalation in Logbuch eintragen
        action: logbook.log
        data:
          name: Fenster/TÃ¼ren Eskalation
          message: 'ESKALATION: Fenster/TÃ¼ren seit {{ open_duration_minutes }} Min
            offen! Bedingungen: {{ ''KRITISCH'' if is_critical_situation else ''Normal''
            }}

            '
    - alias: Fenster/TÃ¼ren geschlossen - Warnung deaktivieren
      conditions:
      - condition: trigger
        id: closed
      - alias: Aqara Hub ist verfÃ¼gbar
        condition: template
        value_template: '{{ has_value(''light.aqara_hub_lightbulb'') }}'
      sequence:
      - alias: Warnbeleuchtung ausschalten
        action: light.turn_off
        target:
          entity_id: light.aqara_hub_lightbulb
        data: {}
      - alias: Entwarnung in Logbuch eintragen
        action: logbook.log
        data:
          name: Fenster/TÃ¼ren Entwarnung
          message: 'Alle Fenster/TÃ¼ren geschlossen nach {{ open_duration_minutes }}
            Min - Warnung deaktiviert

            '
    - alias: Fehlerbehandlung - Hub nicht verfÃ¼gbar
      conditions:
      - condition: template
        value_template: '{{ not has_value(''light.aqara_hub_lightbulb'') }}'
      - alias: Jemand ist zuhause (keine Alternative bei Abwesenheit)
        condition: state
        entity_id: input_boolean.alle_sind_weg
        state: 'off'
      sequence:
      - alias: Fehler loggen
        action: logbook.log
        data:
          name: Fenster/TÃ¼ren Warnung Fehler
          message: 'Aqara Hub nicht verfÃ¼gbar - Warnung konnte nicht {{ ''aktiviert''
            if trigger.id == ''open'' else ''deaktiviert'' }} werden. Status: {{ states(''light.aqara_hub_lightbulb'')
            }}.'
- id: '1740754575040'
  alias: System Â» Zentrale Fehlerbehandlung
  description: Verarbeitet alle Systemfehler zentral und reagiert entsprechend
  triggers:
  - event_type: home_assistant_error
    trigger: event
  - entity_id:
    - input_text.fehlerprotokoll
    trigger: state
  conditions:
  - "{{ trigger.platform == 'event' or (trigger.platform == 'state'
      and trigger.to_state.state != trigger.from_state.state) }}"
  actions:
  - variables:
      error_message: "{% if trigger.platform == 'event' %}\n  {{ trigger.event.data.message\
        \ }}\n{% else %}\n  {{ trigger.to_state.state }}\n{% endif %}\n"
      error_severity: "{% if trigger.platform == 'event' %}\n  {{ trigger.event.data.severity\
        \ | default('Warnung') }}\n{% else %}\n  {{ 'Info' }}\n{% endif %}"
      error_entity: "{% if trigger.platform == 'event' %}\n  {{ trigger.event.data.entity_id\
        \ | default('unbekannt') }}\n{% else %}\n  {{ trigger.entity_id | default('unbekannt') }}\n{% endif %}"
  - data:
      name: Systemfehler
      message: '{{ error_severity }}: {{ error_message }} ({{ error_entity }})'
    action: logbook.log
  - if:
      - condition: template
        value_template: '{{ has_value(''notify.admin_only'') }}'
    then:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ error_severity == 'Kritisch' }}"
            sequence:
            - action: notify.admin_only
              data:
                title: âš ï¸ KRITISCHER FEHLER âš ï¸
                message: '{{ error_message }}'
                data:
                  push:
                    interruption-level: critical
          - conditions:
              - condition: template
                value_template: "{{ error_severity == 'Warnung' }}"
            sequence:
            - action: notify.admin_only
              data:
                title: âš ï¸ System-Warnung
                message: '{{ error_message }}'
                data:
                  push:
                    interruption-level: time-sensitive
        default:
          - action: notify.admin_only
            data:
              title: â„¹ï¸ System-Info
              message: '{{ error_message }}'
              data:
                push:
                  interruption-level: passive
    else:
      - action: logbook.log
        data:
          name: Benachrichtigung Fehler
          message: 'Admin notification service nicht verfÃ¼gbar fÃ¼r Fehler: {{ error_message }}'
  mode: queued
  max: 10

- id: '1733679600000'
  alias: System Â» Z2M OTA Updates
  description: Checks for and triggers Zigbee2MQTT OTA firmware updates daily at 19:30
  mode: single
  triggers:
    - trigger: time_pattern
      hours: '19'
      minutes: '30'
  conditions: []
  actions:
    - alias: Get list of Z2M devices needing an update
      variables:
        update_entities: >
          {{ integration_entities('mqtt')
             | select('match', '^update\\.')
             | select('is_state', 'on')
             | reject('is_state_attr', 'in_progress', true)
             | list }}
    - alias: Run OTA update on devices with updates
      repeat:
        for_each: '{{ update_entities }}'
        sequence:
          - alias: Get Z2M device name from entity
            variables:
              triggered_entity: '{{ repeat.item }}'
              device_name: >
                {{ repeat.item | replace('update.', '') | regex_replace('_firmware$|_update$', '') }}
          - alias: Send MQTT message to Z2M to request update
            action: mqtt.publish
            data:
              qos: '0'
              retain: false
              topic: zigbee2mqtt/bridge/request/device/ota_update/update
              payload: '{"id": "{{ device_name }}"}'
          - alias: Wait a minute for the Z2M update to start
            wait_template: "{{ is_state_attr(triggered_entity, 'in_progress', true) }}"
            timeout: '00:01:00'
            continue_on_timeout: true
          - alias: Wait up to 1 hour for the OTA upgrade to finish
            wait_template: "{{ is_state_attr(triggered_entity, 'in_progress', false) }}"
            timeout: '01:00:00'
            continue_on_timeout: true
          - alias: Log completed update
            action: logbook.log
            data:
              name: Z2M OTA Update
              message: 'Firmware update completed for {{ device_name }}'
