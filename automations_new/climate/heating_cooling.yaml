# Climate - Heating Cooling.Yaml
# Generated by automation splitter - 6 automations
# Part of Home Assistant configuration

- id: '1654346657855'
  alias: Helper » Heute wird es sehr heiß werden
  description: 'Prüft täglich um 3 Uhr die Wettervorhersage und setzt Heißwetter-Flags
    (>24°C und >29°C)

    '
  trigger:
  - at: 03:00:00
    trigger: time
  condition: []
  action:
  - if:
    - condition: template
      value_template: '{{ states(''sensor.fuerth_daily'') not in [''unknown'', ''unavailable''] and state_attr(''sensor.fuerth_daily'', ''forecast'') is not none and state_attr(''sensor.fuerth_daily'', ''forecast'') | length > 0 and state_attr(''sensor.fuerth_daily'', ''forecast'')[0].temperature > 29 }}

        '
    then:
    - target:
        entity_id: input_boolean.heute_wird_es_sehr_heiss_werden
      action: input_boolean.turn_on
    else:
    - target:
        entity_id: input_boolean.heute_wird_es_sehr_heiss_werden
      action: input_boolean.turn_off
  - if:
    - condition: template
      value_template: '{{ states(''sensor.fuerth_daily'') not in [''unknown'', ''unavailable''] and state_attr(''sensor.fuerth_daily'', ''forecast'') is not none and state_attr(''sensor.fuerth_daily'', ''forecast'') | length > 0 and 24 < state_attr(''sensor.fuerth_daily'', ''forecast'')[0].temperature <= 29 }}

        '
    then:
    - target:
        entity_id: input_boolean.heute_wird_es_heiss_werden
      action: input_boolean.turn_on
    else:
    - target:
        entity_id: input_boolean.heute_wird_es_heiss_werden
      action: input_boolean.turn_off
  mode: single
- id: '1721922920220'
  alias: Helper » AC manual
  description: 'Intelligente Klimaanlagen-Steuerung mit Temperatur-Bereichen:  > 25°C:
    Cool-Modus (aktive Kühlung)  23-25°C: Fan-Modus (nur Luftzirkulation)  < 23°C:
    Aus  MODUS: Cool/Fan Mode mit Silent Fan NEU: AC geht nur an wenn Außentemperatur
    > 24°C'
  trigger:
  - entity_id:
    - input_boolean.arbeit
    - input_boolean.gaming
    to: 'on'
    id: aktivität-an
    for:
      hours: 0
      minutes: 1
      seconds: 0
    trigger: state
  - entity_id: input_boolean.schlafenszeit
    to: 'on'
    id: schlafenszeit-an
    for: 00:00:10
    trigger: state
  - entity_id:
    - input_boolean.arbeit
    - input_boolean.gaming
    - input_boolean.schlafenszeit
    to: 'off'
    id: modus-aus
    for: 00:00:10
    trigger: state
  - entity_id:
    - sensor.qingping_air_monitor_lite_temperature
    below: 23
    for: 00:03:00
    trigger: numeric_state
    id: temp-unter-23
  - entity_id:
    - sensor.qingping_air_monitor_lite_temperature
    above: 25
    for: 00:03:00
    trigger: numeric_state
    id: temp-ueber-25
  - entity_id:
    - sensor.qingping_air_monitor_lite_temperature
    trigger: state
    for: 00:02:00
    id: temp-check
  condition:
  - condition: state
    entity_id: input_boolean.alle_sind_weg
    state: 'off'
  - alias: Fenster/Türen müssen geschlossen sein für AC
    condition: state
    entity_id: binary_sensor.fenster_tueren
    state: 'off'
  action:
  - variables:
      arbeit_aktiv: '{{ has_value(''input_boolean.arbeit'') and is_state(''input_boolean.arbeit'', ''on'') }}'
      gaming_aktiv: '{{ has_value(''input_boolean.gaming'') and is_state(''input_boolean.gaming'', ''on'') }}'
      schlafenszeit_aktiv: '{{ has_value(''input_boolean.schlafenszeit'') and is_state(''input_boolean.schlafenszeit'', ''on'') }}'
      irgendein_modus_aktiv: '{{ arbeit_aktiv or gaming_aktiv or schlafenszeit_aktiv
        }}'
      raum_temp: "{% set qingping = states('sensor.qingping_air_monitor_lite_temperature')\
        \ %} {% if has_value('sensor.qingping_air_monitor_lite_temperature') %}\n  {{ qingping\
        \ | float(25) }}\n{% else %}\n  {{ states('sensor.ac_indoor_temperature')\
        \ | float(25) if has_value('sensor.ac_indoor_temperature') else 25 }}\n{% endif %}\n"
      außen_temp: '{{ state_attr(''weather.fuerth_bayern'', ''temperature'') | float(20) if has_value(''weather.fuerth_bayern'') else 20
        }}'
      außen_warm_genug: '{{ außen_temp > 24 }}'
      verwendeter_sensor: "{% set qingping = states('sensor.qingping_air_monitor_lite_temperature')\
        \ %} {% if has_value('sensor.qingping_air_monitor_lite_temperature') %}\n  Qingping\n\
        {% else %}\n  AC Indoor (Fallback)\n{% endif %}\n"
      ac_laeuft: '{{ has_value(''climate.ac'') and states(''climate.ac'') not in [''off'', ''unknown'', ''unavailable'']
        }}'
      aktueller_modus: '{{ states(''climate.ac'') if has_value(''climate.ac'') else ''off'' }}'
      aktueller_preset: '{{ state_attr(''climate.ac'', ''preset_mode'') if has_value(''climate.ac'') else ''none'' }}'
  - choose:
    - conditions:
      - condition: trigger
        id:
        - aktivität-an
        - schlafenszeit-an
      - condition: template
        value_template: '{{ irgendein_modus_aktiv }}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ raum_temp > 25 and außen_warm_genug }}'
          sequence:
          - action: climate.set_hvac_mode
            data:
              hvac_mode: cool
            target:
              entity_id: climate.ac
          - delay: 00:00:02
          - if:
            - condition: template
              value_template: '{{ arbeit_aktiv or gaming_aktiv }}'
            then:
            - action: climate.set_preset_mode
              data:
                preset_mode: ieco
              target:
                entity_id: climate.ac
          - action: climate.set_fan_mode
            data:
              fan_mode: silent
            target:
              entity_id: climate.ac
          - action: climate.set_temperature
            data:
              temperature: '{{ 24 if schlafenszeit_aktiv else 23 }}'
            target:
              entity_id: climate.ac
        - conditions:
          - condition: template
            value_template: '{{ raum_temp >= 23 and raum_temp <= 25 and außen_warm_genug
              }}'
          sequence:
          - action: climate.set_hvac_mode
            data:
              hvac_mode: fan_only
            target:
              entity_id: climate.ac
          - delay: 00:00:02
          - action: climate.set_fan_mode
            data:
              fan_mode: silent
            target:
              entity_id: climate.ac
        - conditions:
          - condition: template
            value_template: '{{ raum_temp < 23 or not außen_warm_genug }}'
          sequence: null
    - conditions:
      - condition: trigger
        id: modus-aus
      - condition: template
        value_template: '{{ not irgendein_modus_aktiv }}'
      sequence:
      - action: climate.turn_off
        target:
          entity_id: climate.ac
        data: {}
    - conditions:
      - condition: trigger
        id: temp-unter-23
      - condition: template
        value_template: '{{ ac_laeuft and irgendein_modus_aktiv }}'
      sequence:
      - action: climate.turn_off
        target:
          entity_id: climate.ac
        data: {}
    - conditions:
      - condition: trigger
        id: temp-ueber-25
      - condition: template
        value_template: '{{ irgendein_modus_aktiv and außen_warm_genug and (not ac_laeuft
          or aktueller_modus == ''fan_only'') }}'
      sequence:
      - action: climate.set_hvac_mode
        data:
          hvac_mode: cool
        target:
          entity_id: climate.ac
      - delay: 00:00:02
      - if:
        - condition: template
          value_template: '{{ arbeit_aktiv or gaming_aktiv }}'
        then:
        - action: climate.set_preset_mode
          data:
            preset_mode: ieco
          target:
            entity_id: climate.ac
      - action: climate.set_fan_mode
        data:
          fan_mode: silent
        target:
          entity_id: climate.ac
      - action: climate.set_temperature
        data:
          temperature: '{{ 24 if schlafenszeit_aktiv else 23 }}'
        target:
          entity_id: climate.ac
    - conditions:
      - condition: trigger
        id: temp-check
      - condition: template
        value_template: '{{ irgendein_modus_aktiv }}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ ac_laeuft and not außen_warm_genug }}'
          sequence:
          - action: climate.turn_off
            target:
              entity_id: climate.ac
            data: {}
        - conditions:
          - condition: template
            value_template: "{{ raum_temp >= 23 and raum_temp <= 25 and ac_laeuft\
              \ and \n   aktueller_modus == 'cool' and außen_warm_genug }}"
          sequence:
          - action: climate.set_hvac_mode
            data:
              hvac_mode: fan_only
            target:
              entity_id: climate.ac
          - delay: 00:00:02
          - action: climate.set_fan_mode
            data:
              fan_mode: silent
            target:
              entity_id: climate.ac
        - conditions:
          - condition: template
            value_template: '{{ raum_temp > 23 and not ac_laeuft and außen_warm_genug
              }}'
          sequence:
          - choose:
            - conditions:
              - condition: template
                value_template: '{{ raum_temp > 25 }}'
              sequence:
              - action: climate.set_hvac_mode
                data:
                  hvac_mode: cool
                target:
                  entity_id: climate.ac
              - delay: 00:00:02
              - if:
                - condition: template
                  value_template: '{{ arbeit_aktiv or gaming_aktiv }}'
                then:
                - action: climate.set_preset_mode
                  data:
                    preset_mode: ieco
                  target:
                    entity_id: climate.ac
              - action: climate.set_fan_mode
                data:
                  fan_mode: silent
                target:
                  entity_id: climate.ac
              - action: climate.set_temperature
                data:
                  temperature: '{{ 24 if schlafenszeit_aktiv else 23 }}'
                target:
                  entity_id: climate.ac
            - conditions:
              - condition: template
                value_template: '{{ raum_temp >= 23 and raum_temp <= 25 }}'
              sequence:
              - action: climate.set_hvac_mode
                data:
                  hvac_mode: fan_only
                target:
                  entity_id: climate.ac
              - delay: 00:00:02
              - action: climate.set_fan_mode
                data:
                  fan_mode: silent
                target:
                  entity_id: climate.ac
  mode: single
  max_exceeded: silent
- id: '1743835898091'
  alias: Helper » Frostwarnung für Blumen (morgen früh unter 0°C)
  description: 'Sendet eine kritische Notification, wenn es in der Nacht auf morgen
    Frost geben soll (nur einmal pro Frostperiode)

    '
  trigger:
  - at: '10:00:00'
    trigger: time
  condition:
  - condition: template
    value_template: "{% if states('sensor.fuerth_daily') not in ['unknown', 'unavailable'] and state_attr('sensor.fuerth_daily', 'forecast') is not none %}\n  {% set forecast = state_attr('sensor.fuerth_daily', 'forecast') %}\n  {% if forecast and forecast | length > 0 %}\n    {{ forecast[0].templow < 0 }}\n  {% else %}\n    false\n  {% endif %}\n{% else %}\n  false\n{% endif %}\n"
  - condition: state
    entity_id: input_boolean.frost_warning_sent
    state: 'off'
  action:
  - action: notify.alex
    data:
      title: "Frostwarnung für die Blumen"
      message: "Heute Nacht Frost unter 0°C vorhergesagt. Bitte Blumen abdecken."
  - action: persistent_notification.create
    data:
      title: "Frostwarnung für die Blumen"
      message: "In der Nacht sind Frostwerte unter 0°C vorhergesagt. Bitte die Blumen abdecken, um sie vor dem Frost zu schützen."
      notification_id: frostwarnung_blumen
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.frost_warning_sent
  mode: single
- id: '1749643406352'
  alias: Ventilator » Individuelle Raumsteuerung (Optimiert)
  description: 'Arbeitszimmer: Ventilator mit AC-Integration  Kinderzimmer: Nur während
    Schlafenszeit automatisch, sonst manuell

    '
  trigger:
  - entity_id: sensor.arbeitszimmer_temperatur
    above: 22
    for: 00:02:00
    id: arbeit-warm
    trigger: numeric_state
  - entity_id: sensor.arbeitszimmer_temperatur
    below: 21
    for: 00:05:00
    id: arbeit-kalt
    trigger: numeric_state
  - entity_id: sensor.arbeitszimmer_temperatur
    trigger: state
    for: 00:03:00
    id: arbeit-speed-adjust
  - entity_id: sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature
    above: 23
    for: 00:03:00
    id: kinder-warm
    trigger: numeric_state
  - entity_id: sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature
    below: 22
    for: 00:05:00
    id: kinder-kalt
    trigger: numeric_state
  - entity_id: sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature
    trigger: state
    for: 00:03:00
    id: kinder-speed-adjust
  - entity_id: input_boolean.schlafenszeit
    to: 'off'
    id: schlafenszeit-ende
    trigger: state
  - entity_id: climate.ac
    trigger: state
    id: ac-status-change
  condition: []
  action:
  - variables:
      arbeit_fan: fan.zhimi_za4_2dca_fan
      kinder_fan: fan.zhimi_za4_fb1b_fan
      niemand_zuhause: '{{ has_value(''input_boolean.alle_sind_weg'') and is_state(''input_boolean.alle_sind_weg'', ''on'') }}'
      schlafenszeit_aktiv: '{{ has_value(''input_boolean.schlafenszeit'') and is_state(''input_boolean.schlafenszeit'', ''on'') }}'
      ac_laeuft: '{{ has_value(''climate.ac'') and states(''climate.ac'') in [''cool'',
        ''heat'', ''dry'', ''fan_only''] }}'
      ac_temperatur: '{{ state_attr(''climate.ac'', ''current_temperature'') | float(25) if has_value(''climate.ac'') else 25
        }}'
  - choose:
    - conditions:
      - condition: trigger
        id: arbeit-warm
      - condition: template
        value_template: '{{ not niemand_zuhause }}'
      - condition: template
        value_template: '{{ not has_value(''fan.zhimi_za4_2dca_fan'') or is_state(''fan.zhimi_za4_2dca_fan'', ''off'') }}'
      sequence:
      - condition: or
        conditions:
        - condition: template
          value_template: '{{ not ac_laeuft }}'
        - condition: template
          value_template: '{{ ac_laeuft and has_value(''sensor.arbeitszimmer_temperatur'') and states(''sensor.arbeitszimmer_temperatur'')|float(22)
            > 24 }}'
      - action: fan.turn_on
        target:
          entity_id: '{{ arbeit_fan }}'
        data: {}
      - action: fan.set_percentage
        data:
          percentage: "{% if has_value('sensor.arbeitszimmer_temperatur') %}\n  {% set temp = states('sensor.arbeitszimmer_temperatur')|float(22) %}\n  {% if ac_laeuft %}\n    {# Mit AC: Niedrigere Stufen für Luftzirkulation #}\n    {% if temp > 28 %} 75\n    {% elif temp > 26 %} 50\n    {% elif temp > 24 %} 25\n    {% else %} 25\n    {% endif %}\n  {% else %}\n    {# Ohne AC: Normale Stufen #}\n    {% if temp > 28 %} 100\n    {% elif temp > 26 %} 75\n    {% elif temp > 24 %} 50\n    {% else %} 25\n    {% endif %}\n  {% endif %}\n{% else %}\n  25\n{% endif %}\n"
        target:
          entity_id: '{{ arbeit_fan }}'
      - action: logbook.log
        data:
          name: Ventilator Arbeitszimmer
          message: 'Temp: {{ states(''sensor.arbeitszimmer_temperatur'') if has_value(''sensor.arbeitszimmer_temperatur'') else ''N/A'' }}°C {{ ''Mit AC'' if ac_laeuft else ''Standalone'' }}'
          domain: climate
    - conditions:
      - condition: trigger
        id: arbeit-kalt
      - condition: template
        value_template: '{{ has_value(''fan.zhimi_za4_2dca_fan'') and is_state(''fan.zhimi_za4_2dca_fan'', ''on'') }}'
      sequence:
      - action: fan.turn_off
        target:
          entity_id: '{{ arbeit_fan }}'
        data: {}
    - conditions:
      - condition: trigger
        id: arbeit-speed-adjust
      - condition: template
        value_template: '{{ has_value(''fan.zhimi_za4_2dca_fan'') and is_state(''fan.zhimi_za4_2dca_fan'', ''on'') }}'
      sequence:
      - action: fan.set_percentage
        data:
          percentage: "{% if has_value('sensor.arbeitszimmer_temperatur') %}\n  {% set temp = states('sensor.arbeitszimmer_temperatur')|float(22) %}\n  {% if ac_laeuft %}\n    {% if temp > 28 %} 75\n    {% elif temp > 26 %} 50\n    {% elif temp > 24 %} 25\n    {% elif temp > 22 %} 25\n    {% else %} 25\n    {% endif %}\n  {% else %}\n    {% if temp > 28 %} 100\n    {% elif temp > 26 %} 75\n    {% elif temp > 24 %} 50\n    {% elif temp > 22 %} 25\n    {% else %} 25\n    {% endif %}\n  {% endif %}\n{% else %}\n  25\n{% endif %}\n"
        target:
          entity_id: '{{ arbeit_fan }}'
    - conditions:
      - condition: trigger
        id: kinder-warm
      - condition: template
        value_template: '{{ schlafenszeit_aktiv and not niemand_zuhause }}'
      - condition: template
        value_template: '{{ not has_value(''fan.zhimi_za4_fb1b_fan'') or is_state(''fan.zhimi_za4_fb1b_fan'', ''off'') }}'
      sequence:
      - action: fan.turn_on
        target:
          entity_id: '{{ kinder_fan }}'
        data: {}
      - action: fan.set_percentage
        data:
          percentage: '{% if has_value(''sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature'') %}
            {% set temp = states(''sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature'')|float(22) %}
            {# Sanfte Stufen für Kinder #}
            {% if temp > 28 %} 50 {% elif temp > 26 %} 35 {% elif temp > 24 %} 25 {% else %} 20 {% endif %}
            {% else %} 20 {% endif %}

            '
        target:
          entity_id: '{{ kinder_fan }}'
    - conditions:
      - condition: trigger
        id: kinder-kalt
      - condition: template
        value_template: '{{ schlafenszeit_aktiv }}'
      - condition: template
        value_template: '{{ has_value(''fan.zhimi_za4_fb1b_fan'') and is_state(''fan.zhimi_za4_fb1b_fan'', ''on'') }}'
      sequence:
      - action: fan.turn_off
        target:
          entity_id: '{{ kinder_fan }}'
        data: {}
    - conditions:
      - condition: trigger
        id: kinder-speed-adjust
      - condition: template
        value_template: '{{ schlafenszeit_aktiv }}'
      - condition: template
        value_template: '{{ has_value(''fan.zhimi_za4_fb1b_fan'') and is_state(''fan.zhimi_za4_fb1b_fan'', ''on'') }}'
      sequence:
      - action: fan.set_percentage
        data:
          percentage: '{% if has_value(''sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature'') %}
            {% set temp = states(''sensor.kinderzimmer_temperatur_und_luftfeuchtigkeit_temperature'')|float(22) %}
            {% if temp > 28 %} 50 {% elif temp > 26 %} 35 {% elif temp > 24 %} 25 {% elif temp > 22 %} 20 {% else %} 20 {% endif %}
            {% else %} 20 {% endif %}

            '
        target:
          entity_id: '{{ kinder_fan }}'
    - conditions:
      - condition: trigger
        id: schlafenszeit-ende
      - condition: template
        value_template: '{{ has_value(''fan.zhimi_za4_fb1b_fan'') and is_state(''fan.zhimi_za4_fb1b_fan'', ''on'') }}'
      sequence:
      - action: fan.turn_off
        target:
          entity_id: '{{ kinder_fan }}'
        data: {}
    - conditions:
      - condition: trigger
        id: ac-status-change
      - condition: template
        value_template: '{{ has_value(''fan.zhimi_za4_2dca_fan'') and is_state(''fan.zhimi_za4_2dca_fan'', ''on'') }}'
      sequence:
      - action: fan.set_percentage
        data:
          percentage: "{% if has_value('sensor.arbeitszimmer_temperatur') %}\n  {% set temp = states('sensor.arbeitszimmer_temperatur')|float(22) %}\n  {% if ac_laeuft %}\n    {% if temp > 28 %} 75\n    {% elif temp > 26 %} 50\n    {% elif temp > 24 %} 25\n    {% else %} 25\n    {% endif %}\n  {% else %}\n    {% if temp > 28 %} 100\n    {% elif temp > 26 %} 75\n    {% elif temp > 24 %} 50\n    {% else %} 25\n    {% endif %}\n  {% endif %}\n{% else %}\n  25\n{% endif %}\n"
        target:
          entity_id: '{{ arbeit_fan }}'
    - conditions:
      - condition: template
        value_template: '{{ niemand_zuhause }}'
      sequence:
      - action: fan.turn_off
        target:
          entity_id:
          - '{{ arbeit_fan }}'
          - '{{ kinder_fan }}'
        data: {}
  mode: parallel
  max: 4
- id: '1749999999998'
  alias: Heizung » Smart Floor Control (Predictive)
  description: 'Predictive floor heating control for slow-response system (1-2h warmup). Morning boost based on forecast, afternoon boost based on actual temp. Only controls Kinderzimmer, Schlafzimmer, Wohnzimmer.'
  trigger:
  - at: "06:30:00"
    id: morning-boost
    trigger: time
  - at: "14:30:00"
    id: afternoon-boost
    trigger: time
  condition: []
  action:
  - variables:
      heating_switches:
      - switch.heizung_kinderzimmer
      - switch.heizung_schlafzimmer
      - switch.heizung_wohnzimmer
      temp_source: >-
        {% if trigger.id == 'morning-boost' %}
          {% set forecast = state_attr('sensor.fuerth_daily', 'forecast') %}
          {% if forecast and forecast | length > 0 %}
            {{ forecast[0].temperature | float(5) }}
          {% else %}
            5
          {% endif %}
        {% else %}
          {{ state_attr('weather.fuerth_bayern', 'temperature') | float(5) }}
        {% endif %}
      boost_duration: >-
        {% if temp_source | float < 0 %}
          03:00:00
        {% elif temp_source | float < 5 %}
          02:00:00
        {% elif temp_source | float < 10 %}
          01:30:00
        {% else %}
          00:00:00
        {% endif %}
  - choose:
    # === LAYER 1: MORNING BOOST (06:00) ===
    - conditions:
      - condition: trigger
        id: morning-boost
      - condition: or
        conditions:
        # Someone is home
        - condition: state
          entity_id: input_boolean.alle_sind_weg
          state: 'off'
        # OR away less than 24 hours (short absence like picking up kids)
        - condition: template
          value_template: >
            {{ is_state('input_boolean.alle_sind_weg', 'on') and
               (now() - states.input_boolean.alle_sind_weg.last_changed).total_seconds() < 86400 }}
      - condition: template
        value_template: '{{ now().month <= 4 or now().month >= 10 }}'
      - condition: template
        value_template: "{{ boost_duration != '00:00:00' }}"
      sequence:
      - action: switch.turn_on
        target:
          entity_id: '{{ heating_switches }}'
      - action: logbook.log
        data:
          name: Heizung Morning Boost
          message: "Vorhersage {{ temp_source | round(1) }}°C → Boost {{ boost_duration }}"
          domain: climate
      - action: timer.start
        target:
          entity_id: timer.heizung_boost
        data:
          duration: "{{ boost_duration }}"

    # === LAYER 2: AFTERNOON BOOST (15:00) ===
    - conditions:
      - condition: trigger
        id: afternoon-boost
      - condition: or
        conditions:
        # Someone is home
        - condition: state
          entity_id: input_boolean.alle_sind_weg
          state: 'off'
        # OR away less than 24 hours (short absence like picking up kids)
        - condition: template
          value_template: >
            {{ is_state('input_boolean.alle_sind_weg', 'on') and
               (now() - states.input_boolean.alle_sind_weg.last_changed).total_seconds() < 86400 }}
      - condition: template
        value_template: '{{ now().month <= 4 or now().month >= 10 }}'
      - condition: template
        value_template: "{{ boost_duration != '00:00:00' }}"
      sequence:
      - action: switch.turn_on
        target:
          entity_id: '{{ heating_switches }}'
      - action: logbook.log
        data:
          name: Heizung Afternoon Boost
          message: "DWD {{ temp_source | round(1) }}°C → Boost {{ boost_duration }}"
          domain: climate
      - action: timer.start
        target:
          entity_id: timer.heizung_boost
        data:
          duration: "{{ boost_duration }}"
  mode: single
- id: '1749999999999'
  alias: Heizung » Boost Timer Finished
  description: 'Turns off heating when boost timer expires with verification and retry'
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.heizung_boost
  action:
  - variables:
      heating_switches:
      - switch.heizung_kinderzimmer
      - switch.heizung_schlafzimmer
      - switch.heizung_wohnzimmer
  # First attempt: Turn off all switches
  - action: switch.turn_off
    target:
      entity_id: "{{ heating_switches }}"
  - delay: "00:00:03"
  # Verification loop with retry (max 3 attempts)
  - alias: Verify and retry if needed
    repeat:
      count: 3
      sequence:
      - variables:
          still_on: >
            {{ heating_switches | select('is_state', 'on') | list }}
      - if:
        - condition: template
          value_template: "{{ still_on | length == 0 }}"
        then:
        - action: logbook.log
          data:
            name: Heizung Boost beendet
            message: "1,5h Boost abgeschlossen - alle Schalter aus (Versuch {{ repeat.index }})"
            domain: climate
        - stop: "All switches confirmed off"
        else:
        - action: logbook.log
          data:
            name: Heizung Boost Retry
            message: "Versuch {{ repeat.index }}/3: Schalter noch an: {{ still_on | join(', ') }}"
            domain: climate
        - action: switch.turn_off
          target:
            entity_id: "{{ still_on }}"
        - delay: "00:00:05"
  # Final check after all retries
  - variables:
      final_check: >
        {{ heating_switches | select('is_state', 'on') | list }}
  - if:
    - condition: template
      value_template: "{{ final_check | length > 0 }}"
    then:
    - action: logbook.log
      data:
        name: Heizung Boost FEHLER
        message: "WARNUNG: Nach 3 Versuchen noch aktiv: {{ final_check | join(', ') }}"
        domain: climate
    - action: persistent_notification.create
      data:
        title: "Heizung Boost Fehler"
        message: "Schalter konnten nicht ausgeschaltet werden: {{ final_check | join(', ') }}"
        notification_id: heizung_boost_error
  mode: single
- id: '1750000000001'
  alias: Heizung » Safety Watchdog (2h Limit)
  description: 'Safety backup: Turns off heating if on > 2 hours without active timer'
  trigger:
  - trigger: time_pattern
    minutes: "/15"
  condition:
  - condition: state
    entity_id: timer.heizung_boost
    state: idle
  action:
  - variables:
      heating_switches:
      - switch.heizung_kinderzimmer
      - switch.heizung_schlafzimmer
      - switch.heizung_wohnzimmer
      max_on_seconds: 7200
      switches_on_too_long: >
        {% set result = namespace(switches=[]) %}
        {% for sw in heating_switches %}
          {% if is_state(sw, 'on') %}
            {% set on_duration = (now() - states[sw].last_changed).total_seconds() %}
            {% if on_duration > max_on_seconds %}
              {% set result.switches = result.switches + [sw] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ result.switches }}
  - condition: template
    value_template: "{{ switches_on_too_long | length > 0 }}"
  - action: logbook.log
    data:
      name: Heizung Safety Watchdog
      message: "WARNUNG: Schalter > 2h an ohne Timer: {{ switches_on_too_long | join(', ') }} - schalte aus"
      domain: climate
  - action: switch.turn_off
    target:
      entity_id: "{{ switches_on_too_long }}"
  - delay: "00:00:03"
  - variables:
      still_on_after: >
        {{ switches_on_too_long | select('is_state', 'on') | list }}
  - if:
    - condition: template
      value_template: "{{ still_on_after | length > 0 }}"
    then:
    - action: switch.turn_off
      target:
        entity_id: "{{ still_on_after }}"
    - action: persistent_notification.create
      data:
        title: "Heizung Safety Watchdog"
        message: "Schalter waren > 2h an ohne Timer: {{ switches_on_too_long | join(', ') }}"
        notification_id: heizung_watchdog_warning
  mode: single
- id: '1750000000002'
  alias: Heizung » Restart Recovery Check
  description: 'After HA restart: Verify heating state matches timer state'
  trigger:
  - trigger: homeassistant
    event: start
  action:
  - delay: "00:00:30"
  - variables:
      heating_switches:
      - switch.heizung_kinderzimmer
      - switch.heizung_schlafzimmer
      - switch.heizung_wohnzimmer
      timer_active: "{{ is_state('timer.heizung_boost', 'active') }}"
      switches_on: >
        {{ heating_switches | select('is_state', 'on') | list }}
  - if:
    - condition: template
      value_template: "{{ switches_on | length > 0 and not timer_active }}"
    then:
    - action: logbook.log
      data:
        name: Heizung Restart Recovery
        message: "Nach Neustart: Heizung an ({{ switches_on | join(', ') }}) aber Timer inaktiv"
        domain: climate
    - action: persistent_notification.create
      data:
        title: "Heizung Status nach Neustart"
        message: "Heizung ist an aber Timer ist inaktiv. Watchdog prüft alle 15 min. Schalter: {{ switches_on | join(', ') }}"
        notification_id: heizung_restart_check
  mode: single
- id: '1743835898092'
  alias: Helper » Frostwarnung zurücksetzen (jährlich im Mai)
  description: 'Setzt den Frostwarnung-Status am 1. Mai zurück für die neue Saison'
  trigger:
  - platform: time
    at: '08:00:00'
  condition:
  - condition: template
    value_template: "{{ now().month == 5 and now().day == 1 }}"
  action:
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.frost_warning_sent
  mode: single
