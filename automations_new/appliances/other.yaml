# Appliances - Other.Yaml
# Generated by automation splitter - 1 automations
# Part of Home Assistant configuration

- id: '1692865865168'
  alias: "Benachrichtigung » Futterspender Wartung"
  description: "Überwacht Futterspender und erstellt Wartungsaufgaben bei Reinigungs- und Filterwechselbedarf mit HomePod-Ansagen"
  triggers:
  - trigger: state
    entity_id: sensor.mmgg_fi1_2081_cleantime
    attribute: clearnserve.cleantime
    to: '1'
    id: reinigung
  - trigger: state
    entity_id: sensor.mmgg_fi1_2081_desiccant_left_time
    attribute: clearnserve.cleantime
    to: '1'
    id: filter
  conditions:
  - alias: "Nicht öfter als alle 12 Stunden triggern"
    condition: template
    value_template: >-
      {% set last = state_attr('automation.benachrichtigung_futterspender_wartung', 'last_triggered') %}
      {{ last is none or (now() - last).total_seconds() > 43200 }}
  - alias: "Futterspender-Sensoren sind verfügbar"
    condition: template
    value_template: >-
      {{ states('sensor.mmgg_fi1_2081_cleantime') not in ['unknown', 'unavailable'] and
         states('sensor.mmgg_fi1_2081_desiccant_left_time') not in ['unknown', 'unavailable'] }}
  actions:
  - choose:
    - alias: "Filter ersetzen"
      conditions:
      - condition: trigger
        id: filter
      sequence:
      - parallel:
          # Todo erstellen
          - action: script.turn_on
            target:
              entity_id: script.xtodo_create_todo
            data:
              variables:
                todo: "Futterspender » Filter ersetzen"
          
          # Mobile Benachrichtigungen
          - parallel:
              - action: notify.rafael
                data:
                  title: "🐾 Futterspender"
                  message: "Filter ersetzen"
              - action: notify.alex
                data:
                  title: "🐾 Futterspender"
                  message: "Filter ersetzen"
          
          # Fallback persistent notification
          - if:
              - condition: template
                value_template: >-
                  {{ states('script.xtodo_create_todo') in ['unknown', 'unavailable'] }}
            then:
              - action: persistent_notification.create
                data:
                  notification_id: "futterspender_filter"
                  title: "🐾 Futterspender Wartung"
                  message: "Filter ersetzen"
    
    - alias: "Futterspender reinigen"
      conditions:
      - condition: trigger
        id: reinigung
      sequence:
      - parallel:
          # Todo erstellen
          - action: script.turn_on
            target:
              entity_id: script.xtodo_create_todo
            data:
              variables:
                todo: "Futterspender » Reinigen"
          
          # Mobile Benachrichtigungen
          - parallel:
              - action: notify.rafael
                data:
                  title: "🐾 Futterspender"
                  message: "Reinigen"
              - action: notify.alex
                data:
                  title: "🐾 Futterspender"
                  message: "Reinigen"
          
          # Fallback persistent notification
          - if:
              - condition: template
                value_template: >-
                  {{ states('script.xtodo_create_todo') in ['unknown', 'unavailable'] }}
            then:
              - action: persistent_notification.create
                data:
                  notification_id: "futterspender_reinigung"
                  title: "🐾 Futterspender Wartung"
                  message: "Futterspender reinigen"
    
    default:
    # Fallback bei unbekanntem Trigger
    - action: persistent_notification.create
      data:
        notification_id: "futterspender_error"
        title: "⚠️ Futterspender Fehler"
        message: "Unbekannter Wartungstrigger ausgelöst"
  mode: single
