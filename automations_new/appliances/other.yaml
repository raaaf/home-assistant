# Appliances - Other.Yaml
# Generated by automation splitter - 1 automations
# Part of Home Assistant configuration

- id: '1692865865168'
  alias: "Benachrichtigung » Futterspender Wartung"
  description: "Überwacht Futterspender und erstellt Wartungsaufgaben bei Reinigungs- und Filterwechselbedarf mit HomePod-Ansagen"
  triggers:
  - trigger: state
    entity_id: sensor.mmgg_fi1_2081_cleantime
    attribute: clearnserve.cleantime
    to: '1'
    id: reinigung
  - trigger: state
    entity_id: sensor.mmgg_fi1_2081_desiccant_left_time
    attribute: clearnserve.cleantime
    to: '1'
    id: filter
  conditions:
  - alias: "Nicht öfter als alle 12 Stunden triggern"
    condition: template
    value_template: >-
      {% set last = state_attr('automation.benachrichtigung_futterspender_wartung', 'last_triggered') %}
      {{ last is none or (now() - last).total_seconds() > 43200 }}
  - alias: "Futterspender-Sensoren sind verfügbar"
    condition: template
    value_template: >-
      {{ states('sensor.mmgg_fi1_2081_cleantime') not in ['unknown', 'unavailable'] and
         states('sensor.mmgg_fi1_2081_desiccant_left_time') not in ['unknown', 'unavailable'] }}
  actions:
  - choose:
    - alias: "Filter ersetzen"
      conditions:
      - condition: trigger
        id: filter
      sequence:
      - parallel:
          # Email notification
          - action: notify.rafael_mail
            data:
              title: "🐾 Futterspender Wartung - Filter ersetzen"
              message: >
                <html>
                <body>
                <h2>🐾 Futterspender Wartung erforderlich</h2>
                <p><strong>Wartungsaufgabe:</strong> Filter ersetzen</p>
                <p>Bitte ersetze den Filter des Futterspenders, wenn es dir möglich ist.</p>
                </body>
                </html>
          
          # Mobile Benachrichtigungen
          - parallel:
              - action: notify.rafael
                data:
                  title: "🐾 Futterspender"
                  message: "Filter ersetzen"
              - action: notify.alex
                data:
                  title: "🐾 Futterspender"
                  message: "Filter ersetzen"
    
    - alias: "Futterspender reinigen"
      conditions:
      - condition: trigger
        id: reinigung
      sequence:
      - parallel:
          # Email notification
          - action: notify.rafael_mail
            data:
              title: "🐾 Futterspender Wartung - Reinigung erforderlich"
              message: >
                <html>
                <body>
                <h2>🐾 Futterspender Wartung erforderlich</h2>
                <p><strong>Wartungsaufgabe:</strong> Futterspender reinigen</p>
                <p>Bitte führe eine gründliche Reinigung des Futterspenders durch.</p>
                </body>
                </html>
          
          # Mobile Benachrichtigungen
          - parallel:
              - action: notify.rafael
                data:
                  title: "🐾 Futterspender"
                  message: "Reinigen"
              - action: notify.alex
                data:
                  title: "🐾 Futterspender"
                  message: "Reinigen"
    
    default:
    # Fallback bei unbekanntem Trigger
    - action: notify.rafael_mail
      data:
        title: "Futterspender Fehler"
        message: |
          Futterspender Automation Fehler

          Unbekannter Wartungstrigger wurde ausgelöst.
          Bitte überprüfe die Automation.
  mode: single
