# Notifications - Monitoring.Yaml
# Generated by automation splitter - 5 automations
# Part of Home Assistant configuration

- id: '1645110903677'
  alias: Notification ¬ª Es gibt nicht erreichbare Ger√§te
  description: Sendet werktags um 10 Uhr eine E-Mail bei nicht erreichbaren Ger√§ten
  use_blueprint:
    path: gmlupatelli/unavailable_entities_notification.yaml
    input:
      time: '10:00:00'
      actions:
      - action: notify.rafael_mail
        data:
          title: üëâ Nicht erreichbare Ger√§te
          message: '{{entities}}'
      monday_enabled: true
      tuesday_enabled: false  
      wednesday_enabled: true
      thursday_enabled: false
      friday_enabled: true
      saturday_enabled: false
      sunday_enabled: false
- id: '1665868733806'
  alias: Notification ¬ª Luftfeuchtigkeit 15:00
  description: Sendet t√§gliche Benachrichtigung bei Luftfeuchtigkeit √ºber 60%
  use_blueprint:
    path: migsun/high-humidity-level-detection-notification-for-all-humidity-sensors.yaml
    input:
      threshold: 60
      time: '15:00:00'
      actions:
      - action: notify.family
        data:
          title: üëâ Luftfeuchtigkeit
          message: '{{sensors}}'
      exclude:
        entity_id:
        - sensor.temperatur_aussen_sonnenaufgang_humidity
        - sensor.temperatur_aussen_sonnenuntergang_humidity
- id: '1726065861905'
  alias: Notifications ¬ª Niedriger Batteriestand
  description: Benachrichtigt bei niedrigem Batteriestand (unter 10%) von Ger√§ten
  use_blueprint:
    path: Blackshome/low-battery-notifications-and-actions.yaml
    input:
      include_time: time_enabled
      time: '10:00:00'
      include_persistent_notification: enable_persistent_notification
      battery_level: 10
- id: '1754479299582'
  alias: Watchman ¬ª Sensor √úberwachung
  description: F√ºhrt geplante Pr√ºfungen aus und warnt bei Sensor-Problemen
  triggers:
  - at: 09:00:00
    id: scheduled_morning
    trigger: time
  - at: '16:00:00'
    id: scheduled_evening
    trigger: time
  - entity_id: sensor.watchman_missing_entities
    attribute: entities
    id: sensor_change
    trigger: state
    enabled: false
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - scheduled_morning
        - scheduled_evening
      sequence:
      - action: system_log.write
        data:
          message: 'Watchman: Starting scheduled report'
          level: info
      - action: watchman.report
        data:
          send_notification: true
          parse_config: true
        continue_on_error: true
      - action: system_log.write
        data:
          message: 'Watchman: Report completed'
          level: info
    - conditions:
      - condition: trigger
        id: sensor_change
      - condition: template
        value_template: '{{ states(''sensor.watchman_missing_entities'') not in [''unknown'', ''unavailable''] 
          and states(''sensor.watchman_missing_entities'') | int(0) > 0 }}'
      sequence:
      - condition: template
        value_template: " {% set last = state_attr('automation.watchman_monitor_combined',\
          \ 'last_triggered') %}\n    {{ last is none or (now() - last).total_seconds()\
          \ > 3600 }}"
      - action: notify.mobile_app_iphone_rafael
        data:
          title: ‚ö†Ô∏è Sensor Probleme erkannt
          message: '{{ states(''sensor.watchman_missing_entities'') | int(0) }} Entit√§ten sind
            nicht verf√ºgbar. Pr√ºfe den Watchman Bericht f√ºr Details.

            '
          data:
            tag: watchman_alert
            group: sensor_health
  mode: single
- id: '1754557053144'
  alias: Helper ¬ª Unbekannte Ger√§te reparieren
  description: Versucht Ger√§te mit 'unknown' Status zu reaktivieren
  triggers:
  - minutes: 0
    trigger: time_pattern
  - event: start
    trigger: homeassistant
  conditions: []
  actions:
  - variables:
      unknown_devices: "{{ states | selectattr('state', 'eq', 'unknown') \n   | rejectattr('domain',\
        \ 'in', ['automation', 'script', 'scene']) \n   | list }}\n"
      unknown_count: '{{ unknown_devices | length }}'
  - condition: template
    value_template: "{{ unknown_count | int > 0 }}"
  - action: system_log.write
    data:
      message: Found {{ unknown_count }} devices with unknown state - attempting recovery
      level: info
  - if:
    - condition: template
      value_template: '{{ unknown_devices | selectattr(''entity_id'', ''match'', ''.*_motion_.*|.*_kontaktsensor_.*'')
        | list | length > 0 }}

        '
    then:
    - action: system_log.write
      data:
        message: "ZHA permit mode activated for unknown motion/contact sensors (60s)"
        level: warning
    - action: zha.permit
      data:
        duration: 60
    - delay: 00:00:02
    - action: homeassistant.update_entity
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('entity_id', 'match', '.*_motion_.*|.*_kontaktsensor_.*')\
          \ \n   | map(attribute='entity_id') \n   | list }}\n"
  - if:
    - condition: template
      value_template: '{{ unknown_devices | selectattr(''entity_id'', ''match'', ''light\.alle_.*'')
        | list | length > 0 }}

        '
    then:
    - action: group.reload
    - delay: 00:00:02
    - action: light.turn_on
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('entity_id', 'match', 'light\\\
          .alle_.*') \n   | map(attribute='entity_id') \n   | list }}\n"
      data:
        brightness: 1
    - delay: 00:00:01
    - action: light.turn_off
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('entity_id', 'match', 'light\\\
          .alle_.*') \n   | map(attribute='entity_id') \n   | list }}\n"
  - if:
    - condition: template
      value_template: '{{ unknown_devices | selectattr(''domain'', ''eq'', ''cover'')
        | list | length > 0 }}

        '
    then:
    - action: cover.stop_cover
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('domain', 'eq', 'cover')\
          \ \n   | map(attribute='entity_id') \n   | list }}\n"
      continue_on_error: true
    - action: homeassistant.update_entity
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('domain', 'eq', 'cover')\
          \ \n   | map(attribute='entity_id') \n   | list }}\n"
  - if:
    - condition: state
      entity_id: sensor.luftfeuchtigkeit_aussen
      state: unknown
    - condition: template
      value_template: " {% set last = state_attr('automation.helper_fix_unknown_devices',\
        \ 'last_triggered') %}\n    {{ last is none or (now() - last).total_seconds()\
        \ > 3600 }}"
    then:
    - action: system_log.write
      data:
        message: Au√üensensor offline - pr√ºfe Batterie!
        level: warning
    - parallel:
        # TTS Ansage √ºber HomePods
        - action: script.hausgeraete_ansage
          data:
            message: "Der Au√üensensor ist offline. Bitte die Batterie pr√ºfen"
            priority: "normal"
          continue_on_error: true
        
        # Mobile Benachrichtigung
        - action: notify.mobile_app_iphone_rafael
          data:
            title: ‚ö†Ô∏è Au√üensensor offline
            message: Der Au√üensensor liefert keine Daten. Batterie pr√ºfen!
        
        # Persistent Notification als Backup
        - action: persistent_notification.create
          data:
            notification_id: "aussensensor_offline"
            title: "üå°Ô∏è Au√üensensor offline"
            message: "Der Au√üensensor liefert keine Daten. Batterie pr√ºfen!"
  mode: single
