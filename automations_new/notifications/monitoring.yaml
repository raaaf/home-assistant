# Notifications - Monitoring.Yaml
# Generated by automation splitter - 5 automations
# Part of Home Assistant configuration

- id: '1645110903677'
  alias: Notification » Es gibt nicht erreichbare Geräte
  description: Sendet werktags um 10 Uhr eine E-Mail bei nicht erreichbaren Geräten
  use_blueprint:
    path: gmlupatelli/unavailable_entities_notification.yaml
    input:
      time: '10:00:00'
      actions:
      - action: notify.rafael_mail
        data:
          title: Nicht erreichbare Geräte
          message: '{{entities}}'
      monday_enabled: true
      tuesday_enabled: true
      wednesday_enabled: true
      thursday_enabled: true
      friday_enabled: true
      saturday_enabled: false
      sunday_enabled: false
- id: '1665868733806'
  alias: Notification » Luftfeuchtigkeit 15:00
  description: Sendet tägliche Benachrichtigung bei Luftfeuchtigkeit über 60%
  use_blueprint:
    path: migsun/high-humidity-level-detection-notification-for-all-humidity-sensors.yaml
    input:
      threshold: 60
      time: '15:00:00'
      actions:
      - action: notify.family
        data:
          title: Luftfeuchtigkeit
          message: '{{sensors}}'
      exclude:
        entity_id:
        - sensor.temperatur_aussen_sonnenaufgang_humidity
        - sensor.temperatur_aussen_sonnenuntergang_humidity
- id: '1726065861905'
  alias: Notifications » Niedriger Batteriestand
  description: Benachrichtigt bei niedrigem Batteriestand (unter 10%) von Geräten
  use_blueprint:
    path: Blackshome/low-battery-notifications-and-actions.yaml
    input:
      include_time: time_enabled
      time: '10:00:00'
      include_persistent_notification: enable_persistent_notification
      battery_level: 10
- id: '1754557053144'
  alias: Helper » Unbekannte Geräte reparieren
  description: Versucht Geräte mit 'unknown' Status zu reaktivieren
  triggers:
  - minutes: 0
    trigger: time_pattern
  - event: start
    trigger: homeassistant
  conditions: []
  actions:
  - variables:
      unknown_devices: "{{ states | selectattr('state', 'eq', 'unknown') \n   | rejectattr('domain',\
        \ 'in', ['automation', 'script', 'scene']) \n   | list }}\n"
      unknown_count: '{{ unknown_devices | length }}'
  - condition: template
    value_template: "{{ unknown_count | int > 0 }}"
  - action: system_log.write
    data:
      message: Found {{ unknown_count }} devices with unknown state - attempting recovery
      level: info
  - if:
    - condition: template
      value_template: '{{ unknown_devices | selectattr(''entity_id'', ''match'', ''.*_motion_.*|.*_kontaktsensor_.*'')
        | list | length > 0 }}

        '
    then:
    - action: system_log.write
      data:
        message: "ZHA permit mode activated for unknown motion/contact sensors (60s)"
        level: warning
    - action: zha.permit
      data:
        duration: 60
    - delay: 00:00:02
    - action: homeassistant.update_entity
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('entity_id', 'match', '.*_motion_.*|.*_kontaktsensor_.*')\
          \ \n   | map(attribute='entity_id') \n   | list }}\n"
  - if:
    - condition: template
      value_template: '{{ unknown_devices | selectattr(''entity_id'', ''match'', ''light\.alle_.*'')
        | list | length > 0 }}

        '
    then:
    - action: group.reload
    - delay: 00:00:02
    - action: light.turn_on
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('entity_id', 'match', 'light\\\
          .alle_.*') \n   | map(attribute='entity_id') \n   | list }}\n"
      data:
        brightness: 1
    - delay: 00:00:01
    - action: light.turn_off
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('entity_id', 'match', 'light\\\
          .alle_.*') \n   | map(attribute='entity_id') \n   | list }}\n"
  - if:
    - condition: template
      value_template: '{{ unknown_devices | selectattr(''domain'', ''eq'', ''cover'')
        | list | length > 0 }}

        '
    then:
    - action: cover.stop_cover
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('domain', 'eq', 'cover')\
          \ \n   | map(attribute='entity_id') \n   | list }}\n"
      continue_on_error: true
    - action: homeassistant.update_entity
      target:
        entity_id: "{{ unknown_devices \n   | selectattr('domain', 'eq', 'cover')\
          \ \n   | map(attribute='entity_id') \n   | list }}\n"
  - if:
    - condition: state
      entity_id: sensor.luftfeuchtigkeit_aussen
      state: unknown
    - condition: template
      value_template: "{{ (now() - states.sensor.luftfeuchtigkeit_aussen.last_changed).total_seconds() > 300 }}"
    - condition: template
      value_template: " {% set last = state_attr('automation.helper_fix_unknown_devices',\
        \ 'last_triggered') %}\n    {{ last is none or (now() - last).total_seconds()\
        \ > 3600 }}"
    then:
    - action: system_log.write
      data:
        message: Außensensor offline - prüfe Batterie!
        level: warning
    - action: notify.rafael_mail
      data:
        title: "Außensensor offline"
        message: |
          Außensensor offline

          Problem: Der Außensensor liefert keine Daten.

          Bitte überprüfe die Batterie des Sensors und stelle sicher, dass er ordnungsgemäß funktioniert.

          Diese Nachricht wurde automatisch generiert.
  mode: single
- id: '1725893400001'
  alias: Security » Haustür Überwachung
  description: Überwacht Haustür bei Abwesenheit und trackt Besuchsdauer
  triggers:
    - entity_id: binary_sensor.haustur_kontaktsensor_contact
      from: 'off'
      to: 'on'
      id: door_opened
      trigger: state
    - entity_id: binary_sensor.haustur_kontaktsensor_contact
      from: 'on'
      to: 'off'
      id: door_closed
      trigger: state
  conditions: []
  actions:
    - variables:
        beide_weg: "{{ has_value('input_boolean.alle_sind_weg') and is_state('input_boolean.alle_sind_weg', 'on') }}"
        besucher_inside: "{{ has_value('input_boolean.haustur_besucher_inside') and is_state('input_boolean.haustur_besucher_inside', 'on') }}"
        aktueller_zeitstempel: "{{ now() }}"
        formatierte_zeit: "{{ now().strftime('%A, %H:%M Uhr, %d.%m.%Y') }}"
    - choose:
        - alias: "Tür öffnet sich - beide sind weg"
          conditions:
            - condition: trigger
              id: door_opened
            - condition: template
              value_template: "{{ beide_weg }}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ not besucher_inside }}"
              then:
                - action: input_boolean.turn_on
                  target:
                    entity_id: input_boolean.haustur_besucher_inside
                - action: input_datetime.set_datetime
                  target:
                    entity_id: input_datetime.haustur_eingang_zeit
                  data:
                    datetime: "{{ aktueller_zeitstempel }}"
                - action: input_datetime.set_datetime
                  target:
                    entity_id: input_datetime.haustur_letzter_eingang
                  data:
                    datetime: "{{ aktueller_zeitstempel }}"
                - action: notify.family
                  data:
                    title: "SICHERHEITSALARM - Haustür geöffnet"
                    message: >
                      Die Haustür wurde um {{ formatierte_zeit }} geöffnet,
                      obwohl niemand zuhause ist!
                    data:
                      tag: door_security
                      group: security_alerts
                      push:
                        interruption-level: critical
                - action: system_log.write
                  data:
                    message: >
                      SECURITY: Haustür geöffnet bei Abwesenheit um {{ aktueller_zeitstempel }}
                    level: warning
        - alias: "Tür schließt sich - Besucher verlässt Haus"
          conditions:
            - condition: trigger
              id: door_closed
            - condition: template
              value_template: "{{ beide_weg and besucher_inside }}"
          sequence:
            - variables:
                eingang_zeit: "{{ states('input_datetime.haustur_eingang_zeit') }}"
                besuchsdauer_sekunden: >
                  {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.haustur_eingang_zeit'))) | int }}
                besuchsdauer_minuten: "{{ (besuchsdauer_sekunden / 60) | round(1) }}"
                besuchsdauer_stunden: "{{ (besuchsdauer_sekunden / 3600) | round(1) }}"
                formatierte_dauer: >
                  {% if besuchsdauer_sekunden < 60 %}
                    {{ besuchsdauer_sekunden }} Sekunden
                  {% elif besuchsdauer_sekunden < 3600 %}
                    {{ besuchsdauer_minuten }} Minuten
                  {% else %}
                    {{ besuchsdauer_stunden }} Stunden
                  {% endif %}
            - action: input_boolean.turn_off
              target:
                entity_id: input_boolean.haustur_besucher_inside
            - action: input_text.set_value
              target:
                entity_id: input_text.haustur_besucher_dauer
              data:
                value: "{{ formatierte_dauer }}"
            - action: system_log.write
              data:
                message: >
                  SECURITY: Besucher hat Haus verlassen. Dauer: {{ formatierte_dauer }}
                level: info
        - alias: "Tür öffnet sich - jemand kommt nach Hause"
          conditions:
            - condition: trigger
              id: door_opened
            - condition: template
              value_template: "{{ not beide_weg }}"
          sequence:
            - action: input_datetime.set_datetime
              target:
                entity_id: input_datetime.haustur_letzter_eingang
              data:
                datetime: "{{ aktueller_zeitstempel }}"
            - action: system_log.write
              data:
                message: "INFO: Haustür geöffnet - jemand ist zuhause"
                level: info
  mode: restart
- id: '1754557053145'
  alias: Notification » Bewegungsmelder ausgefallen
  description: Benachrichtigt wenn kritische Bewegungsmelder länger als 30 Minuten nicht verfügbar sind
  triggers:
  - entity_id:
    - binary_sensor.schlafzimmer_motion_occupancy
    - binary_sensor.balkon_motion_occupancy
    - binary_sensor.kuche_motion_occupancy
    - binary_sensor.haustur_motion_occupancy
    - binary_sensor.waschzimmer_motion_occupancy
    - binary_sensor.kinderzimmer_motion_occupancy
    - binary_sensor.arbeitszimmer_motion_occupancy
    to:
    - unavailable
    - unknown
    for:
      minutes: 30
    trigger: state
  conditions: []
  actions:
  - variables:
      sensor_name: '{{ trigger.to_state.name }}'
      sensor_id: '{{ trigger.entity_id }}'
      duration: '{{ relative_time(trigger.from_state.last_changed) }}'
  - parallel:
    - action: notify.family
      data:
        title: "WARNUNG - Bewegungsmelder ausgefallen"
        message: "{{ sensor_name }} ist seit {{ duration }} nicht verfügbar ({{ sensor_id }})"
        data:
          tag: motion_sensor_failure
          group: system_alerts
          push:
            interruption-level: critical
    - action: notify.rafael_mail
      data:
        title: "Bewegungsmelder ausgefallen"
        message: |
          Bewegungsmelder ausgefallen

          Sensor: {{ sensor_name }}
          Entity ID: {{ sensor_id }}
          Status: {{ trigger.to_state.state }}
          Ausgefallen seit: {{ duration }}

          Bitte überprüfe:
          - Batterie des Sensors
          - Zigbee-Verbindung
          - Sensor-Position

          Diese Nachricht wurde automatisch generiert.
  - action: logbook.log
    data:
      name: Bewegungsmelder ausgefallen
      message: '{{ sensor_name }} ({{ sensor_id }}) ist seit {{ duration }} nicht verfügbar'
      domain: automation
  mode: queued
  max: 10
