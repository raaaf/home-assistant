# Notifications - Environment.Yaml
# Generated by automation splitter - 2 automations
# Part of Home Assistant configuration

- id: '1697018634962'
  alias: Notifications Â» Heizung > 4 Stunden
  description: Benachrichtigt wenn Heizungen lÃ¤nger als 4 Stunden aktiv sind
  triggers:
  - entity_id: sensor.heizung_arbeitszimmer_an
    above: 4
    trigger: numeric_state
  - entity_id: sensor.heizung_kinderzimmer_an
    above: 4
    trigger: numeric_state
  - entity_id: sensor.heizung_badezimmer_an
    above: 4
    trigger: numeric_state
  - entity_id: sensor.heizung_flur_an
    above: 4
    trigger: numeric_state
  - entity_id: sensor.heizung_wohnzimmer_an
    above: 4
    trigger: numeric_state
  conditions:
  - condition: template
    value_template: >
      {% set last = state_attr('automation.notifications_heizung_4_stunden', 'last_triggered') %}
      {{ last is none or (now() - last).total_seconds() > 12 * 60 * 60 }}
  actions:
  - variables:
      room_name_raw: "{{ trigger.entity_id | regex_replace('^sensor.heizung_', '') | regex_replace('_an$', '') }}"
      room_name_display: "{{ room_name_raw | replace('_', ' ') | title }}"
      heating_hours: "{{ trigger.to_state.state }}"
  - parallel:
      # TTS Ansage Ã¼ber HomePods
      - action: script.hausgeraete_ansage
        data:
          message: >-
            Die Heizung im {{ room_name_display }}
            lÃ¤uft seit Ã¼ber 4 Stunden
          priority: "normal"
        continue_on_error: true
      
      # Mobile Benachrichtigung
      - action: notify.rafael
        data:
          title: 'Heizung: {{ room_name_display }}'
          message: 'Seit mehr als 4 Stunden aktiv (aktuell {{ heating_hours }} h).'
          data:
            push:
              interruption-level: critical
        continue_on_error: true
      
      # Persistent Notification als Backup
      - action: persistent_notification.create
        data:
          notification_id: "heizung_warnung_{{ room_name_raw }}"
          title: "ğŸ”¥ Heizung lÃ¤uft zu lange"
          message: "{{ room_name_display }} seit {{ heating_hours }} Stunden aktiv"
        continue_on_error: true
  mode: single
- id: '1738322846270'
  alias: Notification Â» Stromverbrauch gestern
  description: 'Erstellt eine persistente Benachrichtigung mit dem Stromverbrauch,
    der Solarproduktion, AC-Verbrauch und den Kosten des Vortages

    '
  triggers:
  - at: 00:05:00
    trigger: time
  conditions:
  - condition: template
    value_template: "{{ state_attr('sensor.taglicher_netzbezug','last_period')\
      \ is not none\n   and states('sensor.solarproduktion_gestern') not in\
      \ ['unknown', 'unavailable']\n   and states('sensor.butzabatza_electricity_price') not in\
      \ ['unknown', 'unavailable']\n   and state_attr('sensor.ac_current_energy','last_period')\
      \ is not none }}\n"
  actions:
  - variables:
      verbrauch_netto: '{{ state_attr(''sensor.taglicher_netzbezug'',''last_period'')
        | float(0) | round(2) }}

        '
      solarproduktion_gestern: '{{ states(''sensor.solarproduktion_gestern'')
        | float(0) }}

        '
      verbrauch_brutto: '{{ (verbrauch_netto + solarproduktion_gestern) | round(2)
        }}

        '
      strompreis: '{{ states(''sensor.butzabatza_electricity_price'') | float(0.30)
        }}

        '
      kosten_ohne_solar: '{{ (verbrauch_brutto * strompreis) | round(2) }}

        '
      ersparnis_gestern: '{{ (solarproduktion_gestern * strompreis) | round(2) }}

        '
      kosten_nach_solar: '{{ (verbrauch_netto * strompreis) | round(2) }}

        '
      durchschnitt_pro_stunde: '{{ (verbrauch_netto / 24) | round(2) }}

        '
      datum_gestern: '{{ (now() - timedelta(days=1)).strftime(''%d.%m.%Y'') }}

        '
      ac_verbrauch_gestern: '{{ state_attr(''sensor.ac_current_energy'',''last_period'')
        | float(0) | round(2) }}

        '
      ac_kosten_gestern: '{{ (state_attr(''sensor.ac_current_energy'',''last_period'')
        | float(0) * strompreis) | round(2) }}

        '
      ac_anteil_prozent: >-
        {% set brutto = verbrauch_brutto | float(0) %}
        {% set ac_usage = ac_verbrauch_gestern | float(0) %}
        {% if brutto > 0 and ac_usage >= 0 %}
          {{ ((ac_usage / brutto) * 100) | round(1) }}
        {% else %}
          0
        {% endif %}
      ac_laufzeit_stunden: >-
        {% set avg_power = states('sensor.ac_power') | float(0) %}
        {% set ac_usage = ac_verbrauch_gestern | float(0) %}
        {% if avg_power > 50 and ac_usage > 0 %}
          {{ (ac_usage * 1000 / avg_power) | round(1) }}
        {% elif ac_usage > 0.1 %}
          {{ (ac_usage * 1000 / 800) | round(1) }}
        {% else %}
          0
        {% endif %}
  - data:
      title: âš¡ Stromverbrauch {{ datum_gestern }}
      message: '**ğŸ“Š Verbrauch:** ğŸ”Œ Gesamt (Brutto): {{ verbrauch_brutto }} kWh ğŸ”Œ Netzbezug
        (Netto): {{ verbrauch_netto }} kWh â³ Ã˜ pro Stunde: {{ durchschnitt_pro_stunde
        }} kWh

        **â„ï¸ Klimaanlage:** Verbrauch: {{ ac_verbrauch_gestern }} kWh ({{ ac_anteil_prozent
        }}% vom Gesamtverbrauch) Kosten: {{ ac_kosten_gestern }} â‚¬ GeschÃ¤tzte Laufzeit:
        {{ ac_laufzeit_stunden }} Stunden

        **â˜€ï¸ Solar:** Produktion: {{ solarproduktion_gestern }} kWh Selbstnutzung:
        100% angenommen

        **ğŸ’° Kosten:** ({{ strompreis }} â‚¬/kWh) Ohne Solar: {{ kosten_ohne_solar }}
        â‚¬ Ersparnis: âˆ’{{ ersparnis_gestern }} â‚¬ â” TatsÃ¤chlich: {{ kosten_nach_solar
        }} â‚¬

        **ğŸ“ˆ Effizienz:** Autarkiegrad: {{ ((solarproduktion_gestern / verbrauch_brutto
        * 100) | round(0)) }}%

        '
    action: persistent_notification.create
  - data:
      message: 'Tagesstatistik {{ datum_gestern }}:   Verbrauch {{ verbrauch_brutto
        }} kWh (Netto: {{ verbrauch_netto }} kWh),   AC-Verbrauch {{ ac_verbrauch_gestern
        }} kWh ({{ ac_anteil_prozent }}%), Solar {{ solarproduktion_gestern }} kWh,   Kosten
        {{ kosten_nach_solar }} â‚¬ (Ersparnis: {{ ersparnis_gestern }} â‚¬),   Autarkiegrad
        {{ ((solarproduktion_gestern / verbrauch_brutto * 100) | round(0)) }}%

        '
      name: Stromstatistik
      domain: sensor
    action: logbook.log
  mode: single
